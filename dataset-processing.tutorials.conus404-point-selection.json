{"version":3,"kind":"Notebook","sha256":"fd5cf3c613b6b6eedc4662618eada8d3a18aeb1fd5d0f686ceb15610cc02a4ad","slug":"dataset-processing.tutorials.conus404-point-selection","location":"/dataset_processing/tutorials/conus404_point_selection.ipynb","dependencies":[],"frontmatter":{"title":"CONUS404 Site Data Selection","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":1}},"source_url":"https://github.com/hytest-org/hytest/blob/main/dataset_processing/tutorials/conus404_point_selection.ipynb","edit_url":"https://github.com/hytest-org/hytest/edit/main/dataset_processing/tutorials/conus404_point_selection.ipynb","exports":[{"format":"ipynb","filename":"conus404_point_selection.ipynb","url":"/hytest//build/conus404_point_selec-532fca78bec510942f5e53d6d1559ea0.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Pull CONUS404 data at a set of lat/lon point locations.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"hIXuNP7ANY"}],"key":"eIsHEZinj3"}],"key":"RxefmC9IYg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import fsspec\nimport xarray as xr\nimport hvplot.xarray\nimport intake\nimport pystac\nfrom packaging.version import Version\nimport zarr\nimport os\nimport cartopy.crs as ccrs\nimport metpy\nimport warnings\nimport pandas as pd\nimport s3fs\nimport xoak\nimport dask\nimport hvplot.pandas # to add .hvplot to DataFrames\nfrom dask.distributed import LocalCluster, Client\nwarnings.filterwarnings('ignore')","key":"UgvgaElYfJ"},{"type":"outputs","id":"SDgap6JWe5mGQyi7HuPCy","children":[],"key":"T0bwKqqltc"}],"key":"BRxKvmSqNu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Open dataset from WMA STAC Catalog","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"o6vMeob4UM"}],"identifier":"open-dataset-from-wma-stac-catalog","label":"Open dataset from WMA STAC Catalog","html_id":"open-dataset-from-wma-stac-catalog","implicit":true,"key":"yXa1IwZquN"}],"key":"uydG8oWwqb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_children(catalog, collection_id=None):\n    \"\"\"\n    This function retrieves a specified collection from a STAC catalog/collection and prints key metadata \n    for exploring/accessing the datasets contained within it.\n    If there is no collection ID provided, the collections in the top level of the catalog will be printed.\n    If a collection ID is provided, it will retrieve the collection with that ID from the input catalog/collection.\n    If the collection ID points to a dataset, it will print the assets available for the dataset.\n    If the collection ID points to another collection, it will list the child collections in the IDed collection.\n\n    Args:\n        catalog (pystac.Catalog | pystac.Collection): The STAC catalog/collection object.\n        collection_id (str): The ID of the collection or dataset to retrieve from catalog.\n    \n    Returns:\n        collection (pystac.Catalog | pystac.Collection): The collection object corresponding to the provided ID\n                                                         or the top-level catalog if no ID is provided.\n    \"\"\"\n    dataset = False\n    if collection_id:\n        collection = catalog.get_child(collection_id)\n        if collection.assets:\n            dataset = True\n            print(f\"{collection_id} is a dataset. Please review the assets below and select one to open.\")\n\n        else:\n            print(f\"{collection_id} is a collection. Please review the child items and select one to open in the next cell.\")\n    else:\n        collection = catalog\n    if dataset==True:\n        # List the assets\n        for asset in collection.assets:\n            print(f\"Asset ID: {asset}\")\n            print(f\"    Title: {collection.assets[asset].title}\")\n            print(f\"    Description: {collection.assets[asset].description}\")\n    else:\n        collections = list(collection.get_collections())\n        print(f\"Number of collections: {len(collections)}\")\n        print(\"Collections IDs:\")\n        for child_collection in collections:\n            id = child_collection.id\n            cite_as = \"Not available\"\n            for link in child_collection.links:\n                if link.rel == \"cite-as\":\n                    cite_as = link.target\n            print(f\"- {id}, Source: {cite_as}\")\n    return collection","key":"SWTXbPjsSE"},{"type":"outputs","id":"eSAXc1Uo-RXUBgd5oRQZv","children":[],"key":"Ib570eyG7n"}],"key":"ZWLmNSj1iU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# url for the WMA STAC Catalog\ncatalog_url = \"https://api.water.usgs.gov/gdp/pygeoapi/stac/stac-collection/\"\n\n# use pystac to read the catalog\ncatalog = pystac.Catalog.from_file(catalog_url)\n\n# list the collections in the catalog\ncatalog = get_children(catalog)","key":"YILH2x6X49"},{"type":"outputs","id":"yis3BH-M63-AFTDEZf6sv","children":[],"key":"YKp48ZqI5j"}],"key":"E2caaSZM7P"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(catalog, collection_id=\"conus404\")","key":"GR5cE3cBkS"},{"type":"outputs","id":"7TPYtP2vUQ_XHiXSd3Eua","children":[],"key":"cLdQSnGej7"}],"key":"gQvFUxOua5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(collection, collection_id=\"conus404_xtrm_daily\")","key":"WRmRlcy2pO"},{"type":"outputs","id":"FHenhwnbvej19g5YiE7OD","children":[],"key":"ym0N03kahY"}],"key":"JIiR0G3tRz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# replace with the asset ID you want to use:\nselected_asset_id = \"zarr-s3-osn\"\n\n# read the asset metadata\nasset = collection.assets[selected_asset_id]","key":"wQpsC14d6W"},{"type":"outputs","id":"sd2ZHb7yJPwgZ3cp-QgBi","children":[],"key":"NqRJFAw0eM"}],"key":"MTcLa9tsXT"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Parallelize with Dask","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g6x6550C9x"}],"identifier":"parallelize-with-dask","label":"Parallelize with Dask","html_id":"parallelize-with-dask","implicit":true,"key":"DnWqaSA596"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Some of the steps we will take are aware of parallel clustered compute environments\nusing ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Xohmn2gzrk"},{"type":"inlineCode","value":"dask","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"q5wjZ4FJCB"},{"type":"text","value":". Weâ€™re going to start a cluster now so that future steps can take advantage\nof this ability.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"iAngZT556l"}],"key":"XMsi5GVX9r"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"This is an optional step, but speed ups data loading significantly, especially\nwhen accessing data from the cloud.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"XEZOBEA9wK"}],"key":"iiINY2ujr3"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"We have documentation on how to start a Dask Cluster in different computing environments ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"L6wKY5oZlz"},{"type":"link","url":"/environment-set-up/clusters","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"FG4y6PMO8p"}],"urlSource":"../../environment_set_up/clusters.md","dataUrl":"/environment-set-up.clusters.json","internal":true,"protocol":"file","key":"XAUzPL3zg9"},{"type":"text","value":".","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"hEQr9UPPk9"}],"key":"rXpgIGFin3"}],"key":"JS8FJ1uHIb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%run ../../environment_set_up/Start_Dask_Cluster_Nebari.ipynb\n## If this notebook is not being run on Nebari, replace the above \n## path name with a helper appropriate to your compute environment.  Examples:\n# %run ../../environment_set_up/Start_Dask_Cluster_Denali.ipynb\n# %run ../../environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb\n# %run ../../environment_set_up/Start_Dask_Cluster_Desktop.ipynb","key":"epeJaIB5mK"},{"type":"outputs","id":"VnEqkXlehbUvQ3gTXa3DB","children":[],"key":"CW9fqV6wwU"}],"key":"DLiUZvVD3k"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Explore the dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C6IqXa30tF"}],"identifier":"explore-the-dataset","label":"Explore the dataset","html_id":"explore-the-dataset","implicit":true,"key":"EUMFug8gNP"}],"key":"gjgfnHA3bG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if Version(zarr.__version__) < Version(\"3.0.0\"):\n    ds = xr.open_dataset(\n        asset.href,\n        storage_options=asset.extra_fields['xarray:storage_options'],\n        **asset.extra_fields['xarray:open_kwargs']\n    )\nelse:\n    ds = xr.open_dataset(\n    asset.href,\n    storage_options=asset.extra_fields['xarray:storage_options'],\n    **asset.extra_fields['xarray:open_kwargs'],\n    zarr_format=2\n    )","key":"BoQ0QACacc"},{"type":"outputs","id":"1A25jsmvY-70_UI0e5npT","children":[],"key":"tno8AoFU3S"}],"key":"eoGC86qNKw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds","key":"SnW2G6JhIy"},{"type":"outputs","id":"y1dsie4le8Z_tAnXi5Nu7","children":[],"key":"KihWVnXP7h"}],"key":"xHmjxekBli"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# variables of interest\nvar = ['SKINTEMPMEAN', 'SKINTEMPMAX', 'SKINTEMPMIN', 'SKINTEMPSTD', 'TSKINTEMPMAX', 'TSKINTEMPMIN']","key":"t6K4dnuPuN"},{"type":"outputs","id":"zNoeLzaRRhImew2Id258C","children":[],"key":"JdkUm7gmIP"}],"key":"w1LqfPGG2h"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_var = ds[var]","key":"hTUhcxNCtS"},{"type":"outputs","id":"I4AosGq_oWcAC0vxOG_Mv","children":[],"key":"YNoEMhVtsm"}],"key":"L0BJFYu6lA"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read in point data and clean","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OgMCNr5ekj"}],"identifier":"read-in-point-data-and-clean","label":"Read in point data and clean","html_id":"read-in-point-data-and-clean","implicit":true,"key":"PNwyJcvaCy"}],"key":"VC3B7nMLyW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hytest_cat = intake.open_catalog(\"https://raw.githubusercontent.com/hytest-org/hytest/main/dataset_catalog/hytest_intake_catalog.yml\")\npoints_df = hytest_cat['pointsample-tutorial-sites-osn'].read()\nprint(len(points_df))\npoints_df.head()","key":"ucJBSVEfsm"},{"type":"outputs","id":"UurT6g3ymbyTOWSTUujzL","children":[],"key":"SENNygS9q2"}],"key":"dGNpz217V7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Drop rows will null lat, lon","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KxBIeCbBjF"}],"identifier":"drop-rows-will-null-lat-lon","label":"Drop rows will null lat, lon","html_id":"drop-rows-will-null-lat-lon","implicit":true,"key":"It5T7gQ2v2"}],"key":"JaPkKWyjCA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"points_df[points_df.isnull().any(axis=1)]","key":"VxmLQ9gRXt"},{"type":"outputs","id":"vvIqv2NISoaYdvd7Ex_p1","children":[],"key":"X1mTWROLCv"}],"key":"FajYAyV2gl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# drop rows will null lat, lon\npoints_df.dropna(subset = ['longitude', 'latitude'], inplace=True)\nprint(len(points_df))","key":"lM85nETEfj"},{"type":"outputs","id":"8Xg0IWcGaEkBT7N8ojosn","children":[],"key":"csgJhHeKhp"}],"key":"o56Kn1UPWC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Set site_id as index","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R1roiqMTIe"}],"identifier":"set-site-id-as-index","label":"Set site_id as index","html_id":"set-site-id-as-index","implicit":true,"key":"ETygzSU1WH"}],"key":"AWIIvdftCL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#points_df = points_df.set_index(['site_id', 'longitude', 'latitude'])\npoints_df = points_df.set_index(['site_id'])\nprint(len(points_df))","key":"NiL25ap3SB"},{"type":"outputs","id":"74syp3F8i1hhDcRnQ-dNe","children":[],"key":"ZH9bTwemRU"}],"key":"pZQBNmaSDD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"points_df.head()","key":"TJfLXZ0K6C"},{"type":"outputs","id":"bNtMDd_xrNMC44a2_0osu","children":[],"key":"Xl0YbNK3bF"}],"key":"nHIEfsbk0q"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Make sure no site ids are duplicated","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NrKNHyzXT9"}],"identifier":"make-sure-no-site-ids-are-duplicated","label":"Make sure no site ids are duplicated","html_id":"make-sure-no-site-ids-are-duplicated","implicit":true,"key":"DAaoycPize"}],"key":"JaE8SmXMX2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"points_df[points_df.index.duplicated()]","key":"dAmgMtnxJg"},{"type":"outputs","id":"VoJVuHsSCJNbJU8o0IbVS","children":[],"key":"KQ0mDbzwx0"}],"key":"gnRd4hZYFM"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Transform into xarray dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YZnry4RTxp"}],"identifier":"transform-into-xarray-dataset","label":"Transform into xarray dataset","html_id":"transform-into-xarray-dataset","implicit":true,"key":"dWiYlKEOal"}],"key":"kxj56cfqbR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"points_ds = xr.Dataset.from_dataframe(points_df)","key":"VYUUCq774r"},{"type":"outputs","id":"1SIpKOYJ00UT0LBMajU6i","children":[],"key":"q4KA8QI6eF"}],"key":"YMh2AUhbCf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"points_ds","key":"ksPQQVxb2F"},{"type":"outputs","id":"vuWLIFg3VwSs0i6qrAoep","children":[],"key":"kDxZV1zIw9"}],"key":"uDVNPFSOcg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Find data values at point locations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oKJ4z45aDs"}],"identifier":"find-data-values-at-point-locations","label":"Find data values at point locations","html_id":"find-data-values-at-point-locations","implicit":true,"key":"g3FMawCYhQ"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"First we will use ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"VyfWeuhEyY"},{"type":"inlineCode","value":"xoak.set_index","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"bgd4bN51lB"},{"type":"text","value":" (","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"MATwTzkU9b"},{"type":"link","url":"https://xoak.readthedocs.io/en/latest/_api_generated/xarray.DataArray.xoak.set_index.html","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"docs","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"XFHIsvGInm"}],"urlSource":"https://xoak.readthedocs.io/en/latest/_api_generated/xarray.DataArray.xoak.set_index.html","key":"wY5wzj9U9R"},{"type":"text","value":" to set up an index tree that will enable efficient indexing for the lat and lon coordinates in the CONUS404 data subset. We will choose the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"peAQyeo1sS"},{"type":"inlineCode","value":"sklearn_geo_balltree","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"C6zBp1NGMe"},{"type":"text","value":" method for indexing, which uses the Haversine distance metric and is a good choice for indexing latitude / longitude points.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"MRZW5qJeeI"}],"key":"PT5atEcVj2"}],"key":"I1uoyTH9qE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_var.xoak.set_index(['lat', 'lon'], 'sklearn_geo_balltree')","key":"upJNUeuvI2"},{"type":"outputs","id":"vbE9DRBY6iXgeZKpu4n2H","children":[],"key":"xjPlZ83kTG"}],"key":"b4NOp64kTl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_var.xoak.index","key":"q6x6tFVayg"},{"type":"outputs","id":"icdJMAlwaKC2Aq7wAS9yj","children":[],"key":"U2hbQeMgyQ"}],"key":"c16MJqt478"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#from dask.diagnostics import ProgressBar\n#with ProgressBar(), dask.config.set(scheduler='processes'):\nds_selection = ds_var.xoak.sel(lat=points_ds.latitude, lon=points_ds.longitude)","key":"j79dzENq0w"},{"type":"outputs","id":"KcgBuMCoaDAewUbFwNO69","children":[],"key":"muWG3zXIpw"}],"key":"LD0BY4yiYF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_selection","key":"xNCdHLlGQn"},{"type":"outputs","id":"qsvqNwzp8iuk54PJZkuqC","children":[],"key":"Zduar9fQ3R"}],"key":"ShrlAbdPNn"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Join selected data back to gage data with site ID, source, lat, lon","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WFrydt6xv3"}],"identifier":"join-selected-data-back-to-gage-data-with-site-id-source-lat-lon","label":"Join selected data back to gage data with site ID, source, lat, lon","html_id":"join-selected-data-back-to-gage-data-with-site-id-source-lat-lon","implicit":true,"key":"PO3uvMOB2a"}],"key":"GglV6aB3St"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_selection = xr.merge([points_ds, ds_selection])","key":"hQl0NDrttc"},{"type":"outputs","id":"iV8IMfyLhoS7QIkXEuQDh","children":[],"key":"CTmjkTeGpZ"}],"key":"WPKAnmdMAl"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Visualize data to verify results","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R3GLJxozQT"}],"identifier":"visualize-data-to-verify-results","label":"Visualize data to verify results","html_id":"visualize-data-to-verify-results","implicit":true,"key":"zaAfFsDibF"}],"key":"HhPLTkqZTV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"idx = 300","key":"Lb5pqQH1NE"},{"type":"outputs","id":"sCdPHgpCxG2IF1CCuv8RE","children":[],"key":"aT17VLwdgM"}],"key":"Yku8nGYPfH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"da = ds_selection.isel(time=idx).load()\ndf = da.to_dataframe()","key":"VpPvb22zjA"},{"type":"outputs","id":"1Mi4IaFhPAH_7kgS9E0F2","children":[],"key":"R4O6lPQyMZ"}],"key":"OieQUx9e5y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"df.hvplot.scatter(x='lon', y='lat', c=var[0], colormap='viridis').opts(clim=(260, 300))","key":"OjA35QYmgg"},{"type":"outputs","id":"hqwCMzwxR53kx1zMOnY39","children":[],"key":"X4f5Zu4Sjt"}],"key":"YeWxev8dM7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"da_grid = ds_var[var[0]].isel(time=idx).load()\nda_grid.hvplot.quadmesh(x='lon', y='lat', rasterize=True, geo=True, tiles='OSM', cmap='viridis').opts('Image', clim=(260, 300))","key":"ZmgEcM1cn2"},{"type":"outputs","id":"NlYcnRMUgqDLpyBTOGUvW","children":[],"key":"Uwjx7Emhxz"}],"key":"y3Q2ajykgn"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Clean up data for saving","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"P9IlxgYgt1"}],"identifier":"clean-up-data-for-saving","label":"Clean up data for saving","html_id":"clean-up-data-for-saving","implicit":true,"key":"SAyAdbPnpa"}],"key":"iHwy4MAlvE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# drop CONUS404 grid cell lat/lon, x/y values that data were pulled from, keeping only site's lat/lon to reduce confusion\nds_save = ds_selection.drop_vars([\"lat\", \"lon\", \"x\", \"y\"])","key":"oTPbvFWLGe"},{"type":"outputs","id":"UqRsThcslhMYsdyVa2mfU","children":[],"key":"KtYzu7oBgt"}],"key":"byhW369RBs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_save","key":"W89bIPQzMF"},{"type":"outputs","id":"Ic1__9zy3bUrXP5JEJOnk","children":[],"key":"S9CdjYtWH1"}],"key":"R6oigrCc94"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Save netcdf to OSN pod","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KD0b24CsoA"}],"identifier":"save-netcdf-to-osn-pod","label":"Save netcdf to OSN pod","html_id":"save-netcdf-to-osn-pod","implicit":true,"key":"cK0e6t4lMM"}],"key":"rTGjIBcka7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fs_write = fsspec.filesystem(\n    's3',\n    profile='osn-hytest',  ## This is the name of the AWS profile with credentials to write to the output bucket\n    client_kwargs={'endpoint_url': 'https://usgs.osn.mghpcc.org/'}\n)","key":"ALO0Gzdgal"},{"type":"outputs","id":"2pI-FhOueYURPkFSrEeka","children":[],"key":"vUZLpSxhki"}],"key":"LfLzUJqGfl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fs_write.ls('hytest')\n# get intake catalog entry url (intake catalog entry has already been created) to use to write the file\noutfile = hytest_cat['pointsample-tutorial-output-osn']._entry._yaml()['sources']['pointsample-tutorial-output-osn']['args']['urlpath']\nlocal_file = outfile.split('/')[-1]","key":"tV7F6f0HcR"},{"type":"outputs","id":"NgTSPMcABy100yDsHFcxH","children":[],"key":"a99BzhwZKC"}],"key":"efugZDX2Jf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Uncomment next two cells to save","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iYeWHCSk9t"}],"key":"yOPPWJDUVp"}],"key":"YENCZ7QTNL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# %%time\n# ds_save.to_netcdf(local_file)","key":"R0Rik6OeLS"},{"type":"outputs","id":"ApoqGR_8V4dwMn_HVAQvn","children":[],"key":"jr7aMJdxjq"}],"key":"tY4UUUCG5g"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# %%time\n# fs_write.upload(local_file, outfile)","key":"VP8WoCdKh0"},{"type":"outputs","id":"ObUGt48gnrUDl_XTFw5GA","children":[],"key":"CC7xqmFdIz"}],"key":"YYhoYvhnAr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# check that file has been written\nfs_write.ls(outfile.split(local_file)[0])","key":"zpos9IXkuA"},{"type":"outputs","id":"Fur620O8hcRanWNP1VTjB","children":[],"key":"LlyDraKLin"}],"key":"K4UDcqtIPd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f'netcdf file size is {fs_write.size(outfile) / 1048576} MB')","key":"B4hPXtJ2Y0"},{"type":"outputs","id":"kGyxuFkcD4gMWZaMQ4JmB","children":[],"key":"Fzq5Xje9XV"}],"key":"LJV255sWx8"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read back in the nc data to verify it saved correctly","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NjVypvXKgu"}],"identifier":"read-back-in-the-nc-data-to-verify-it-saved-correctly","label":"Read back in the nc data to verify it saved correctly","html_id":"read-back-in-the-nc-data-to-verify-it-saved-correctly","implicit":true,"key":"VpGqZthWQ5"}],"key":"LD3BtWgPpS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"with fs_write.open(outfile) as f:\n    ds_final = xr.open_dataset(f)","key":"gyzm5iaTQn"},{"type":"outputs","id":"JW-mtjbQObp1DXuSGnU0Y","children":[],"key":"t1Fa1jS0Wa"}],"key":"unbNrU5Q4d"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_final","key":"d00Yl27Cov"},{"type":"outputs","id":"HK79sBzyB_0LFDBBHLgFD","children":[],"key":"lU07zxeahd"}],"key":"bYZtQG4wit"}],"key":"kqKJRdlU10"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation","url":"/dataset-processing/tutorials/spatial-aggregation/conus404-spatial-aggregation-comparison","group":"Dataset Processing"},"next":{"title":"CONUS404 Regridding (Curvilinear => Rectilinear)","url":"/dataset-processing/tutorials/conus404-regrid","group":"Dataset Processing"}}},"domain":"http://localhost:3005"}