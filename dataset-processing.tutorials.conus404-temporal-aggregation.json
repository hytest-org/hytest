{"version":3,"kind":"Notebook","sha256":"08936fbed79816a3a15680c2e4fbdaecc72d4624add5d7634d928b21666d89e9","slug":"dataset-processing.tutorials.conus404-temporal-aggregation","location":"/dataset_processing/tutorials/conus404_temporal_aggregation.ipynb","dependencies":[],"frontmatter":{"title":"CONUS404 Temporal Aggregation","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":1}},"source_url":"https://github.com/hytest-org/hytest/blob/main/dataset_processing/tutorials/conus404_temporal_aggregation.ipynb","edit_url":"https://github.com/hytest-org/hytest/edit/main/dataset_processing/tutorials/conus404_temporal_aggregation.ipynb","exports":[{"format":"ipynb","filename":"conus404_temporal_aggregation.ipynb","url":"/hytest//build/conus404_temporal_ag-812b982760f5b59f721d81b3762618fb.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Create daily averages from hourly data, write to a zarr dataset","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"RVCTqtYoXW"}],"key":"WGTER0L29X"}],"key":"LakeKA9nsH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\n# Needed when boto3 >= 1.36.0 or the rechunking process will fail\n# This needs to be set before the boto3 library gets loaded\n# See: https://github.com/aws/aws-cli/issues/9214#issuecomment-2606619168\nos.environ['AWS_REQUEST_CHECKSUM_CALCULATION'] = 'when_required'\nos.environ['AWS_RESPONSE_CHECKSUM_VALIDATION'] = 'when_required'\nimport fsspec\nimport xarray as xr\nimport hvplot.xarray\nimport pystac\nfrom packaging.version import Version\nimport zarr\nimport warnings\nfrom dask.distributed import LocalCluster, Client\nwarnings.filterwarnings('ignore')","key":"Th4ntWZxmK"},{"type":"outputs","id":"CyLWgwIokasKVpAAPWxCr","children":[],"key":"ET3bsZEqlB"}],"key":"rODyKtKF3A"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Open dataset from WMA STAC Catalog","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UUpvBrXEvn"}],"identifier":"open-dataset-from-wma-stac-catalog","label":"Open dataset from WMA STAC Catalog","html_id":"open-dataset-from-wma-stac-catalog","implicit":true,"key":"Tr3a2idYw5"}],"key":"LeSfpX8zY1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_children(catalog, collection_id=None):\n    \"\"\"\n    This function retrieves a specified collection from a STAC catalog/collection and prints key metadata \n    for exploring/accessing the datasets contained within it.\n    If there is no collection ID provided, the collections in the top level of the catalog will be printed.\n    If a collection ID is provided, it will retrieve the collection with that ID from the input catalog/collection.\n    If the collection ID points to a dataset, it will print the assets available for the dataset.\n    If the collection ID points to another collection, it will list the child collections in the IDed collection.\n\n    Args:\n        catalog (pystac.Catalog | pystac.Collection): The STAC catalog/collection object.\n        collection_id (str): The ID of the collection or dataset to retrieve from catalog.\n    \n    Returns:\n        collection (pystac.Catalog | pystac.Collection): The collection object corresponding to the provided ID\n                                                         or the top-level catalog if no ID is provided.\n    \"\"\"\n    dataset = False\n    if collection_id:\n        collection = catalog.get_child(collection_id)\n        if collection.assets:\n            dataset = True\n            print(f\"{collection_id} is a dataset. Please review the assets below and select one to open.\")\n\n        else:\n            print(f\"{collection_id} is a collection. Please review the child items and select one to open in the next cell.\")\n    else:\n        collection = catalog\n    if dataset==True:\n        # List the assets\n        for asset in collection.assets:\n            print(f\"Asset ID: {asset}\")\n            print(f\"    Title: {collection.assets[asset].title}\")\n            print(f\"    Description: {collection.assets[asset].description}\")\n    else:\n        collections = list(collection.get_collections())\n        print(f\"Number of collections: {len(collections)}\")\n        print(\"Collections IDs:\")\n        for child_collection in collections:\n            id = child_collection.id\n            cite_as = \"Not available\"\n            for link in child_collection.links:\n                if link.rel == \"cite-as\":\n                    cite_as = link.target\n            print(f\"- {id}, Source: {cite_as}\")\n    return collection","key":"TmvxrjFfac"},{"type":"outputs","id":"75muooK4fqlYuG82YppiW","children":[],"key":"mjTBvBsOOM"}],"key":"U7JdYTX8MH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# url for the WMA STAC Catalog\ncatalog_url = \"https://api.water.usgs.gov/gdp/pygeoapi/stac/stac-collection/\"\n\n# use pystac to read the catalog\ncatalog = pystac.Catalog.from_file(catalog_url)\n\n# list the collections in the catalog\ncatalog = get_children(catalog)","key":"EK4StcFisd"},{"type":"outputs","id":"Jh7-IYZSwLSKjI3i2VAA6","children":[],"key":"xJNdixhF9p"}],"key":"DTFl3byE2W"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(catalog, collection_id=\"conus404\")","key":"FFZQG35N0J"},{"type":"outputs","id":"qhVovMHHXh_hRz1hWG3eM","children":[],"key":"rApMSw9Vui"}],"key":"FwjsJutXs1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(collection, collection_id=\"conus404_hourly\")","key":"xedCTAZeWR"},{"type":"outputs","id":"8M7HgJu39bnBGm-2Hbyke","children":[],"key":"VDEi6UYGse"}],"key":"GZcKo5t64j"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# replace with the asset ID you want to use:\nselected_asset_id = \"zarr-s3-osn\"\n\n# read the asset metadata\nasset = collection.assets[selected_asset_id]","key":"a7YKmIyL7i"},{"type":"outputs","id":"4tmSJTpvOxgCzESvnRKOC","children":[],"key":"k80SHCSdTT"}],"key":"M4e5e0YZZW"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2) Set Up AWS Credentials (Optional)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gWuImREIVQ"}],"identifier":"id-2-set-up-aws-credentials-optional","label":"2) Set Up AWS Credentials (Optional)","html_id":"id-2-set-up-aws-credentials-optional","implicit":true,"key":"Go0VDtbXwo"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook reads data from the OSN pod by default, which is object store data on a high speed internet connection that is free to access from any environment. If you change this notebook to use one of the CONUS404 datasets stored on S3 (options ending in ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mZLj8K6X00"},{"type":"inlineCode","value":"-cloud","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jlEB1JmxSI"},{"type":"text","value":"), you will be pulling data from a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nfxQbIyosm"},{"type":"inlineCode","value":"requester-pays","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gDhGs8EVAZ"},{"type":"text","value":" S3 bucket. This means you have to set up your AWS credentials, else we won’t be able to load the data. Please note that reading the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"thSaESeyP7"},{"type":"inlineCode","value":"-cloud","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"u91BRMFXNt"},{"type":"text","value":" data from S3 may incur charges if you are reading data outside of the us-west-2 region or running the notebook outside of the cloud altogether. If you would like to access one of the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zuRk6cFP5k"},{"type":"inlineCode","value":"-cloud","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DuFpgvi5N3"},{"type":"text","value":" options, uncomment and run the following code snippet to set up your AWS credentials. You can find more info about this AWS helper function ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FzwEVB0PqO"},{"type":"link","url":"https://hytest-org.github.io/hytest/environment_set_up/Help_AWS_Credentials.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"i48mjbvHkH"}],"urlSource":"https://hytest-org.github.io/hytest/environment_set_up/Help_AWS_Credentials.html","key":"N4PWlIUrg0"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GckgypFzOc"}],"key":"YtKumNoSj4"}],"key":"fPOdrogYz7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# uncomment the lines below to read in your AWS credentials if you want to access data from a requester-pays bucket (-cloud)\n# os.environ['AWS_PROFILE'] = 'default'\n# %run ../../environment_set_up/Help_AWS_Credentials.ipynb","key":"luYRzNhB3r"},{"type":"outputs","id":"KEkMNAvD7capinWEqLQ1W","children":[],"key":"jQlnfa71wA"}],"key":"R9X1Gqd7tZ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Parallelize with Dask","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PVf9OoCpbD"}],"identifier":"parallelize-with-dask","label":"Parallelize with Dask","html_id":"parallelize-with-dask","implicit":true,"key":"H6G1zemJDB"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Some of the steps we will take are aware of parallel clustered compute environments\nusing ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"JXkt9Bc8aS"},{"type":"inlineCode","value":"dask","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"EZoemRY4l8"},{"type":"text","value":". We’re going to start a cluster now so that future steps can take advantage\nof this ability.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"sGy9QocQaD"}],"key":"eU9UBMgr1r"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"This is an optional step, but speed ups data loading significantly, especially\nwhen accessing data from the cloud.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"xohtoo444F"}],"key":"bMaYhoS92M"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"We have documentation on how to start a Dask Cluster in different computing environments ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ZfN3ZsetlT"},{"type":"link","url":"/environment-set-up/clusters","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"CNiICK9pZR"}],"urlSource":"../../environment_set_up/clusters.md","dataUrl":"/environment-set-up.clusters.json","internal":true,"protocol":"file","key":"QgF4ZSQY73"},{"type":"text","value":".","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"sszqbYjLna"}],"key":"aLzL7sXCGR"}],"key":"e6To9Zshfn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%run ../../environment_set_up/Start_Dask_Cluster_Nebari.ipynb\n## If this notebook is not being run on Nebari, replace the above \n## path name with a helper appropriate to your compute environment.  Examples:\n# %run ../../environment_set_up/Start_Dask_Cluster_Denali.ipynb\n# %run ../../environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb\n# %run ../../environment_set_up/Start_Dask_Cluster_Desktop.ipynb","key":"KsO55ihQLm"},{"type":"outputs","id":"c5ftRvLrX6iR0X3mcLH6t","children":[],"key":"yiDZqbZA7N"}],"key":"Bg3ZAiqXmv"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Explore the dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rFkql5oQXG"}],"identifier":"explore-the-dataset","label":"Explore the dataset","html_id":"explore-the-dataset","implicit":true,"key":"iqKot6BTIw"}],"key":"E7igTQhxNO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if Version(zarr.__version__) < Version(\"3.0.0\"):\n    ds = xr.open_dataset(\n        asset.href,\n        storage_options=asset.extra_fields['xarray:storage_options'],\n        **asset.extra_fields['xarray:open_kwargs']\n    )\nelse:\n    ds = xr.open_dataset(\n    asset.href,\n    storage_options=asset.extra_fields['xarray:storage_options'],\n    **asset.extra_fields['xarray:open_kwargs'],\n    zarr_format=2\n    )","key":"k1fe41RQvl"},{"type":"outputs","id":"Ms8Zh3oEzIZhxmWXdwHP4","children":[],"key":"KXra1MJ5fQ"}],"key":"nAIJkHO8D8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds","key":"xFHmji8B0v"},{"type":"outputs","id":"FRMo6xQkX-TvpSovz-F-6","children":[],"key":"UwbXbz2ORT"}],"key":"Fo0Ox8Xslb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds.T2","key":"kEZhZkeEw9"},{"type":"outputs","id":"bdKcAgqCU9WkX6x9G2Xbo","children":[],"key":"CGTGeaDGNZ"}],"key":"zRk7Nh2JEy"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Daily averages","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z14RhvRBAH"}],"identifier":"daily-averages","label":"Daily averages","html_id":"daily-averages","implicit":true,"key":"lY2BRbAMW8"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Time averages of any type are easy to do with xarray.   Here we do 24 hour averages, and set the time offset to 12 hours, so that the time values are in the middle of the averaging period.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"bwMhSzQcYH"}],"key":"wkZtimZ4Y3"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Digital Earth Africa has a great ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"GtwvewV3f1"},{"type":"link","url":"https://docs.digitalearthafrica.org/fr/latest/sandbox/notebooks/Frequently_used_code/Working_with_time.html","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Working with Time in Xarray","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"IRVfBXxBSX"}],"urlSource":"https://docs.digitalearthafrica.org/fr/latest/sandbox/notebooks/Frequently_used_code/Working_with_time.html","key":"ahd7AHiCdC"},{"type":"text","value":" tutorial.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"oKfZplRbRM"}],"key":"jAo6T0GL0O"}],"key":"KXUvkypa4d"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"In the example below we just do a few days with a few variables as a quick demo.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vVL8eZPGlu"}],"key":"eU2PDg5Hhn"}],"key":"A4cFZTxY4G"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nds_subset = ds[['T2','U10']].sel(time=slice('2017-01-02','2017-01-13'))","key":"AyxBMPjTwo"},{"type":"outputs","id":"r3rNdizv-Hf7zWWfAkjIf","children":[],"key":"VQMJD2PkbA"}],"key":"F3fv0l8UgY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_subset_daily = ds_subset.resample(time=\"24H\", offset=\"12h\", label='right').mean()","key":"ftqDgLZ3vX"},{"type":"outputs","id":"M-dZ_TgazCwAwl-77ZonV","children":[],"key":"zrh83teIk9"}],"key":"X5iykCpjpS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_subset_daily","key":"KQAOEIy8CR"},{"type":"outputs","id":"KNu-M7PJIkZbwyQPI2tQx","children":[],"key":"aNeT5RKniJ"}],"key":"K50ZUx5WOz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_subset_daily.hvplot.quadmesh(x='lon', y='lat', rasterize=True, \n                             geo=True, tiles='OSM', alpha=0.7, cmap='turbo')","key":"lw15iACLry"},{"type":"outputs","id":"JHn6MTpyQNB-2x0qed7V2","children":[],"key":"cO2l2PcKG6"}],"key":"KSH6jT2w0M"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Write daily values as a Zarr dataset (to onprem or cloud)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g0dXTAKjql"}],"identifier":"write-daily-values-as-a-zarr-dataset-to-onprem-or-cloud","label":"Write daily values as a Zarr dataset (to onprem or cloud)","html_id":"write-daily-values-as-a-zarr-dataset-to-onprem-or-cloud","implicit":true,"key":"lwrbiPrbhg"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"You will need to to turn the following cell from ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"XO6iBiexfo"},{"type":"inlineCode","value":"raw","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"NKElNabMCk"},{"type":"text","value":" to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"tmJydxpoXG"},{"type":"inlineCode","value":"code","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"g1KNa1mHUd"},{"type":"text","value":" and update the filepaths in order to save out your data.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"OhNouMHBgZ"}],"key":"LFZo7NnBfx"}],"key":"jxWYSPVOIz"},{"type":"block","kind":"notebook-content","children":[{"type":"code","lang":"","value":"%%time\nif 'SLURM_CLUSTER_NAME' in os.environ:     # on prem (Caldera filesystem)\n    ds_subset_daily.to_zarr('/caldera/usgs/change-me/conus_subset_daily.zarr', mode='w', consolidated=True)\nelse:                                      # cloud (AWS S3 nhgf-development bucket)\n    fs_s3 = fsspec.filesystem('s3', anon=False)\n    ds_subset_daily.to_zarr(fs_s3.get_mapper('s3://esip-qhub/testing/conus_subset_daily.zarr'), mode='w', consolidated=True)","key":"VBGMtp58xb"}],"key":"GlFURVWwgk"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Shutdown cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xd48XotEaW"}],"identifier":"shutdown-cluster","label":"Shutdown cluster","html_id":"shutdown-cluster","implicit":true,"key":"qYRlYkwMXB"}],"key":"uQ6hgVrY11"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close(); cluster.shutdown()","key":"F1uA3p6am6"},{"type":"outputs","id":"FJcqWM1SfE9lbMl7UKX14","children":[],"key":"aX841z70Mn"}],"key":"AANRfx7OlG"}],"key":"aiLGh1JObi"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Additional Resources","url":"/dataset-processing/tutorials/chunking/back/additionalresources","group":"Zarr Creation"},"next":{"title":"Spatial Aggregation","url":"/dataset-processing/spatial-aggregation","group":"Dataset Processing"}}},"domain":"http://localhost:3005"}