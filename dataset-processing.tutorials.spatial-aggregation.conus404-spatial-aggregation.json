{"version":3,"kind":"Notebook","sha256":"cc483420a5326713b8966342e1e782e4f0ee7f4ddb41d87f9a47bfea1bd42fd6","slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation","location":"/dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation.ipynb","dependencies":[],"frontmatter":{"title":"Pangeo CONUS404 Spatial Aggregation over DRB-extent HUC12s","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":2}},"source_url":"https://github.com/hytest-org/hytest/blob/main/dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation.ipynb","edit_url":"https://github.com/hytest-org/hytest/edit/main/dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation.ipynb","exports":[{"format":"ipynb","filename":"conus404_spatial_aggregation.ipynb","url":"/hytest//build/conus404_spatial_agg-0c560d08dc010613bee0e05a36d1a4f0.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this notebook, we will be showing how to aggregate gridded data to polygons. The method aggregates gridded data ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kzO8VZQNe8"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"conservatively","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"h0Qc5pjJpZ"}],"key":"Bebl3uVM7k"},{"type":"text","value":", i.e. by exactly partitioning each grid cell into the precise region boundaries. The method makes use of two key packages ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T2cepwW1tb"},{"type":"link","url":"https://docs.xarray.dev/en/stable/index.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"xarray","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"p1HuMrpsRU"}],"urlSource":"https://docs.xarray.dev/en/stable/index.html","key":"Mu7vaYbcPG"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XCXWYjEpTD"},{"type":"link","url":"https://geopandas.org/en/stable/index.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"geopandas","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ljXMioaYE4"}],"urlSource":"https://geopandas.org/en/stable/index.html","key":"mHyCGkDcnL"},{"type":"text","value":". Our implementation is based off of this ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"G2dLeIlRJT"},{"type":"link","url":"https://discourse.pangeo.io/t/conservative-region-aggregation-with-xarray-geopandas-and-sparse/2715","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Pangeo Discourse","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XggNNGUukw"}],"urlSource":"https://discourse.pangeo.io/t/conservative-region-aggregation-with-xarray-geopandas-and-sparse/2715","key":"B8hTffF0LE"},{"type":"text","value":", which we have updated using more streamlined methods.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"p8Ob4zMdxl"}],"key":"JJwl1iQpdc"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The overall approach consists of:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KoV85DOgTz"}],"key":"OTA7p0SNuG"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Represent both the original gridded data and target polygons as ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"L0ZlkwUs4g"},{"type":"link","url":"https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoSeries.html","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"geopandas.GeoSeries","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uQwOZKBIma"}],"urlSource":"https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoSeries.html","key":"AThrbeXz1o"},{"type":"text","value":" objects (with vector geometries).","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"YyB78d5jsN"}],"key":"spnzq6pnmI"}],"key":"iQLAe7vPXN"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Compute their area overlay and turn it into a sparse matrix of cell weights.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"KO9fUKGZFN"}],"key":"n97JJNdlVq"}],"key":"xfQwCp5DNd"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Perform weighted aggregation using ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"QKteataMQe"},{"type":"link","url":"https://docs.xarray.dev/en/stable/generated/xarray.Dataset.weighted.html#xarray.Dataset.weighted","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"inlineCode","value":"xarray.Dataset.weighted","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"pOo1Kwd2sM"}],"urlSource":"https://docs.xarray.dev/en/stable/generated/xarray.Dataset.weighted.html#xarray.Dataset.weighted","key":"v9aAiTzsvk"},{"type":"text","value":" along the spatial dimensions.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"pMBg7PQdjc"}],"key":"JjrZ3KNCyx"}],"key":"xe36v6tvBy"}],"key":"TNhrVwtC26"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"It is quite fast and transparent.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"rR3mJLgiCd"}],"key":"BrEAfSxv9J"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"The spatial polygons used in this notebook come from the ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"SMNagy0LPd"},{"type":"link","url":"https://www.sciencebase.gov/catalog/item/60cb5edfd34e86b938a373f4","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"strong","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"NHDPlusV2 snapshot of the Watershed Boundary Dataset HUC12 boundaries","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"JW6nsRE9Vz"}],"key":"bsPA67TbzU"}],"urlSource":"https://www.sciencebase.gov/catalog/item/60cb5edfd34e86b938a373f4","key":"BpbSzrWH7U"},{"type":"text","value":" provided through the ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"hqEqXC80Pa"},{"type":"link","url":"https://docs.hyriver.io/readme/pygeohydro.html","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"PyGeoHydro","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"yovhHz5LAR"}],"urlSource":"https://docs.hyriver.io/readme/pygeohydro.html","key":"pcEqqNaOqk"},{"type":"text","value":" python package.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"ZT1nlBufV2"}],"key":"At68bNvt7c"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"We use the HyTest intake catalog to access CONUS404 from the OSN pod. This notebook provides a relatively simple and efficient workflow that can be easily run on a local computer.","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"XHwVU5yYAc"}],"key":"bkufnZeIHB"}],"visibility":"show","key":"ryYxfZLlbM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%xmode minimal\nimport os\n# Needed when boto3 >= 1.36.0 or the rechunking process will fail\n# This needs to be set before the boto3 library gets loaded\n# See: https://github.com/aws/aws-cli/issues/9214#issuecomment-2606619168\nos.environ['AWS_REQUEST_CHECKSUM_CALCULATION'] = 'when_required'\nos.environ['AWS_RESPONSE_CHECKSUM_VALIDATION'] = 'when_required'\nimport xarray as xr\nimport geopandas as gp\nimport pandas as pd\nimport numpy as np\nimport sparse\n\nimport hvplot.pandas\nimport hvplot.xarray\nimport dask\nimport cf_xarray\n\nfrom pynhd import NLDI, WaterData\nfrom pygeohydro import watershed\nimport pystac\nfrom packaging.version import Version\nimport zarr\nimport cartopy.crs as ccrs\nfrom shapely.geometry import Polygon","key":"gMBX6DuCUL"},{"type":"outputs","id":"qXfsmtWvRZR9eI4ArSwjZ","children":[],"key":"IDVR6f5wyL"}],"key":"ecfmBZvPdj"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Open Dataset from Intake Catalog","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YEAAiHfH63"}],"identifier":"open-dataset-from-intake-catalog","label":"Open Dataset from Intake Catalog","html_id":"open-dataset-from-intake-catalog","implicit":true,"key":"C55ngWyMDV"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"First, let’s begin by loading the CONUS404 daily data.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nFdrrqjHWw"}],"key":"Isu6luwup0"}],"key":"xHMwREqm7b"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_children(catalog, collection_id=None):\n    \"\"\"\n    This function retrieves a specified collection from a STAC catalog/collection and prints key metadata \n    for exploring/accessing the datasets contained within it.\n    If there is no collection ID provided, the collections in the top level of the catalog will be printed.\n    If a collection ID is provided, it will retrieve the collection with that ID from the input catalog/collection.\n    If the collection ID points to a dataset, it will print the assets available for the dataset.\n    If the collection ID points to another collection, it will list the child collections in the IDed collection.\n\n    Args:\n        catalog (pystac.Catalog | pystac.Collection): The STAC catalog/collection object.\n        collection_id (str): The ID of the collection or dataset to retrieve from catalog.\n    \n    Returns:\n        collection (pystac.Catalog | pystac.Collection): The collection object corresponding to the provided ID\n                                                         or the top-level catalog if no ID is provided.\n    \"\"\"\n    dataset = False\n    if collection_id:\n        collection = catalog.get_child(collection_id)\n        if collection.assets:\n            dataset = True\n            print(f\"{collection_id} is a dataset. Please review the assets below and select one to open.\")\n\n        else:\n            print(f\"{collection_id} is a collection. Please review the child items and select one to open in the next cell.\")\n    else:\n        collection = catalog\n    if dataset==True:\n        # List the assets\n        for asset in collection.assets:\n            print(f\"Asset ID: {asset}\")\n            print(f\"    Title: {collection.assets[asset].title}\")\n            print(f\"    Description: {collection.assets[asset].description}\")\n    else:\n        collections = list(collection.get_collections())\n        print(f\"Number of collections: {len(collections)}\")\n        print(\"Collections IDs:\")\n        for child_collection in collections:\n            id = child_collection.id\n            cite_as = \"Not available\"\n            for link in child_collection.links:\n                if link.rel == \"cite-as\":\n                    cite_as = link.target\n            print(f\"- {id}, Source: {cite_as}\")\n    return collection","key":"M72k7z8xSR"},{"type":"outputs","id":"lNYkOu4UHOCv7EErZSQhW","children":[],"key":"GjDCq9sknO"}],"key":"zxO8J3PEQ7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# url for the WMA STAC Catalog\ncatalog_url = \"https://api.water.usgs.gov/gdp/pygeoapi/stac/stac-collection/\"\n\n# use pystac to read the catalog\ncatalog = pystac.Catalog.from_file(catalog_url)\n\n# list the collections in the catalog\ncatalog = get_children(catalog)","key":"vCgDML7VC4"},{"type":"outputs","id":"RhhBVMQGuonPik8gjk5ED","children":[],"key":"j2Llt7B8GE"}],"key":"a1Nfi7ns5s"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(catalog, collection_id=\"conus404\")","key":"JI0JcO4slF"},{"type":"outputs","id":"S59mfEIn3v7-e9ihWm7P5","children":[],"key":"b1MJdyBgza"}],"key":"RGAifg6DgP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(collection, collection_id=\"conus404_daily\")","key":"iaZ6NmJO2b"},{"type":"outputs","id":"7seTZmuNqxUdg2zOpm98A","children":[],"key":"fH5k9oo9w6"}],"key":"O1gpQmdtAc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# replace with the asset ID you want to use:\nselected_asset_id = \"zarr-s3-osn\"\n\n# read the asset metadata\nasset = collection.assets[selected_asset_id]","key":"c4VOQrHjhg"},{"type":"outputs","id":"aoFXNnxNGIa4cHqcR4B_9","children":[],"key":"GyzsawFzuG"}],"key":"VMdnpobCiT"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"As we can see there are two different locations for the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HuTD4BjLfh"},{"type":"inlineCode","value":"conus404_daily","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fbESwpxJ52"},{"type":"text","value":" data set. The locations are (1) ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yUhO4S74C2"},{"type":"inlineCode","value":"-hovenweep","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y4IAPViYbK"},{"type":"text","value":" meaning it is stored on the USGS Hovenweep HPC and (2) ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wJEO3qpizR"},{"type":"inlineCode","value":"-osn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SbUKTFGfBm"},{"type":"text","value":" meaning the data is on the USGS open storage network (OSN). As the OSN is free to access from any environment, we will use that for this example, but the location can easily be changed depending on your needs.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iMx5Eac0K7"}],"key":"eYVq32DOZ1"}],"key":"TbEqJehBPt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# uncomment the lines below to read in your AWS credentials if you want to access data from a requester-pays bucket (-cloud)\n# os.environ['AWS_PROFILE'] = 'default'\n# %run ../../../environment_set_up/Help_AWS_Credentials.ipynb","key":"FXkktg8xfB"},{"type":"outputs","id":"Y3QNc0nZWYBfcm1_P3aH9","children":[],"key":"YwUIQT2Y6W"}],"key":"uQXPZqLOQt"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Finally, read in the daily CONUS404 data set.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nHZufUJRj8"}],"key":"kNs1bxSkrl"}],"key":"cTCtORyBOI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if Version(zarr.__version__) < Version(\"3.0.0\"):\n    conus404 = xr.open_dataset(\n        asset.href,\n        storage_options=asset.extra_fields['xarray:storage_options'],\n        **asset.extra_fields['xarray:open_kwargs']\n    )\nelse:\n    conus404 = xr.open_dataset(\n    asset.href,\n    storage_options=asset.extra_fields['xarray:storage_options'],\n    **asset.extra_fields['xarray:open_kwargs'],\n    zarr_format=2\n    )\n\nconus404","key":"THsPh2NVf5"},{"type":"outputs","id":"DHy-rQk3PIl8CjaCAxJQu","children":[],"key":"CPpYqVXxMT"}],"key":"TcmdFJwmuj"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Parallelize with Dask (optional)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ko6mK4DRhO"}],"identifier":"parallelize-with-dask-optional","label":"Parallelize with Dask (optional)","html_id":"parallelize-with-dask-optional","implicit":true,"key":"J4sdq5qfp3"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Some of the steps we will take are aware of parallel clustered compute environments using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"r0ndyHAAN4"},{"type":"link","url":"https://www.dask.org/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vF0CJGF84N"}],"urlSource":"https://www.dask.org/","key":"uzfAW0go4h"},{"type":"text","value":". We can start a cluster now so that future steps take advantage\nof this ability. This is an optional step, but speed ups data loading significantly, especially when accessing data from the cloud.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DOgEQ8bOZX"}],"key":"sTUs9J9ypl"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"We have documentation on how to start a Dask Cluster in different computing environments ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"v2gxg1BkIC"},{"type":"link","url":"/environment-set-up/clusters","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"kBs60yeVHd"}],"urlSource":"../../../environment_set_up/clusters.md","dataUrl":"/environment-set-up.clusters.json","internal":true,"protocol":"file","key":"icNcppFhRK"},{"type":"text","value":". Uncomment the cluster start up that works for your compute environment.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ZAIA0XCmyj"}],"key":"b7KBcKDIvw"}],"key":"mifJqIXR3I"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%run ../../../environment_set_up/Start_Dask_Cluster_Nebari.ipynb\n## If this notebook is not being run on Nebari, replace the above \n## path name with a helper appropriate to your compute environment.  Examples:\n# %run ../../../environment_set_up/Start_Dask_Cluster_Denali.ipynb\n# %run ../../../environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb\n# %run ../../../environment_set_up/Start_Dask_Cluster_Desktop.ipynb","key":"TNJ9ffO3fJ"},{"type":"outputs","id":"kcELAD7VZaDpGGRid48HY","children":[],"key":"M7H1lGUEfr"}],"key":"sTSkIeEg3P"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load the Feature Polygons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pVrolfZ81X"}],"identifier":"load-the-feature-polygons","label":"Load the Feature Polygons","html_id":"load-the-feature-polygons","implicit":true,"key":"XmcEIPEJ5t"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we have read in the CONUS404 data, we need to read in some polygons to aggregate the data. For this example, we will use the HUC12 basins within the Delaware River Basin. To get these HUC12 polygons, we can use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FDBOED9TEn"},{"type":"link","url":"https://docs.hyriver.io/autoapi/pygeohydro/watershed/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"pygeohydro.watershed","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zZR3PvkT5v"}],"urlSource":"https://docs.hyriver.io/autoapi/pygeohydro/watershed/","key":"gshfF6aqmk"},{"type":"text","value":" to query the Hydro Network Linked Data Index (NLDI). All we need to get the basins is the general IDs of the HUC12 basins. For the Delaware Basin those are ones that start with 020401 or 020402.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"t3PgMB2UYc"}],"key":"lYMugQpUsW"}],"key":"FY7riWcWTm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nwbd = watershed.WBD(\"huc4\")\ndelaware_basin = wbd.byids(field=\"huc4\", fids=\"0204\")\nhuc12_basins = WaterData('wbd12').bygeom(delaware_basin.iloc[0].geometry)\nhuc12_basins = huc12_basins[huc12_basins['huc12'].str.startswith(('020401', '020402'))]\nhuc12_basins","key":"dmrIPGKt39"},{"type":"outputs","id":"Je7JGEX_QxFd1gd2W2Q5o","children":[],"key":"iPExmLxOmE"}],"key":"IsHnkAKgSy"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s plot the HUC12 basins to see how they look.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HF5gzSsVri"}],"key":"qPP4Bw9fHi"}],"key":"CypymJZPPq"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"huc12_basins.hvplot(\n    c='huc12', title=\"Delaware River HUC12 basins\",\n    coastline='50m', geo=True,\n    aspect='equal', legend=False, frame_width=300\n)","key":"AXgwgYOKaO"},{"type":"outputs","id":"MMz1kFL_zOmGX7XIrH2Xg","children":[],"key":"llIuTGGoc4"}],"key":"P1raqDWg4c"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"An important thing to note is that all geodataframes should have a coordinate reference system (CRS). Let’s check to make sure our geodataframe has a CRS.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KsznEpguzD"}],"key":"IXJ92EBYSD"}],"key":"HLU4zzvZxt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"huc12_basins.crs","key":"FFXXK6X0ys"},{"type":"outputs","id":"cGere0k-a-426bgXNj_Ue","children":[],"key":"a3pyHsrU0Y"}],"key":"rHlmrZlqET"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Limit CONUS404 Spatial Range","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QLoYUpaskC"}],"identifier":"limit-conus404-spatial-range","label":"Limit CONUS404 Spatial Range","html_id":"limit-conus404-spatial-range","implicit":true,"key":"woyyhYYwa8"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"With the HUC12 basins read in, we only need the CONUS404 data that spans these polygons as they are the regions we will be aggregating. So, let’s limit the CONUS404 spatial range to that of the basins. This will save on memory and computation. Note doing this is mainly useful when the region’s footprint is much smaller than the footprint of the gridded model.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"q5hC2VXpFf"}],"key":"fbwXtooDYu"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To limit the spatial range, we first need to convert the CRS of the basins to that of CONUS404. Then extract the bounding box of the basins.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kmVSXnBBoe"}],"key":"i7GLDKM29s"}],"key":"Sd5XEcGAwa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"huc12_basins_conus404_crs = huc12_basins.to_crs(conus404.crs.crs_wkt)\nbbox = huc12_basins_conus404_crs.total_bounds\nbbox","key":"xYDIzWYHR5"},{"type":"outputs","id":"r02HIKw5r3KZYP1y3I7k0","children":[],"key":"KTbYGliILD"}],"key":"C2VLT7aGOT"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Then select the CONUS404 data within the bounding box. However, when we do this, we will extend the bounds out by 5% of their range to ensure all of our basins are within the spatially limited data. We do this as the reprojections of the CRS can cause slight distortions that make polygons on the bounds not fall fully within the data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gRKejK3hlv"}],"key":"K95Wz7GTvB"}],"key":"rUuZUMdFaq"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"bbox_x_range = bbox[2] - bbox[0]\nbbox_y_range = bbox[3] - bbox[1]\nx_range = slice(bbox[0] - bbox_x_range * 0.05,\n                bbox[2] + bbox_x_range * 0.05)\ny_range = slice(bbox[1] - bbox_y_range * 0.05,\n                bbox[3] + bbox_y_range * 0.05)\n\nconus404 = conus404.sel(x=x_range, y=y_range)\nconus404","key":"IozNNrQS1W"},{"type":"outputs","id":"Q94XfT0PAjMTxstrteuvY","children":[],"key":"ItxHJQ8lly"}],"key":"HTTMHvfX8p"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To make sure this worked as intended, let’s plot the full basin over the extracted CONUS404 data footprint.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W7BidN725D"}],"key":"Jvyzk29nBH"}],"key":"XImgxUIzrp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Get the footprint of the grid\ncutout = xr.ones_like(conus404.isel(time=0).drop_vars(['lat', 'lon'])['ACDEWC'])\n# We need to write the CRS to the CONUS404 dataset and\n# reproject to the crs of the HUC12 basins dataframe for clean plotting with hvplot\ncutout = cutout.rio.write_crs(conus404.crs.crs_wkt).rio.reproject('EPSG:4326')\n\ncutout_plt = cutout.hvplot(\n    coastline='50m', geo=True,\n    aspect='equal', frame_width=300, colorbar=False\n)\nhuc12_plt = huc12_basins.hvplot(\n    geo=True, c='r'\n)\ncutout_plt * huc12_plt","key":"Dfgg5LUuHr"},{"type":"outputs","id":"_GWvVIhRpMDhbHl31wc5a","children":[],"key":"NPi7szEB27"}],"key":"Gzj1j0lAyJ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Looks good!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CM0S1BbSFr"}],"key":"kKKBmnNiN2"}],"key":"Z1tEHs3pf7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Aggregate CONUS404 to HUC12 Polygons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"t3gHiltLvM"}],"identifier":"aggregate-conus404-to-huc12-polygons","label":"Aggregate CONUS404 to HUC12 Polygons","html_id":"aggregate-conus404-to-huc12-polygons","implicit":true,"key":"RvVXGK2QQ9"}],"key":"ereoL11Q0D"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now that we have our dataset and basin polygons prepared, we are ready to aggregate.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kOP4IjK7VM"}],"key":"mWWG2slYsR"},{"type":"heading","depth":3,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Create Grid Polygons","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"m7GFuN0e2Y"}],"identifier":"create-grid-polygons","label":"Create Grid Polygons","html_id":"create-grid-polygons","implicit":true,"key":"W1Msg2I6XX"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The first step here is to extract the CONUS404 grid information, which consists of getting the grid center points and the grid bounds.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"W98EwvEMz3"}],"key":"etRZcu0NDU"}],"key":"AiI0ZQew74"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid = conus404[['x', 'y']].drop_vars(['lat', 'lon']).reset_coords()\ngrid = grid.cf.add_bounds(['x', 'y'])\ngrid","key":"NBwKLKoDmo"},{"type":"outputs","id":"6Ijgt-f-cNi6EHYZbxt5X","children":[],"key":"arMEJeic5K"}],"key":"xjXWehA8TM"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Then, we “stack” the data into a single 1D array. This creates an index of (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ziwNSWSGXQ"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LKHfNcDuJI"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vT9rGnSczL"},{"type":"inlineCode","value":"y","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Tb8tCAAD9o"},{"type":"text","value":") pairs of the center points that links to the bounds. This will make generating polygons of the grid cells from the bounds much simpler than any manual looping.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eFPJopxMSb"}],"key":"MYJf6lu13E"}],"key":"mrFClBgQnb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"points = grid.stack(point=('y', 'x'))\npoints","key":"eR7vnP12Xv"},{"type":"outputs","id":"HBBO5AYNXu84iCV9O5QWO","children":[],"key":"EoPU1QwbQs"}],"key":"D3O1eQvVkw"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next, we can use the point pairs we just created to make polygons from the bounds. To do this, we we will make a simple function that takes the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ugIkSQushp"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ilIOEGSKbJ"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y5AXxYPXT0"},{"type":"inlineCode","value":"y","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PEXTaE3bkq"},{"type":"text","value":" bound to generate a polygon for the given grid cell. We can then apply it in parallel using ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nlmjKZAXYw"},{"type":"link","url":"https://docs.xarray.dev/en/stable/generated/xarray.apply_ufunc.html","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"xarray.apply_ufunc","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xz9k5wpoyk"}],"urlSource":"https://docs.xarray.dev/en/stable/generated/xarray.apply_ufunc.html","key":"Oxzh0KBHiD"},{"type":"text","value":". Note that this step will get slower as we increase the grid size from our limited range. Perhaps could be vectorized using ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aYMdrRlf41"},{"type":"link","url":"https://pygeos.readthedocs.io/en/latest/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"pygeos","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vPSpLtvM2w"}],"urlSource":"https://pygeos.readthedocs.io/en/latest/","key":"DCLC2jbl7d"},{"type":"text","value":"...","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MYAMcZgihq"}],"key":"qSxUeDWI0c"}],"key":"l7YSGHCuEB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\ndef bounds_to_poly(x_bounds, y_bounds):\n    return Polygon([\n        (x_bounds[0], y_bounds[0]),\n        (x_bounds[0], y_bounds[1]),\n        (x_bounds[1], y_bounds[1]),\n        (x_bounds[1], y_bounds[0])\n    ])\n    \nboxes = xr.apply_ufunc(\n    bounds_to_poly,\n    points.x_bounds,\n    points.y_bounds,\n    input_core_dims=[(\"bounds\",),  (\"bounds\",)],\n    output_dtypes=[np.dtype('O')],\n    vectorize=True\n)\nboxes","key":"AMjJKQwZ13"},{"type":"outputs","id":"oMbz5CqDCxDR4PQlxxL4N","children":[],"key":"DD54Jqf60J"}],"key":"sM6SZGSTvU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Finally, we convert this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BBfuI5PL8J"},{"type":"inlineCode","value":"xarray.DataArray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QY6YWfZmgg"},{"type":"text","value":" to a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ISq9iX9Psn"},{"type":"inlineCode","value":"geopandas.GeoDataframe","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ydh0OaAE6W"},{"type":"text","value":", specifying the projected CRS to be the same as the CONUS404 dataset.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"scKcrx8QFT"}],"key":"NIyJMNMPHl"}],"key":"gnTcom8mcB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid_polygons= gp.GeoDataFrame(\n    data={\"geometry\": boxes.values, \"y\": boxes['y'], \"x\": boxes['x']},\n    index=boxes.indexes[\"point\"],\n    crs=conus404.crs.crs_wkt\n)\ngrid_polygons","key":"kV1AX2UsQI"},{"type":"outputs","id":"spDsEr7YNoZI2GePP32zN","children":[],"key":"rT1z90VNeY"}],"key":"Qx5TILoZI1"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Key Step: Overlay the Two Geometries","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rMPKeXkrl8"}],"identifier":"key-step-overlay-the-two-geometries","label":"Key Step: Overlay the Two Geometries","html_id":"key-step-overlay-the-two-geometries","implicit":true,"key":"YC0LfxPlCC"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We are finally ready for the magic of this method, the weight generation using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sXLmVUcs4j"},{"type":"inlineCode","value":"geopandas","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EwqaJYKB5O"},{"type":"text","value":". To calculate the weights, we will use the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lWUFyeDQ64"},{"type":"link","url":"https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.overlay.html#geopandas.GeoDataFrame.overlay","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"overlay","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KBZ5WyKOLK"}],"urlSource":"https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.overlay.html#geopandas.GeoDataFrame.overlay","key":"fZYa9Imt9g"},{"type":"text","value":" method in ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PNMRZzDC8i"},{"type":"inlineCode","value":"geopandas","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sha7hLCAfe"},{"type":"text","value":". It calculates the area overlap between polygons in two different ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LYp0ZOWW9u"},{"type":"inlineCode","value":"GeoDataFrames","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OepGbKwaBV"},{"type":"text","value":", i.e. the original grid polygons and the HUC12 polygons. An important thing to note is that when generating the weights we need to use an equal area projection (i.e., equal area CRS). So, before we overlay, we will need to convert the CRS to an area preserving projection. Here we use the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DCQ8lSa2mq"},{"type":"link","url":"https://nsidc.org/data/user-resources/help-center/guide-ease-grids","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"NSIDC EASE-Grid 2.0","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"S8Mtu08NAY"}],"urlSource":"https://nsidc.org/data/user-resources/help-center/guide-ease-grids","key":"ocR02KC9md"},{"type":"text","value":" grid for the Northern Hemisphere.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mcOSRqbAr6"}],"key":"xNGvirF4Cx"},{"type":"blockquote","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"As long as the feature polygons only cover a few 100s of grid polygons, this is an extremely fast operation. However, if 1000s of grid cells are covered this can be a wasteful calculation, as we really only need it for the grid polygons that are partially covered. Otherwise, we could use a faster computational method for fully covered cells, but we will leave that complex topic for another notebook.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"x7mnhAC0ae"}],"key":"cOaBK0K2RL"}],"key":"tbHSFJY54x"}],"key":"sf2lLfnOLi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\ncrs_area = \"EPSG:6931\" # Good for northern hemisphere\n# crs_area = \"EPSG:5070\" # Good for CONUS\n\nhuc12_basins_area = huc12_basins.to_crs(crs_area)\ngrid_polygons = grid_polygons.to_crs(crs_area)\n\n# overlay the polygons\noverlay = grid_polygons.overlay(huc12_basins_area, keep_geom_type=True)","key":"SbBMcMcrd2"},{"type":"outputs","id":"EzU20D3WDHflgf-4_iXhL","children":[],"key":"fhfcAyNs8y"}],"key":"GxcmPywQfz"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This is essentially already a sparse matrix, mapping one grid space to the other. How sparse? Let’s check.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G8APC9qC3q"}],"key":"unK0dtQdYR"}],"key":"Z8tEc1KbVU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sparsity = len(overlay) / (len(grid_polygons) * len(huc12_basins_area))\nsparsity","key":"s9rRtwzBgz"},{"type":"outputs","id":"x6JMdnQ64TJ0K6wDexTCj","children":[],"key":"fKpvaYySkI"}],"key":"noNLmYLzn7"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s explore these overlays a little bit more. Mainly, we can verify that each basin’s area is preserved in the overlay operation.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZRu6QXGpoU"}],"key":"T6xPAyTPX7"}],"key":"t5h2W9Jcju"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# calculate areas of HUC12s from overlay and original polygons\noverlay_area = overlay.geometry.area.groupby(overlay['huc12']).sum()\nhuc12_area = huc12_basins_area.geometry.area.groupby(huc12_basins_area['huc12']).sum()\n# find the max fractional difference\n(np.abs(overlay_area - huc12_area) / huc12_area).max()","key":"DPr9jh49rG"},{"type":"outputs","id":"XHugGZpDeJE-KQQ_T6QJF","children":[],"key":"upvtVRSg38"}],"key":"KmaaWZV8SK"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Nice! So, it worked and only have differences within machine precision.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X9MqmaNiaz"}],"key":"ydkumNJfDo"}],"key":"jLcAiYdma0"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Calculate the Weights (i.e., Area Fraction for each Region)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OEm21QiUEL"}],"identifier":"calculate-the-weights-i-e-area-fraction-for-each-region","label":"Calculate the Weights (i.e., Area Fraction for each Region)","html_id":"calculate-the-weights-i-e-area-fraction-for-each-region","implicit":true,"key":"WsHCparE8M"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we have the overlay of the grid polygons with the HUC12 polygons, we only need to transform this to weights for each grid cell to aggregate. This transform tells us how much of a HUC12 polygon’s total area is within each of the grid cells. This is accurate because we used an area-preserving CRS. Calculating this fractional area is again simple with ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Vddands17n"},{"type":"inlineCode","value":"geopandas","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NRCXx1p30I"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"h7N8eTafC9"}],"key":"DJmIhrgaYB"}],"key":"zIvtVFslVT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid_cell_fraction = overlay.geometry.area.groupby(overlay['huc12']).transform(lambda x: x / x.sum())\ngrid_cell_fraction","key":"IDvT2oltjK"},{"type":"outputs","id":"Cwd3Y9xLRUmVuuDs9JeXw","children":[],"key":"dSdZBsqmRX"}],"key":"CmyjYxIi9n"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can verify that these all sum up to one.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mWi7SzWeNz"}],"key":"pbcnIHTtZJ"}],"key":"iah0NGmT3z"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid_cell_fraction.groupby(overlay['huc12']).sum().unique()","key":"uBaSnmXhU9"},{"type":"outputs","id":"1dP6D2ePhcelXaJtdA05p","children":[],"key":"WYBXMywZ8y"}],"key":"bPuRgKV3kA"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"However, in their current ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"i26UZa5bzz"},{"type":"inlineCode","value":"Series","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pshTYsdk7b"},{"type":"text","value":" form, the weights aren’t very useful. What we need is to convert them to a sparse array within ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BHAAMjQ29C"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sDaHemjLyQ"},{"type":"text","value":". Thankfully, ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xk2CZSFXHD"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UFMvoLlxTU"},{"type":"text","value":" can easily do this if we add a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Jm5FDnOZHv"},{"type":"inlineCode","value":"MultiIndex","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ba9oysXXYB"},{"type":"text","value":" for the grid cells’ center points and HUC12 IDs to the cell fraction ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jXRLJcq3Jb"},{"type":"inlineCode","value":"DataFrame","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"o4YbhVJFjq"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bHUOYKsXNm"}],"key":"GTcFilBVTa"}],"key":"ue3ChO2T0X"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"multi_index = overlay.set_index(['y', 'x', 'huc12']).index\ndf_weights = pd.DataFrame({\"weights\": grid_cell_fraction.values}, index=multi_index)\ndf_weights","key":"Pan1Jf0cVc"},{"type":"outputs","id":"Dlvrm0mYWWHzNlyLyG0_6","children":[],"key":"KDNRnO8bSB"}],"key":"N6hFYihGcq"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can bring this directly into ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qvwBv0PmEr"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jTesGGnO73"},{"type":"text","value":" as a 1D ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gwsJ5Se4Hf"},{"type":"inlineCode","value":"Dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ApmHYUMbYX"},{"type":"text","value":" and then unstack it into a sparse array.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bCVUydhyU2"}],"key":"S0zy3HxWLT"}],"key":"v5AjxpEaWM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_weights = xr.Dataset(df_weights)\nweights_sparse = ds_weights.unstack(sparse=True, fill_value=0.).weights\nweights_sparse","key":"Ymy6LZwH0J"},{"type":"outputs","id":"_6iDe4VzRy2r7tXYWow_e","children":[],"key":"qznRl2agCX"}],"key":"jJAiBRJJLM"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Again, we can clearly see that this is a sparse matrix from the density. This is now all we need to do our aggregation.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ikqgCvr4a6"}],"key":"fgrR13pLJ1"}],"key":"Dn6kJ4sPQK"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Perform the Aggregation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qlmtOJdyk7"}],"identifier":"perform-the-aggregation","label":"Perform the Aggregation","html_id":"perform-the-aggregation","implicit":true,"key":"UgEnjt76AJ"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Unlike deriving the weights, actually performing the aggregation is a simple one line of code. This is because we utilize ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"h98sPlMlu3"},{"type":"link","url":"https://docs.xarray.dev/en/stable/generated/xarray.Dataset.weighted.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"xarray.Dataset.weighted","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NJdp0YPn4q"}],"urlSource":"https://docs.xarray.dev/en/stable/generated/xarray.Dataset.weighted.html","key":"CV3HCoHznN"},{"type":"text","value":" to do our weighted calculations. It will happily take a sparse array as weights and compute the aggregation.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uqHnAnUG6g"}],"key":"TQ3BYVxqrs"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"However, rather than aggregating all variables, let’s only aggregate two in order to reduce the computational time.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zGEh2sdkmh"}],"key":"G2iBvvSiw2"}],"key":"yqINUy1reA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# Note the .compute() at the end to actually do the computation here vs lazy computing\nhuc12_aggregation = conus404[['T2', 'PREC_ACC_NC']].weighted(weights_sparse).sum(dim=['x', 'y']).compute()\nhuc12_aggregation","key":"qRiRsVDd9O"},{"type":"outputs","id":"HZ7Qt881sTwHtCKYmaQo-","children":[],"key":"JETk3WQu3q"}],"key":"Gf4U2C5AUd"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note that our aggregations are still sparse arrays, which is the cost of using a sparse array as our weights. However, the density of these sparse arrays is large, meaning we want to convert them out of sparse arrays and back to dense arrays. To do this, we can use ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wSmaz7azMd"},{"type":"inlineCode","value":"apply_ufunc","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ovYtJSPo9D"},{"type":"text","value":" with a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ycq1EJYSmD"},{"type":"inlineCode","value":"lambda","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZFHv2Jgh2s"},{"type":"text","value":" function to convert.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WKCCg9wygl"}],"key":"SSkjEl1z7y"}],"key":"ovnd0B5MRP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"huc12_aggregation = xr.apply_ufunc(lambda data: data.todense(), huc12_aggregation)","key":"fpUCYQx2Fs"},{"type":"outputs","id":"YwrPpCZsK0lhDPa9Ey21q","children":[],"key":"vxFabssZqA"}],"key":"QWxEqNI5rU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"It important to note that we used a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KccvQEahTZ"},{"type":"inlineCode","value":"sum","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WxJA9bqA6e"},{"type":"text","value":" aggregation above rather than a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X5NnPKBNAF"},{"type":"inlineCode","value":"mean","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b90n3u1gos"},{"type":"text","value":". In theory, the two methods should be the same as a weighted sum is a weighted mean if the sum of weights is one (which they are in our case):","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NTNioWttIx"}],"key":"J1aw6QuauQ"},{"type":"math","value":"\\textrm{weighted mean:\\ }\\frac{\\sum_{i=1}^n w_i x_i}{\\sum_{i=1}^n w_i}","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>weighted mean: </mtext><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>w</mi><mi>i</mi></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\textrm{weighted mean:\\ }\\frac{\\sum_{i=1}^n w_i x_i}{\\sum_{i=1}^n w_i}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.488em;vertical-align:-0.994em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">weighted mean: </span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.494em;\"><span style=\"top:-2.3057em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8043em;\"><span style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2997em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.6897em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8043em;\"><span style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2997em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.994em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span>","enumerator":"1","key":"nBy4zjplAX"},{"type":"math","value":"\\textrm{weighted sum:\\ } \\sum_{i=1}^n w_i x_i","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>weighted sum: </mtext><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\textrm{weighted sum:\\ } \\sum_{i=1}^n w_i x_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.9291em;vertical-align:-1.2777em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">weighted sum: </span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6514em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.2777em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span>","enumerator":"2","key":"sgkZaoENKU"},{"type":"math","value":"\\frac{\\sum_{i=1}^n w_i x_i}{\\sum_{i=1}^n w_i} = \\sum_{i=1}^n w_i x_i \\ \\textrm{if} \\sum_{i=1}^n w_i = 1","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>w</mi><mi>i</mi></msub></mrow></mfrac><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub><mtext> if</mtext><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\frac{\\sum_{i=1}^n w_i x_i}{\\sum_{i=1}^n w_i} = \\sum_{i=1}^n w_i x_i \\ \\textrm{if} \\sum_{i=1}^n w_i = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.488em;vertical-align:-0.994em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.494em;\"><span style=\"top:-2.3057em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8043em;\"><span style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2997em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.6897em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8043em;\"><span style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2997em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.994em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.9291em;vertical-align:-1.2777em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6514em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.2777em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\"> </span><span class=\"mord text\"><span class=\"mord textrm\">if</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6514em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.2777em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span>","enumerator":"3","key":"bLxlQvb7ol"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"However, in practice, this will matter if your data contains ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"L5x89deZyD"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"xegXe4rLaq"},{"type":"text","value":" values. When using a sum with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"nrpWmiPRL6"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"HkKooZscee"},{"type":"text","value":"s, the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"xWEbu0VTh5"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"LUTfDmsRUt"},{"type":"text","value":"s will effectively be treated as zeros, meaning any all ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"LJ8U81JhdL"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Tzv9dvrKgM"},{"type":"text","value":" aggregation will result in a 0 value. For the mean, ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ekSmWt5L7e"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"sfUSA6fv2o"},{"type":"text","value":"s are ignored in the calculation, but all ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"W4dCsLVwo8"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bqhOdjqKVB"},{"type":"text","value":" aggregations will result in a ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"v803MZki9X"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fHYKkhIOgS"},{"type":"text","value":" value being returned. Therefore, the two methods are the same when you have data mixed with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"V2KDJB8sgm"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ZMcnl1t32X"},{"type":"text","value":"s, but if you want all ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"IoqmAwnqDT"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"FlnKouSjyL"},{"type":"text","value":" aggregations to return ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Y9Z7mlgswc"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"v6SLDo9IQK"},{"type":"text","value":" use a ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"qjeVcG9shp"},{"type":"inlineCode","value":"mean","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bBncI8zl3y"},{"type":"text","value":". Otherwise, if you want it to return ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"xUdP8dr283"},{"type":"inlineCode","value":"0","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"KaZl2PK5yX"},{"type":"text","value":", use a ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"SCChqMLEdn"},{"type":"inlineCode","value":"sum","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"yn3m3BPEeF"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"pZIYz9PVG6"}],"key":"n79T29MYJw"}],"key":"TBHxIsRdKa"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Explore the Aggregation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cUKuECTA5L"}],"identifier":"explore-the-aggregation","label":"Explore the Aggregation","html_id":"explore-the-aggregation","implicit":true,"key":"x1e3XQ0I3G"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we have the aggregated data and converted it to dense form, let’s make some plots!","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"S520RWBT7d"}],"key":"r8zT7JdeAc"}],"key":"ylD7RLtgKS"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Mean of Variable by HUC12","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OZrL0ZC4sS"}],"identifier":"mean-of-variable-by-huc12","label":"Mean of Variable by HUC12","html_id":"mean-of-variable-by-huc12","implicit":true,"key":"vRSzMAKwpX"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"First, we will calculate and plot mean value over all time steps for every HU12.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eMbDgDfYzO"}],"key":"Aog9gHHYul"}],"key":"nXx6RI3XUK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"df_mean = huc12_aggregation.mean(dim='time').to_dataframe()\ndf_mean","key":"DUA5fvhus3"},{"type":"outputs","id":"hKlMWjjERCMsyU-V4VjWc","children":[],"key":"KYIingbf06"}],"key":"LNyM8FbZK5"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We need to merge this with the HUC12 basin ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KtoeQfVcas"},{"type":"inlineCode","value":"GeoDataFrame","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zJ1FRjc1zm"},{"type":"text","value":" to get the geometry info.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BP8joeS6dy"}],"key":"nVSmyI07EY"}],"key":"P05pdjytjT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"df_mean = pd.merge(huc12_basins, df_mean, left_on='huc12', right_on='huc12')\ndf_mean.head(3)","key":"zO2g5cd3a9"},{"type":"outputs","id":"G0HMqdigH9Tn7CEshlK1B","children":[],"key":"SV0DtDZ49J"}],"key":"Fa86VCRrcJ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Time to plot our two example variables!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mAf73p6840"}],"key":"GqhLWL50nj"}],"key":"AMV74s1CVO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_plt = df_mean.hvplot(\n    c='T2', geo=True, coastline='50m', cmap='viridis',\n    title='Mean Temperature at 2m [K]', frame_width=300, aspect='equal'\n)\nprecip_plt = df_mean.hvplot(\n    c='PREC_ACC_NC', geo=True, coastline='50m', cmap='viridis',\n    title='Mean 24hr Accumulated Precipitation [mm]', frame_width=300,\n    aspect='equal'\n)\n\ntemp_plt + precip_plt","key":"DGZ5W8FNPZ"},{"type":"outputs","id":"8fjB6MxZh_28ryCTbsD1C","children":[],"key":"WtXPamX146"}],"key":"xP9dYribUw"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Mean Monthly Time Series","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m3yT8p2VMA"}],"identifier":"mean-monthly-time-series","label":"Mean Monthly Time Series","html_id":"mean-monthly-time-series","implicit":true,"key":"GWUfaKN3Zi"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Finally, let’s plot the mean monthly time series for each HUC12.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yMLM4UVgOW"}],"key":"C1WfArIDWP"}],"key":"an8PsLuMLU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"monthly_timeseries = huc12_aggregation.resample(time=\"MS\").mean()\nmonthly_timeseries","key":"yDTeXYQNiS"},{"type":"outputs","id":"E-sKK16xX9pwAt0C415G6","children":[],"key":"uE4Fy2Jld0"}],"key":"rILx5O1SJU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"monthly_timeseries.hvplot(x='time', grid=True)","key":"aOelrQgvwr"},{"type":"outputs","id":"7IYwvNjwZwRbcH_vxkRIb","children":[],"key":"OnH6I9lnY7"}],"key":"Fdk3PgkvTc"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Shut Down the Dask Client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qa1zPCPKew"}],"identifier":"shut-down-the-dask-client","label":"Shut Down the Dask Client","html_id":"shut-down-the-dask-client","implicit":true,"key":"SKMZ5lC3yf"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"If utilized, we should shut down the dask client.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BPxCywsplB"}],"key":"K8qutEGi8m"}],"key":"xM68eeDu2C"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close()","key":"gIVBVrscpI"},{"type":"outputs","id":"_mv0J8sDNFn083lLT3AW1","children":[],"key":"B00dMIcxvD"}],"key":"tuTx4BQzS3"}],"key":"RyQ2mdKiOu"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"gdptools CONUS404 Spatial Aggregation over CONUS-extent HUC12s","url":"/dataset-processing/tutorials/spatial-aggregation/conus404-spatial-aggregation-wbd12","group":"Dataset Processing"},"next":{"title":"gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation","url":"/dataset-processing/tutorials/spatial-aggregation/conus404-spatial-aggregation-comparison","group":"Dataset Processing"}}},"domain":"http://localhost:3005"}