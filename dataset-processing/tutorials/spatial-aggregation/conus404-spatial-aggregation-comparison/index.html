<!DOCTYPE html><html lang="en" class="" style="scroll-padding:60px"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation - HyTEST Project</title><meta property="og:title" content="gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation - HyTEST Project"/><meta name="generator" content="mystmd"/><meta name="keywords" content=""/><link rel="stylesheet" href="/hytest//build/_assets/app-SDGCW62C.css"/><link rel="stylesheet" href="/hytest//build/_assets/thebe-core-VKVHG5VY.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jupyter-matplotlib@0.11.3/css/mpl_widget.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous"/><link rel="icon" href="/hytest//favicon.ico"/><link rel="stylesheet" href="/hytest//myst-theme.css"/><script>
  const savedTheme = localStorage.getItem("myst:theme");
  const theme = window.matchMedia("(prefers-color-scheme: light)").matches ? 'light' : 'dark';
  const classes = document.documentElement.classList;
  const hasAnyTheme = classes.contains('light') || classes.contains('dark');
  if (!hasAnyTheme) classes.add(savedTheme ?? theme);
</script></head><body class="m-0 transition-colors duration-500 bg-white dark:bg-stone-900"><div class="myst-skip-to-article fixed top-1 left-1 h-[0px] w-[0px] focus-within:z-40 focus-within:h-auto focus-within:w-auto bg-white overflow-hidden focus-within:p-2 focus-within:ring-1" aria-label="skip to content options"><a href="#skip-to-frontmatter" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article frontmatter</a><a href="#skip-to-article" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article content</a></div><dialog id="myst-no-css" style="position:fixed;left:0px;top:0px;width:100vw;height:100vh;font-size:4rem;padding:1rem;color:black;background:white"><strong>Site not loading correctly?</strong><p>This may be due to an incorrect <code>BASE_URL</code> configuration. See<!-- --> <a href="https://mystmd.org/guide/deployment#deploy-base-url">the MyST Documentation</a> <!-- -->for reference.</p><script>
    (() => {
            // Test for has-styling variable set by the MyST stylesheet
            const node = document.currentScript.parentNode;
            const hasCSS = window.getComputedStyle(node).getPropertyValue("--has-styling");
            if (hasCSS === ""){
                    node.showModal();
            }

    })()
</script></dialog><div class="myst-top-nav bg-white/80 backdrop-blur dark:bg-stone-900/80 shadow dark:shadow-stone-700 p-3 md:px-8 sticky w-screen top-0 z-30 h-[60px]"><nav class="myst-top-nav-bar flex items-center justify-between flex-nowrap max-w-[1440px] mx-auto"><div class="flex flex-row xl:min-w-[19.5rem] mr-2 sm:mr-7 justify-start items-center shrink-0"><div class="block xl:hidden"><button class="myst-top-nav-menu-button flex items-center border-stone-400 text-stone-800 hover:text-stone-900 dark:text-stone-200 hover:dark:text-stone-100"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" width="2rem" height="2rem" class="m-1"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"></path></svg><span class="sr-only">Open Menu</span></button></div><a class="myst-home-link flex items-center ml-3 dark:text-white w-fit md:ml-5 xl:ml-7" href="/hytest//"><div class="myst-home-link-logo p-1 mr-3 dark:bg-white dark:rounded"><img src="/hytest//build/HyTEST_Badge-349dca1252221dedec720796e00b5d0f.svg" class="h-9" height="2.25rem"/></div><span class="text-md sm:text-xl tracking-tight sm:mr-5 sr-only">Made with MyST</span></a></div><div class="flex items-center flex-grow w-auto"><div class="flex-grow hidden text-md lg:block"></div><div class="flex-grow block"></div><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R75cp:" data-state="closed" class="myst-search-bar flex items-center h-10 aspect-square sm:w-64 text-left text-gray-600 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 myst-search-bar-disabled hover:ring-blue-500 dark:hover:ring-blue-500 hover:border-blue-500 dark:hover:border-blue-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="p-2.5 h-10 w-10 aspect-square"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd"></path></svg><span class="myst-search-text-placeholder hidden sm:block grow">Search</span><div aria-hidden="true" class="myst-search-shortcut items-center hidden mx-1 font-mono text-sm text-gray-600 sm:flex gap-x-1"><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none hide-mac">CTRL</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none show-mac">⌘</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none ">K</kbd><script>
;(() => {
const script = document.currentScript;
const root = script.parentElement;

const isMac = /mac/i.test(
      window.navigator.userAgentData?.platform ?? window.navigator.userAgent,
    );
root.querySelectorAll(".hide-mac").forEach(node => {node.classList.add(isMac ? "hidden" : "block")});
root.querySelectorAll(".show-mac").forEach(node => {node.classList.add(!isMac ? "hidden" : "block")});
})()</script></div></button><button class="myst-theme-button theme rounded-full aspect-square border border-stone-700 dark:border-white hover:bg-neutral-100 border-solid overflow-hidden text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 w-8 h-8 mx-3" title="Toggle theme between light and dark mode" aria-label="Toggle theme between light and dark mode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-moon-icon h-full w-full p-0.5 hidden dark:block"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd"></path></svg><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-sun-icon h-full w-full p-0.5 dark:hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"></path></svg></button><div class="block sm:hidden"></div><div class="hidden sm:block"></div></div></nav></div><div class="myst-primary-sidebar fixed xl:article-grid grid-gap xl:w-screen xl:pointer-events-none overflow-auto max-xl:min-w-[300px] hidden z-10" style="top:60px"><div class="myst-primary-sidebar-pointer pointer-events-auto xl:col-margin-left flex-col overflow-hidden hidden xl:flex"><div class="myst-primary-sidebar-nav flex-grow py-6 overflow-y-auto primary-scrollbar"><nav aria-label="Navigation" class="myst-primary-sidebar-topnav overflow-y-hidden transition-opacity ml-3 xl:ml-0 mr-3 max-w-[350px] lg:hidden"><div class="w-full px-1 dark:text-white font-medium"></div></nav><div class="my-3 border-b-2 lg:hidden"></div><nav aria-label="Table of Contents" class="myst-primary-sidebar-toc flex-grow overflow-y-hidden transition-opacity ml-3 xl:ml-0 mr-3 max-w-[350px]"><div class="myst-toc w-full px-1 dark:text-white"><a title="HyTEST Project" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30 font-bold" href="/hytest//">HyTEST Project</a><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Environment Set-Up" class="block break-words rounded py-2 grow cursor-pointer">Environment Set-Up</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:Rmpsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:Rmpsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Getting Started" class="block break-words rounded py-2 grow cursor-pointer">Getting Started</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:Rupsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:Rupsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Dataset Access" class="block break-words rounded py-2 grow cursor-pointer">Dataset Access</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R16psp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R16psp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Zarr Creation" class="block break-words rounded py-2 grow cursor-pointer">Zarr Creation</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R1epsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R1epsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Dataset Processing" class="block break-words rounded py-2 grow cursor-pointer">Dataset Processing</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R1mpsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R1mpsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Model Evaluation" class="block break-words rounded py-2 grow cursor-pointer">Model Evaluation</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R1upsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R1upsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Back Matter" class="block break-words rounded py-2 grow cursor-pointer">Back Matter</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R26psp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R26psp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div></div></nav></div><div class="myst-primary-sidebar-footer flex-none py-6 transition-all duration-700 translate-y-6 opacity-0"><a class="myst-made-with-myst flex mx-auto text-gray-700 w-fit hover:text-blue-700 dark:text-gray-200 dark:hover:text-blue-400" href="https://mystmd.org/made-with-myst" target="_blank" rel="noreferrer"><svg style="width:24px;height:24px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" stroke="none"><g id="icon"><path fill="currentColor" d="M23.8,54.8v-3.6l4.7-0.8V17.5l-4.7-0.8V13H36l13.4,31.7h0.2l13-31.7h12.6v3.6l-4.7,0.8v32.9l4.7,0.8v3.6h-15
          v-3.6l4.9-0.8V20.8H65L51.4,53.3h-3.8l-14-32.5h-0.1l0.2,17.4v12.1l5,0.8v3.6H23.8z"></path><path fill="#F37726" d="M47,86.9c0-5.9-3.4-8.8-10.1-8.8h-8.4c-5.2,0-9.4-1.3-12.5-3.8c-3.1-2.5-5.4-6.2-6.8-11l4.8-1.6
          c1.8,5.6,6.4,8.6,13.8,8.8h9.2c6.4,0,10.8,2.5,13.1,7.5c2.3-5,6.7-7.5,13.1-7.5h8.4c7.8,0,12.7-2.9,14.6-8.7l4.8,1.6
          c-1.4,4.9-3.6,8.6-6.8,11.1c-3.1,2.5-7.3,3.7-12.4,3.8H63c-6.7,0-10,2.9-10,8.8"></path></g></svg><span class="self-center ml-2 text-sm">Made with MyST</span></a></div></div></div><main class="article-grid grid-gap"><article class="article-grid subgrid-gap col-screen article content"><div class="hidden"></div><div id="skip-to-frontmatter" aria-label="article frontmatter" class="myst-fm-block mb-8 pt-9"><div class="myst-fm-block-header flex items-center mb-5 h-6 text-sm font-light"><div class="flex-grow"></div><div class="myst-fm-block-badges"><a href="https://github.com/hytest-org/hytest" title="GitHub Repository: hytest-org/hytest" target="_blank" rel="noopener noreferrer" class="myst-fm-github-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="myst-fm-github-icon inline-block mr-1 opacity-60 hover:opacity-100"><path d="M12 2.5c-5.4 0-9.8 4.4-9.8 9.7 0 4.3 2.8 8 6.7 9.2.5.1.7-.2.7-.5v-1.8c-2.4.5-3.1-.6-3.3-1.1-.1-.3-.6-1.1-1-1.4-.3-.2-.8-.6 0-.6s1.3.7 1.5 1c.9 1.5 2.3 1.1 2.8.8.1-.6.3-1.1.6-1.3-2.2-.2-4.4-1.1-4.4-4.8 0-1.1.4-1.9 1-2.6-.1-.2-.4-1.2.1-2.6 0 0 .8-.3 2.7 1 .8-.2 1.6-.3 2.4-.3.8 0 1.7.1 2.4.3 1.9-1.3 2.7-1 2.7-1 .5 1.3.2 2.3.1 2.6.6.7 1 1.5 1 2.6 0 3.7-2.3 4.6-4.4 4.8.4.3.7.9.7 1.8V21c0 .3.2.6.7.5 3.9-1.3 6.6-4.9 6.6-9.2 0-5.4-4.4-9.8-9.8-9.8z"></path></svg></a></div><a href="https://github.com/hytest-org/hytest/edit/main/dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_comparison.ipynb" title="Edit This Page" target="_blank" rel="noopener noreferrer" class="myst-fm-edit-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-edit-icon inline-block mr-1 opacity-60 hover:opacity-100"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"></path></svg></a><div class="myst-fm-downloads-dropdown relative flex inline-block mx-1 grow-0" data-headlessui-state=""><button class="myst-fm-downloads-button relative ml-2 -mr-1" id="headlessui-menu-button-:Rs8ucp:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Downloads</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-downloads-icon"><title>Download</title><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg></button></div></div><h1 class="myst-fm-block-title mb-0">gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation</h1></div><div class="block my-10 lg:sticky lg:z-10 lg:h-0 lg:pt-0 lg:my-0 lg:ml-10 lg:col-margin-right" style="top:60px"><nav></nav></div><div id="skip-to-article"></div><div id="nGh9nmCXJy" class="myst-jp-nb-block relative group/block"><p>In this notebook, we will be comparing two spatial aggregation methods to aggregate from grids to polygons. One uses <a target="_blank" rel="noreferrer" href="https://gdptools.readthedocs.io/en/latest/index.html" class=""><code>gdptools</code></a>. The other uses conservative regional methods with <a target="_blank" rel="noreferrer" href="https://docs.xarray.dev/en/stable/index.html" class=""><code>xarray</code></a> and <a target="_blank" rel="noreferrer" href="https://geopandas.org/en/stable/index.html" class=""><code>geopandas</code></a> natively (see this <a target="_blank" rel="noreferrer" href="https://discourse.pangeo.io/t/conservative-region-aggregation-with-xarray-geopandas-and-sparse/2715" class="">Pangeo Discourse</a> for details).</p><p>The goal of this comparision is to see how the results of the two methods compare to help judge the efficacy of one versus the other.</p></div><div id="Jis579PluS" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%xmode minimal
import os
# Needed when boto3 &gt;= 1.36.0 or the rechunking process will fail
# This needs to be set before the boto3 library gets loaded
# See: https://github.com/aws/aws-cli/issues/9214#issuecomment-2606619168
os.environ[&#x27;AWS_REQUEST_CHECKSUM_CALCULATION&#x27;] = &#x27;when_required&#x27;
os.environ[&#x27;AWS_RESPONSE_CHECKSUM_VALIDATION&#x27;] = &#x27;when_required&#x27;
import time
import xarray as xr
import geopandas as gp
import pandas as pd
import numpy as np
import sparse

import hvplot.pandas
import hvplot.xarray
import dask
import cf_xarray

from pynhd import NLDI, WaterData
from pygeohydro import watershed
import cartopy.crs as ccrs
from shapely.geometry import Polygon

import pyproj
from gdptools import WeightGen, AggGen, UserCatData
import pystac
from packaging.version import Version
import zarr</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="NwroHzD5_Q4cvFlaBFvd8" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="WhIzh5LpWw" class="myst-jp-nb-block relative group/block"><h2 id="open-dataset-from-intake-catalog" class="relative group"><span class="heading-text">Open dataset from Intake Catalog</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#open-dataset-from-intake-catalog" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>First, let’s begin by loading the CONUS404 daily data.</p></div><div id="enJNq49hdJ" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">def get_children(catalog, collection_id=None):
    &quot;&quot;&quot;
    This function retrieves a specified collection from a STAC catalog/collection and prints key metadata 
    for exploring/accessing the datasets contained within it.
    If there is no collection ID provided, the collections in the top level of the catalog will be printed.
    If a collection ID is provided, it will retrieve the collection with that ID from the input catalog/collection.
    If the collection ID points to a dataset, it will print the assets available for the dataset.
    If the collection ID points to another collection, it will list the child collections in the IDed collection.

    Args:
        catalog (pystac.Catalog | pystac.Collection): The STAC catalog/collection object.
        collection_id (str): The ID of the collection or dataset to retrieve from catalog.
    
    Returns:
        collection (pystac.Catalog | pystac.Collection): The collection object corresponding to the provided ID
                                                         or the top-level catalog if no ID is provided.
    &quot;&quot;&quot;
    dataset = False
    if collection_id:
        collection = catalog.get_child(collection_id)
        if collection.assets:
            dataset = True
            print(f&quot;{collection_id} is a dataset. Please review the assets below and select one to open.&quot;)

        else:
            print(f&quot;{collection_id} is a collection. Please review the child items and select one to open in the next cell.&quot;)
    else:
        collection = catalog
    if dataset==True:
        # List the assets
        for asset in collection.assets:
            print(f&quot;Asset ID: {asset}&quot;)
            print(f&quot;    Title: {collection.assets[asset].title}&quot;)
            print(f&quot;    Description: {collection.assets[asset].description}&quot;)
    else:
        collections = list(collection.get_collections())
        print(f&quot;Number of collections: {len(collections)}&quot;)
        print(&quot;Collections IDs:&quot;)
        for child_collection in collections:
            id = child_collection.id
            cite_as = &quot;Not available&quot;
            for link in child_collection.links:
                if link.rel == &quot;cite-as&quot;:
                    cite_as = link.target
            print(f&quot;- {id}, Source: {cite_as}&quot;)
    return collection</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="mGoPE2YGlGerPXc0ETMEK" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="G0qJONPE1I" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># url for the WMA STAC Catalog
catalog_url = &quot;https://api.water.usgs.gov/gdp/pygeoapi/stac/stac-collection/&quot;

# use pystac to read the catalog
catalog = pystac.Catalog.from_file(catalog_url)

# list the collections in the catalog
catalog = get_children(catalog)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="MbeTCO-6a5aPG1WGQ5J3w" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="QrI2CFvEQL" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># select a collection from the catalog, replace the collection ID with the one you want to use:
collection = get_children(catalog, collection_id=&quot;conus404&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="N5FeQuwzBRX6r-oNXYV9j" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="XKdAwZNrub" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># select a collection from the catalog, replace the collection ID with the one you want to use:
collection = get_children(collection, collection_id=&quot;conus404_daily&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="vogFwBtqKnHaiWm4Ru7AN" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="hnlBRfEev9" class="myst-jp-nb-block relative group/block"><p>As we can see there are two different locations for the <code>conus404_daily</code> data set. The locations are (1) <code>-hovenweep</code> meaning it is stored on the USGS Hovenweep HPC and (2) <code>-osn</code> meaning the data is on the USGS open storage network (OSN). As the OSN is free to access from any environment, we will use that for this example, but the location can easily be changed depending on your needs.</p></div><div id="FdYDASwcvC" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># replace with the asset ID you want to use:
selected_asset_id = &quot;zarr-s3-osn&quot;

# read the asset metadata
asset = collection.assets[selected_asset_id]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="L53qbPVCZIEnz3HWO__pG" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="yt0MtHKCfu" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># uncomment the lines below to read in your AWS credentials if you want to access data from a requester-pays bucket (-cloud)
# os.environ[&#x27;AWS_PROFILE&#x27;] = &#x27;default&#x27;
# %run ../../../environment_set_up/Help_AWS_Credentials.ipynb</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="gy4SHehNf1f-PGDxk9ZD6" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="p6HLduo9sP" class="myst-jp-nb-block relative group/block"><p>Finally, read in the daily CONUS404 data set and select the accumulated grid scale precipitation. We select the precipitation rather then all variables to keep things simple for this example, but aggregation of other variables would follow the same methodology.</p></div><div id="Mb41KyMDrz" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">if Version(zarr.__version__) &lt; Version(&quot;3.0.0&quot;):
    conus404 = xr.open_dataset(
        asset.href,
        storage_options=asset.extra_fields[&#x27;xarray:storage_options&#x27;],
        **asset.extra_fields[&#x27;xarray:open_kwargs&#x27;]
    )
else:
    conus404 = xr.open_dataset(
    asset.href,
    storage_options=asset.extra_fields[&#x27;xarray:storage_options&#x27;],
    **asset.extra_fields[&#x27;xarray:open_kwargs&#x27;],
    zarr_format=2
    )

# Include the crs as we will need it later
conus404 = conus404[[&#x27;PREC_ACC_NC&#x27;, &#x27;crs&#x27;]]
conus404</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="pjVmClPhaCSj1MOoV6-my" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="oIeXW5mKZl" class="myst-jp-nb-block relative group/block"><h2 id="parallelize-with-dask-optional" class="relative group"><span class="heading-text">Parallelize with Dask (optional)</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#parallelize-with-dask-optional" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Some of the steps we will take are aware of parallel clustered compute environments using <a target="_blank" rel="noreferrer" href="https://www.dask.org/" class=""><code>dask</code></a>. We can start a cluster now so that future steps take advantage
of this ability. This is an optional step, but speed ups data loading significantly, especially when accessing data from the cloud.</p><p>We have documentation on how to start a Dask Cluster in different computing environments <a class="" href="/hytest//environment-set-up/clusters">here</a>. Uncomment the cluster start up that works for your compute environment.</p></div><div id="tqGrXgl5Rq" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%run ../../../environment_set_up/Start_Dask_Cluster_Nebari.ipynb
## If this notebook is not being run on Nebari, replace the above 
## path name with a helper appropriate to your compute environment.  Examples:
# %run ../../../environment_set_up/Start_Dask_Cluster_Denali.ipynb
# %run ../../../environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb
# %run ../../../environment_set_up/Start_Dask_Cluster_Desktop.ipynb</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="K0CTCJenDsYG1OrEbtkw7" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="XQnFiHGdkW" class="myst-jp-nb-block relative group/block"><h2 id="load-the-feature-polygons" class="relative group"><span class="heading-text">Load the Feature Polygons</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#load-the-feature-polygons" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Now that we have read in the CONUS404 data, we need to read in some polygons to aggregate the data. For this example, we will use the HUC12 basins within the Delaware River Basin. To get these HUC12 polygons, we can use <a target="_blank" rel="noreferrer" href="https://docs.hyriver.io/autoapi/pygeohydro/watershed/" class=""><code>pygeohydro.watershed</code></a> to query the Hydro Network Linked Data Index (NLDI). All we need to get the basins is the general IDs of the HUC12 basins. For the Delaware Basin those are ones that start with 020401 or 020402.</p></div><div id="aKxqfEKHPm" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%%time
wbd = watershed.WBD(&quot;huc4&quot;)
delaware_basin = wbd.byids(field=&quot;huc4&quot;, fids=&quot;0204&quot;)
huc12_basins = WaterData(&#x27;wbd12&#x27;).bygeom(delaware_basin.iloc[0].geometry)
huc12_basins = huc12_basins[huc12_basins[&#x27;huc12&#x27;].str.startswith((&#x27;020401&#x27;, &#x27;020402&#x27;))]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="2IWj4QDT0dVSeLpWl_4Gs" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="ttUZ67V7Es" class="myst-jp-nb-block relative group/block"><p>Let’s plot the HUC12 basins to see how they look.</p></div><div id="mmN1e1Xw0z" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">huc12_basins.hvplot(
    c=&#x27;huc12&#x27;, title=&quot;Delaware River HUC12 basins&quot;,
    coastline=&#x27;50m&#x27;, geo=True,
    aspect=&#x27;equal&#x27;, legend=False, frame_width=300
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="sApvCeRfBbiR2-dGEqp2I" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="BcgUQVA2bL" class="myst-jp-nb-block relative group/block"><p>An important thing to note is that all geodataframes should have a coordinate reference system (CRS). Let’s check to make sure our geodataframe has a CRS.</p></div><div id="gUppYUY8Ze" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">huc12_basins.crs</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="DS1JaC9KEGrkJ3RcETUA0" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="sgygDftNig" class="myst-jp-nb-block relative group/block"><h2 id="limit-conus404-spatial-range" class="relative group"><span class="heading-text">Limit CONUS404 Spatial Range</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#limit-conus404-spatial-range" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>With the HUC12 basins read in, we only need the CONUS404 data that spans these polygons as they are the regions we will be aggregating. So, let’s limit the CONUS404 spatial range to that of the basins. This will save on memory and computation. Note doing this is mainly useful when the regions footprint is much smaller than the footprint of the gridded model.</p><p>To limit the spatial range, we first need to convert the CRS of the basins to that of CONUS404. Then extract the bounding box of the basins.</p></div><div id="qOxeu0gkx6" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">huc12_basins_conus404_crs = huc12_basins.to_crs(conus404.crs.crs_wkt)
bbox = huc12_basins_conus404_crs.total_bounds
bbox</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="mKkbjGw4zHYXuqEA40E3S" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="wAMR4gihTn" class="myst-jp-nb-block relative group/block"><p>Then select the CONUS404 data within the bounding box. However, when we do this, we will extend the bounds out by 5% of their range to ensure all of our basins are within the spatially limited data. We do this as the reprojections of the CRS can cause slight distortions that make polygons on the bounds not fall fully within the data.</p></div><div id="FdXGDWisM6" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">bbox_x_range = bbox[2] - bbox[0]
bbox_y_range = bbox[3] - bbox[1]
x_range = slice(bbox[0] - bbox_x_range * 0.05,
                bbox[2] + bbox_x_range * 0.05)
y_range = slice(bbox[1] - bbox_y_range * 0.05,
                bbox[3] + bbox_y_range * 0.05)

conus404 = conus404.sel(x=x_range, y=y_range)
conus404</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="SHtYuru5OCFiTwYbEzhb-" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="niLss3Jkuz" class="myst-jp-nb-block relative group/block"><p>To make sure this worked as intended, let’s plot the full basin over the extracted CONUS404 data.</p></div><div id="PiTdAjD3sV" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Select a single timestamp for simple plotting
timestamp = &#x27;2000-5-02&#x27;
cutout = conus404.sel(time=timestamp).drop_vars([&#x27;lat&#x27;, &#x27;lon&#x27;])
# We need to write the CRS to the CONUS404 dataset and
# reproject for clean plotting with hvplot
cutout = cutout.rio.write_crs(conus404.crs.crs_wkt).rio.reproject(&#x27;EPSG:4326&#x27;)

cutout_plt = cutout.hvplot(
    coastline=&#x27;50m&#x27;, geo=True,
    aspect=&#x27;equal&#x27;, cmap=&#x27;viridis&#x27;, frame_width=300
)
huc12_plt = huc12_basins.hvplot(
    geo=True, alpha=0.3, c=&#x27;r&#x27;
)
cutout_plt * huc12_plt</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="yQivAvzhFgRRSkQ-Ni_NY" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="tBy6wNPKhc" class="myst-jp-nb-block relative group/block"><p>Looks good!</p></div><div id="D91TFL9vS1" class="myst-jp-nb-block relative group/block"><h2 id="aggregate-conus404-to-feature-polygons" class="relative group"><span class="heading-text">Aggregate CONUS404 to Feature Polygons</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#aggregate-conus404-to-feature-polygons" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Now that we have our gridded data and polygons, it is time to aggregate them using <code>gdptools</code> and what we consider the native method that uses <code>geopandas</code> and <code>xarray</code>.</p><p>NOTE: <code>gdptools</code> handles a number of pre-processing steps for the user:</p><ul><li><p>Subsets the gridded data to a buffered bounding box of the targets polygons.</p></li><li><p>Checks latitude bounds and if it’s in the interval 0-360, it’s rotated into -180 - 180.</p></li><li><p>Checks the order of the longitude bounds, i.e. top-to-bottom or bottom-to-top, and autmatically acconts for this is the sub-setting operation above.</p></li></ul></div><div id="MBVubX94vk" class="myst-jp-nb-block relative group/block"><h3 id="gdptools-aggregation" class="relative group"><span class="heading-text">gdptools Aggregation</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#gdptools-aggregation" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>Let’s start by using the gdptools aggregation method, where we use three data classes provided by <code>gdptools</code>, in the order discussed below.</p><ol start="1"><li><p><code>UserCatData</code> stores the data required to perfom the aggregation.</p></li><li><p><code>WeightGen</code> is a class used to generate the areal-weights used to calculate the areal-weighted interpolation. The weights generated between a source and target dataset can be reused as long as the source and target are consistent. For example, If a new time-period became available, or a different set of variables is needed, the same weights can be used.</p></li><li><p><code>AggGen</code> is a class that is used to calculate the aggregation.</p></li></ol><p>The first step to aggregating with <code>gdptools</code> is to convert the input data to a <code>UserCatData</code> class. Note additionally that the <code>var</code> parameter could be a list of variables, such that when the user_data object is used in <code>AggGen</code>, the <code>calculuate_agg()</code> method will perform the aggregation over all the list of variables.</p></div><div id="QSYX1tbrcj" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">user_data = UserCatData(
    ds=conus404,
    proj_ds=conus404.crs.crs_wkt,
    x_coord=&#x27;x&#x27;,
    y_coord=&#x27;y&#x27;,
    t_coord=&#x27;time&#x27;,
    var=&#x27;PREC_ACC_NC&#x27;,
    f_feature=huc12_basins,
    proj_feature=huc12_basins.crs,
    id_feature=&#x27;huc12&#x27;,
    period=[pd.Timestamp(conus404.time.values.min()),
            pd.Timestamp(conus404.time.values.max())],
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="QuvEVo80A2DUQMDQeKula" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="oRWG60epnk" class="myst-jp-nb-block relative group/block"><p>The <code>UserCatData</code> can then be used to generate weights for each polygon. An important thing to note is that when generating the weights we need to use an equal area projection (i.e., equal area CRS).</p></div><div id="b0CENtKpHZ" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">crs_area = &quot;EPSG:6931&quot; # Good for northern hemisphere
# crs_area = &quot;EPSG:5070&quot; # Good for CONUS

# time the weight generation for later comparison
t0 = time.time()

weight_gen = WeightGen(
    user_data=user_data,
    # use serial here vs dask as the dask overhead would cause
    # a slow down since our example is relatively small scale
    method=&quot;serial&quot;,
    weight_gen_crs=crs_area,
)

df_gdptools_weights = weight_gen.calculate_weights()

gdptools_weights_time = time.time() - t0

df_gdptools_weights</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="n2EtcttxO-TBy3K6pBGpV" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="x2WuvdEPEY" class="myst-jp-nb-block relative group/block"><p>With the weights, we can now perform the aggregation.</p><p>Note that the return values of <code>calculate_agg()</code> are:</p><ol start="1"><li><p><code>ngdf</code> the target <code>GeoDataFrame</code>, sorted by <code>id_feature</code> and filtered to only those ids that have weights.
In other words if, there was not complete overlay of the source to target datasets, some target ids will not have values.
If the user wishes to plot the resulting interpolated data, the returned GeoDataFrame’s id order is the same as the <code>gdptools_aggregation</code>.</p></li><li><p><code>gdptools_aggregation</code>, which is an <code>xarray.Dataset</code> containing the interpolated output with dimensions of <code>time</code> and <code>id_feature</code>.
In the case below, the <code>agg_writer</code> parameter is set to <code>&#x27;none&#x27;</code>, it can be set to <code>&#x27;netcdf&#x27;</code>, <code>&#x27;csv&#x27;</code>, or <code>&#x27;parquet&#x27;</code> for archiving the results to a file.</p></li></ol></div><div id="l40QxNeo8J" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">t0 = time.time()

agg_gen = AggGen(
    user_data=user_data,
    # Use masked to ignore NaNs
    # Note that a we use mean vs sum as sum seems to ignore
    # weights even though they should be equivalent methods
    # (i.e., weighted sum = weighted mean)
    stat_method=&quot;masked_mean&quot;,
    agg_engine=&quot;dask&quot;,
    weights=df_gdptools_weights,
    agg_writer=&#x27;none&#x27;,
)
_, gdptools_aggregation = agg_gen.calculate_agg()

gdptools_agg_time = time.time() - t0

gdptools_aggregation</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="q648w2JrL9Ank3m36DeGJ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="d7Ftz8mo92" class="myst-jp-nb-block relative group/block"><p>Let’s make a nice plot of the aggregated HUC12 basins to make sure the aggregation worked as expected.</p></div><div id="lI9CLRTXCA" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># xarray holds the huc12s in sorted order
gdptools_huc12_basins = huc12_basins.copy().sort_values(&#x27;huc12&#x27;)
gdptools_huc12_basins[&#x27;aggregation&#x27;] = gdptools_aggregation.sel(time=timestamp)[&#x27;PREC_ACC_NC&#x27;]

gdptools_plt = gdptools_huc12_basins.hvplot(
    c=&#x27;aggregation&#x27;, title=&quot;Accumulated Precipitation over HUC12 basins&quot;,
    coastline=&#x27;50m&#x27;, geo=True, cmap=&#x27;viridis&#x27;,
    aspect=&#x27;equal&#x27;, legend=False, frame_width=300
)

cutout_plt * gdptools_plt + cutout_plt</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="FgUoKrNS662K9wOLovBGQ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="jUg6gs88IY" class="myst-jp-nb-block relative group/block"><h3 id="native-method" class="relative group"><span class="heading-text">Native Method</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#native-method" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>For the native method, we first need to extract the grid information from our CONUS404 data set. We then use it to create polygon boxes that we overlay with the basin polygons to generate weights. Finally like <code>gdptools</code>, we use the weights to aggregate via a weighted sum.</p><p>To give a fair computational time comparison with <code>gdptools</code>, we will group all steps to generate the weights into one timed cell.</p></div><div id="GYjyKHgtQh" class="myst-jp-nb-block relative group/block"><h4 id="create-weights" class="relative group"><span class="heading-text">Create Weights</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#create-weights" title="Link to this Section" aria-label="Link to this Section">¶</a></h4><p>To generate the weights, we (1) extract grid information (includes extracting the <code>x</code> and <code>y</code> grid and getting their bounds), (2) use these bounds to create polygons of the grid, (3) assign the polygons to a <code>GeoDataFrame</code> with the CONUS404 dataset’s CRS, (4) overlay the grid polygons and basin polygons, (5) use the overlay to get fractional area weights.</p></div><div id="LO8JgHKuOt" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%%time
t0 = time.time()
# (1) extract grid info
grid = conus404[[&#x27;x&#x27;, &#x27;y&#x27;]].drop_vars([&#x27;lat&#x27;, &#x27;lon&#x27;]).reset_coords()
grid = grid.cf.add_bounds([&#x27;x&#x27;, &#x27;y&#x27;])


# (2) create polygons of the grid
# use a simple helper function. This way we can use xarray to parallelize.
def bounds_to_poly(x_bounds, y_bounds):
    return Polygon([
        (x_bounds[0], y_bounds[0]),
        (x_bounds[0], y_bounds[1]),
        (x_bounds[1], y_bounds[1]),
        (x_bounds[1], y_bounds[0])
    ])

# Stack the grid cells into a single stack (i.e., x-y pairs)
points = grid.stack(point=(&#x27;y&#x27;, &#x27;x&#x27;))

# Apply the function to create polygons from bounds
boxes = xr.apply_ufunc(
    bounds_to_poly,
    points.x_bounds,
    points.y_bounds,
    input_core_dims=[(&quot;bounds&quot;,),  (&quot;bounds&quot;,)],
    output_dtypes=[np.dtype(&#x27;O&#x27;)],
    vectorize=True
)


# (3) assign polygons to geodataframe with CRS
grid_polygons = gp.GeoDataFrame(
    data={&quot;geometry&quot;: boxes.values, &quot;y&quot;: boxes[&#x27;y&#x27;], &quot;x&quot;: boxes[&#x27;x&#x27;]},
    index=boxes.indexes[&quot;point&quot;],
    crs=conus404.crs.crs_wkt
)


# (4) overlay the grid polygons with basin polygons
# transform both to an area preserving projection
huc12_basins_area = huc12_basins.to_crs(crs_area)
grid_polygons = grid_polygons.to_crs(crs_area)

# overlay the polygons.
overlay = grid_polygons.overlay(huc12_basins_area, keep_geom_type=True)


# (5)calculate the area fraction for each region
grid_cell_fraction = overlay.geometry.area.groupby(overlay[&#x27;huc12&#x27;]).transform(lambda x: x / x.sum())

# turn this into a series
multi_index = overlay.set_index([&#x27;y&#x27;, &#x27;x&#x27;, &#x27;huc12&#x27;]).index
df_native_weights = pd.Series(grid_cell_fraction.values, index=multi_index)

da_native_weights_stacked = xr.DataArray(df_native_weights)

# unstack to a sparse array.
native_weights = da_native_weights_stacked.unstack(sparse=True, fill_value=0.)

native_weights_time = time.time() - t0

native_weights</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="gbalUoYIbI3exh9VBfhTN" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="IQIjyDECo1" class="myst-jp-nb-block relative group/block"><p>Now that we have our weights, we can clearly see that this is a <strong>sparse</strong> matrix, with a density of ~0.0025 (i.e., only 0.25% of values are non-zero). So, maintaining it as a sparse martix is the right move for memory conservation, especially as this process scales up.</p><p>Also, this process is area conserving. We can verify this for each basin’s area with a simple area calculation.</p></div><div id="bSERKeK8Re" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># calculate areas of HUC12s from overlay and original polygons
overlay_area = overlay.geometry.area.groupby(overlay[&#x27;huc12&#x27;]).sum()
huc12_area = huc12_basins_area.geometry.area.groupby(huc12_basins_area[&#x27;huc12&#x27;]).sum()
# find the max fractional difference
(np.abs(overlay_area - huc12_area) / huc12_area).max()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="4u1NXtz0yo2g_Qq5oAMUM" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="rMGUOFlGyS" class="myst-jp-nb-block relative group/block"><p>Nice! This means the differences can be attributed to machine precision.</p><p>We can also verify that the cell fractions all sum up to one.</p></div><div id="zSpMxTiw5a" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">grid_cell_fraction.groupby(overlay[&#x27;huc12&#x27;]).sum().unique()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="34xMGC9rkdDDEHf_bzhN6" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="wslxlzT5QC" class="myst-jp-nb-block relative group/block"><h4 id="perform-aggregation" class="relative group"><span class="heading-text">Perform Aggregation</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#perform-aggregation" title="Link to this Section" aria-label="Link to this Section">¶</a></h4><p>To aggregate the data, we can use <a target="_blank" rel="noreferrer" href="https://docs.xarray.dev/en/stable/generated/xarray.Dataset.weighted.html" class=""><code>xarray.Dataset.weighted</code></a> to do our weighted calculations. This is simple as it will take a sparse array as weights and compute the aggregation.</p></div><div id="waXrUBHGBO" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%%time
t0 = time.time()

native_aggregation = conus404.drop_vars(&#x27;crs&#x27;).weighted(native_weights).sum(dim=[&#x27;x&#x27;, &#x27;y&#x27;]).compute()

native_agg_time = time.time() - t0

native_aggregation</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="PmE3hAJNNGnXgiDu0N-az" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="TWLDoDHiPh" class="myst-jp-nb-block relative group/block"><p>Like the <code>gdptools</code> aggregation results, let’s make some plots to make sure this worked as expected.</p></div><div id="ZO9n0MuBZ3" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># xarray holds the huc12s in sorted order
native_huc12_basins = huc12_basins.copy().sort_values(&#x27;huc12&#x27;)
native_huc12_basins[&#x27;aggregation&#x27;] = native_aggregation.sel(time=timestamp)[&#x27;PREC_ACC_NC&#x27;].data.todense()
native_plt = native_huc12_basins.hvplot(
    c=&#x27;aggregation&#x27;, title=&quot;Accumulated Precipitation over HUC12 basins&quot;,
    coastline=&#x27;50m&#x27;, geo=True, cmap=&#x27;viridis&#x27;,
    aspect=&#x27;equal&#x27;, legend=False, frame_width=300
)

cutout_plt * native_plt + cutout_plt</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="tHX3kxI4qNziRsN-BK-KB" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="RcoPuWxQrL" class="myst-jp-nb-block relative group/block"><h2 id="compare-the-results" class="relative group"><span class="heading-text">Compare the Results</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#compare-the-results" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>With both aggregation methods complete, we are now ready to compare the results. We can do this both for the final output and the intermediate weights.</p></div><div id="NFxySkNFpG" class="myst-jp-nb-block relative group/block"><h3 id="weight-comparison" class="relative group"><span class="heading-text">Weight Comparison</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#weight-comparison" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>To do the weight comparison, we first need to standardize the weight outputs. This is relatively simple as we just need to convert the <code>gdptools</code> <code>DataFrame</code> weights into an <code>xarray.DataArray</code>. We can do this just like we did for the conservative method, but assigning the <code>x</code> and <code>y</code> values to the <code>gdptools</code> data frame using the given indices.</p></div><div id="OEXhqY71K7" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Due to the buffer region, gdptools weights i index values
# are off by 3 and j are off by 1. This was found from a manual inspection
df_gdptools_weights[&#x27;y&#x27;] = conus404[&#x27;y&#x27;].isel(y=df_gdptools_weights[&#x27;i&#x27;]+3).data
df_gdptools_weights[&#x27;x&#x27;] = conus404[&#x27;x&#x27;].isel(x=df_gdptools_weights[&#x27;j&#x27;]+1).data
gdptool_weights = xr.DataArray(
    df_gdptools_weights.set_index([&#x27;y&#x27;, &#x27;x&#x27;, &#x27;huc12&#x27;])[&#x27;wght&#x27;]
).unstack(sparse=True, fill_value=0)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="lPSyBf3e8z9xu1sbmo4oM" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="yz0Fo5AAuS" class="myst-jp-nb-block relative group/block"><p>Now, a simple max fractional difference is the simple check for how they compare.</p></div><div id="APMchHGe97" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">(np.abs(gdptool_weights - native_weights) / native_weights).max()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="YFEFkKR7FNS3QboIlTLtF" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="GSsrunf2n1" class="myst-jp-nb-block relative group/block"><p>Look at that. They are identical (up to machine precision). So, the only other thing to compare would be the time required for the computation.</p></div><div id="CW5UIw5OcN" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">print(f&#x27;gdptools weights computation time: {gdptools_weights_time:0.3f} seconds&#x27;)
print(f&#x27;native weights computation time: {native_weights_time:0.3f} seconds&#x27;)
print(f&#x27;computation time difference: {(gdptools_weights_time - native_weights_time):0.3f} seconds&#x27;)
print(f&#x27;computation time ratio: {(gdptools_weights_time / native_weights_time):0.3f}&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="iyg95uZPA7XlqnlMf0SPk" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="Anmypjl5gP" class="myst-jp-nb-block relative group/block"><p>So, from this comparison, we can see that both methods give the same weights, but the method using <code>xarray</code> and <code>geopandas</code> slightly faster (and likely not significantly). However, this does not test how well either of the two methods scale.</p></div><div id="MIDEMMWVxX" class="myst-jp-nb-block relative group/block"><h3 id="aggregation-comparison" class="relative group"><span class="heading-text">Aggregation Comparison</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#aggregation-comparison" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>To do the aggregated data comparison, there is no need for any data formatting, as both <code>gdptools</code> and the native method have matching <code>xarray.Dataset</code> formats. So, let’s start with the simple max fractional difference to compare.</p></div><div id="tjaXsYwcfA" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">(np.abs(gdptools_aggregation - native_aggregation) / native_aggregation).max()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="rOsAY8E1_yCI3BTVpsAZE" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="VCbAc6l6Z2" class="myst-jp-nb-block relative group/block"><p>Well, as expected, they are nearly identical, since they had nearly identical weights.</p><p>Let’s plot the fractional difference for a timestamp just to see how they compare.</p></div><div id="XYfRmbt9P0" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># xarray holds the huc12s in sorted order
diff_huc12_basins = huc12_basins.copy().sort_values(&#x27;huc12&#x27;)
diff_huc12_basins[&#x27;aggregation&#x27;] = (np.abs(gdptools_aggregation - native_aggregation) / native_aggregation).sel(time=timestamp)[&#x27;PREC_ACC_NC&#x27;]

diff_huc12_basins.hvplot(
    c=&#x27;aggregation&#x27;, title=&quot;Difference in Precipitation over HUC12 basins&quot;,
    coastline=&#x27;50m&#x27;, geo=True, cmap=&#x27;viridis&#x27;,
    aspect=&#x27;equal&#x27;, legend=False, frame_width=300
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="EZaUQ0OpDUhhenIMSeGJd" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="bbOKyTrPAu" class="myst-jp-nb-block relative group/block"><p>Finally, let’s compare the computational times.</p></div><div id="b1hPDy718z" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">print(f&#x27;gdptools aggregation computation time: {gdptools_agg_time:0.3f} seconds&#x27;)
print(f&#x27;native aggregation computation time: {native_agg_time:0.3f} seconds&#x27;)
print(f&#x27;computation time difference: {(gdptools_agg_time - native_agg_time):0.3f} seconds&#x27;)
print(f&#x27;computation time ratio: {(gdptools_agg_time / native_agg_time):0.3f}&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="gIgn-eDsqbVK38VBde8Tb" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="vnVuN9qRUY" class="myst-jp-nb-block relative group/block"><p>It looks like this step takes about the same time for both. So, let’s compare the total computation time (weights and aggregation).</p></div><div id="nwXGVjLLM8" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">gdptools_total_time = gdptools_weights_time+gdptools_agg_time
native_total_time = native_weights_time + native_agg_time
print(f&#x27;gdptools total computation time: {gdptools_total_time:0.3f} seconds&#x27;)
print(f&#x27;native total computation time: {native_total_time:0.3f} seconds&#x27;)
print(f&#x27;total computation time difference: {(gdptools_total_time - native_total_time):0.3f} seconds&#x27;)
print(f&#x27;total computation time ratio: {(gdptools_total_time / native_total_time):0.3f}&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="rYN75fLSHsi1RlevMOtqc" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="JsgOl6M3If" class="myst-jp-nb-block relative group/block"><p>Alright, since both the aggregation and weights times are about equal, the overall performance of both is equal as well. Therefore, it appears that either method is a solid choice. The only other thing to test would be how well each method scales to larger feature polygons and larger grids. However, we will leave that comparison for another notebook.</p></div><div id="eWeYd1xKgD" class="myst-jp-nb-block relative group/block"><h2 id="shut-down-the-dask-client" class="relative group"><span class="heading-text">Shut down the Dask Client</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#shut-down-the-dask-client" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>If utilized, we should shut down the dask client.</p></div><div id="hGiKKfjBXH" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">client.close()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="k2yIy7ZLwyEca4hgHse4w" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div class="myst-backmatter-parts"></div><div class="myst-footer-links flex pt-10 mb-10 space-x-4"><a class="myst-footer-link flex-1 block p-4 font-normal text-gray-600 no-underline border border-gray-200 rounded shadow-sm group hover:border-blue-600 dark:hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 dark:text-gray-100 dark:border-gray-500 hover:shadow-lg dark:shadow-neutral-700 myst-footer-link-prev" href="/hytest//dataset-processing/tutorials/spatial-aggregation/conus404-spatial-aggregation"><div class="flex h-full align-middle"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem" class="myst-footer-link-icon self-center transition-transform group-hover:-translate-x-1 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path></svg><div class="flex-grow text-right"><div class="myst-footer-link-group text-xs text-gray-500 dark:text-gray-400">Dataset Processing</div>Pangeo CONUS404 Spatial Aggregation over DRB-extent HUC12s</div></div></a><a class="myst-footer-link flex-1 block p-4 font-normal text-gray-600 no-underline border border-gray-200 rounded shadow-sm group hover:border-blue-600 dark:hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 dark:text-gray-100 dark:border-gray-500 hover:shadow-lg dark:shadow-neutral-700 myst-footer-link-next" href="/hytest//dataset-processing/tutorials/conus404-point-selection"><div class="flex h-full align-middle"><div class="flex-grow"><div class="myst-footer-link-group text-xs text-gray-500 dark:text-gray-400">Dataset Processing</div>CONUS404 Site Data Selection</div><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem" class="myst-footer-link-icon self-center transition-transform group-hover:translate-x-1 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3"></path></svg></div></a></div></article></main><script>((a,l)=>{if(!window.history.state||!window.history.state.key){let u=Math.random().toString(32).slice(2);window.history.replaceState({key:u},"")}try{let d=JSON.parse(sessionStorage.getItem(a)||"{}")[l||window.history.state.key];typeof d=="number"&&window.scrollTo(0,d)}catch(u){console.error(u),sessionStorage.removeItem(a)}})("positions", null)</script><link rel="modulepreload" href="/hytest//build/entry.client-PCJPW7TK.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-AQ2CODAG.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-JJXTQVMA.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-OZE3FFNP.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-N76G4W6Y.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-C4DFGG5C.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-J7TUH54J.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-FZ2S7OYD.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-JEM6JXYA.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-34XIY2DH.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-KQM5FBHR.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-OCWQY3HK.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-7HNKBP4B.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-CUKUDK3R.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-3EBOCCHJ.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-O4VQNZ62.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-4OEDG4JQ.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-GUCIBHGO.js"/><link rel="modulepreload" href="/hytest//build/root-AA24SA6C.js"/><link rel="modulepreload" href="/hytest//build/_shared/chunk-AH7OE64W.js"/><link rel="modulepreload" href="/hytest//build/routes/$-5SFLQWPV.js"/><script>window.__remixContext = {"url":"/dataset-processing/tutorials/spatial-aggregation/conus404-spatial-aggregation-comparison","state":{"loaderData":{"root":{"config":{"version":3,"myst":"1.7.0","options":{"logo":"/hytest//build/HyTEST_Badge-349dca1252221dedec720796e00b5d0f.svg","folders":true},"nav":[],"actions":[],"projects":[{"title":"HyTEST Project","github":"https://github.com/hytest-org/hytest","copyright":"2023","toc":[{"file":"doc/About.md"},{"children":[{"children":[{"file":"environment_set_up/QuickStart-General.md"},{"file":"environment_set_up/QuickStart-Cloud-Nebari.md"},{"file":"environment_set_up/OpenOnDemand.md"},{"file":"environment_set_up/JupyterForward.md"},{"file":"environment_set_up/StartScript.md"}],"file":"environment_set_up/README.md"},{"file":"environment_set_up/Help_AWS_Credentials.ipynb"},{"children":[{"file":"environment_set_up/Start_Dask_Cluster_Nebari.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Denali.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Desktop.ipynb"}],"file":"environment_set_up/clusters.md"}],"title":"Environment Set-Up"},{"children":[{"children":[{"file":"essential_reading/ReadingsTutorials.md"}],"file":"essential_reading/README.md"},{"children":[{"file":"essential_reading/DataSources/Data_APIs.md"},{"file":"essential_reading/DataSources/Data_S3.md"}],"file":"essential_reading/DataSources/README.md"},{"file":"essential_reading/Parallel_Dask.ipynb"}],"title":"Getting Started"},{"children":[{"children":[{"file":"dataset_catalog/storage_locations.md"},{"file":"dataset_catalog/STAC.ipynb"},{"file":"dataset_catalog/intake.md"},{"file":"dataset_catalog/subcatalogs/README.md"}],"file":"dataset_catalog/README.md"},{"children":[{"file":"dataset_access/CONUS404_CHANGELOG.md"},{"file":"dataset_access/conus404_explore.ipynb"}],"file":"dataset_access/CONUS404_ACCESS.md"}],"title":"Dataset Access"},{"children":[{"file":"dataset_processing/tutorials/chunking/README.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/101/WhyChunk.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/ExamineDataChunking.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/BasicsShapeSize.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/WriteChunkedFiles.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/Rechunking.ipynb"}],"file":"dataset_processing/tutorials/chunking/101/index.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/201/RechunkingwithDask.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/CreateVirtualZarr.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/IncludeCRSinZarr.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/OptimalChunkSelection.ipynb"}],"file":"dataset_processing/tutorials/chunking/201/index.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/back/Glossary.md"},{"file":"dataset_processing/tutorials/chunking/back/AdditionalResources.md"}],"file":"dataset_processing/tutorials/chunking/back/index.md"}],"title":"Zarr Creation"},{"children":[{"file":"dataset_processing/tutorials/conus404_temporal_aggregation.ipynb"},{"children":[{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_DRB.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_GFv1_1.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_WBD12.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_comparison.ipynb"}],"file":"dataset_processing/spatial_aggregation.md"},{"file":"dataset_processing/tutorials/conus404_point_selection.ipynb"},{"file":"dataset_processing/tutorials/conus404_regrid.ipynb"}],"title":"Dataset Processing"},{"children":[{"children":[{"file":"evaluation/Metrics_DScore_Suite_v1.ipynb"},{"file":"evaluation/tutorials/stats_demos/Usage_DScore_Suite_v1.ipynb"},{"file":"evaluation/Metrics_StdSuite_v1.ipynb"},{"file":"evaluation/tutorials/stats_demos/Usage_StdSuite_v1.ipynb"}],"file":"evaluation/metrics.md"},{"children":[{"file":"evaluation/tutorials/streamflow/01_Data_Prep.ipynb"},{"file":"evaluation/tutorials/streamflow/02_Analysis_StdSuite.ipynb"},{"file":"evaluation/tutorials/streamflow/02_Analysis_DScore.ipynb"},{"file":"evaluation/tutorials/streamflow/03_Vizualization.ipynb"}],"file":"evaluation/tutorials/streamflow/00_Overview.md"}],"title":"Model Evaluation"},{"children":[{"file":"CONTRIBUTING.md"},{"file":"LICENSE.md"}],"title":"Back Matter"}],"exports":[],"bibliography":[],"index":"index","pages":[{"level":1,"title":"Environment Set-Up"},{"slug":"environment-set-up.readme","title":"Compute Environments","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.quickstart-general","title":"General QuickStart","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.quickstart-cloud-nebari","title":"Cloud: Nebari Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.openondemand","title":"HPC Server: Open OnDemand Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.jupyterforward","title":"HPC Server: Jupyter Forward Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.startscript","title":"HPC Server: Start Script Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.help-aws-credentials","title":"AWS Credentials","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.clusters","title":"Starting a Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.start-dask-cluster-nebari","title":"Nebari Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-denali","title":"Denali HPC Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-tallgrass","title":"Hovenweep/Tallgrass HPC Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-desktop","title":"Local Desktop Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Getting Started"},{"slug":"essential-reading.readme","title":"Essential Reading","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"essential-reading.readingstutorials","title":"Foundations","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.datasources.readme","title":"Data Sources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"essential-reading.datasources.data-apis","title":"Data/APIs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.datasources.data-s3","title":"Data/Cloud Storage","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.parallel-dask","title":"Parallelism with Dask","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Dataset Access"},{"slug":"dataset-catalog.readme","title":"Data Catalogs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-catalog.storage-locations","title":"Data Storage Locations","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.stac","title":"Water Mission Area STAC Catalog","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.intake","title":"HyTEST Data Catalog (Intake)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.subcatalogs.readme","title":"HyTEST Intake Sub-Catalogs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-access.conus404-access","title":"CONUS404 Products Data Access","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-access.conus404-changelog","title":"CONUS404 Zarr Changelog","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-access.conus404-explore","title":"Explore CONUS404 Dataset","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Zarr Creation"},{"slug":"dataset-processing.tutorials.chunking.readme","title":"Data Chunking Tutorial Overview","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.101.index","title":"Introduction to Chunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.101.whychunk","title":"Why (re)Chunk Data?","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.examinedatachunking","title":"How to Examine a Stored Dataset’s Chunk Shape","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.basicsshapesize","title":"Basics of Chunk Shape and Size","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.writechunkedfiles","title":"Writing Chunked Files","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.rechunking","title":"Rechunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.index","title":"Advanced Topics in Chunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.201.rechunkingwithdask","title":"Rechunking Larger Datasets with Dask","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.createvirtualzarr","title":"Generating a Virtual Zarr Store","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.includecrsinzarr","title":"Adding Coordinate Reference Systems (CRS) to Zarr Datasets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.optimalchunkselection","title":"Choosing an Optimal Chunk Size and Shape","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.back.index","title":"Chunking References","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.back.glossary","title":"Glossary","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.back.additionalresources","title":"Additional Resources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Dataset Processing"},{"slug":"dataset-processing.tutorials.conus404-temporal-aggregation","title":"CONUS404 Temporal Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.spatial-aggregation","title":"Spatial Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-drb","title":"gdptools CONUS404 Spatial Aggregation over DRB-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-gfv1-1","title":"gdptools CONUS404 Spatial Aggregation over CONUS-extent GFv1.1","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-wbd12","title":"gdptools CONUS404 Spatial Aggregation over CONUS-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation","title":"Pangeo CONUS404 Spatial Aggregation over DRB-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-comparison","title":"gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.conus404-point-selection","title":"CONUS404 Site Data Selection","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.conus404-regrid","title":"CONUS404 Regridding (Curvilinear =\u003e Rectilinear)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Model Evaluation"},{"slug":"evaluation.metrics","title":"Evaluation Metrics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"evaluation.metrics-dscore-suite-v1","title":"D-Score Suite (v1) Benchmark","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.stats-demos.usage-dscore-suite-v1","title":"D-Score Suite (v1) Benchmark -- Usage Examples","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.metrics-stdsuite-v1","title":"Standard Suite (v1) Metrics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.stats-demos.usage-stdsuite-v1","title":"Standard Suite (v1) Metrics -- Usage Examples","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.overview","title":"Streamflow Model Evaluation","description":"","date":"","thumbnail":"/hytest//build/Eval_Overview-29b9b051cf5b081af64c0ddd303c6d0a.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"evaluation.tutorials.streamflow.data-prep","title":"Streamflow Eval :: Data Preparation","description":"","date":"","thumbnail":"/hytest//build/Eval_PreProc-e7e95e0745be409b1f1508ad2e2ff8c5.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.analysis-stdsuite","title":"Streamflow Eval :: StdSuite Analysis","description":"","date":"","thumbnail":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.analysis-dscore","title":"Steamflow Eval :: DScore Analysis","description":"","date":"","thumbnail":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.vizualization","title":"Streamflow Eval :: Visualization","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Back Matter"},{"slug":"contributing","title":"Contributing","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"license","title":"License","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"CONTENT_CDN_PORT":"3100","MODE":"static","BASE_URL":"/hytest/"},"routes/$":{"config":{"version":3,"myst":"1.7.0","options":{"logo":"/hytest//build/HyTEST_Badge-349dca1252221dedec720796e00b5d0f.svg","folders":true},"nav":[],"actions":[],"projects":[{"title":"HyTEST Project","github":"https://github.com/hytest-org/hytest","copyright":"2023","toc":[{"file":"doc/About.md"},{"children":[{"children":[{"file":"environment_set_up/QuickStart-General.md"},{"file":"environment_set_up/QuickStart-Cloud-Nebari.md"},{"file":"environment_set_up/OpenOnDemand.md"},{"file":"environment_set_up/JupyterForward.md"},{"file":"environment_set_up/StartScript.md"}],"file":"environment_set_up/README.md"},{"file":"environment_set_up/Help_AWS_Credentials.ipynb"},{"children":[{"file":"environment_set_up/Start_Dask_Cluster_Nebari.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Denali.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Desktop.ipynb"}],"file":"environment_set_up/clusters.md"}],"title":"Environment Set-Up"},{"children":[{"children":[{"file":"essential_reading/ReadingsTutorials.md"}],"file":"essential_reading/README.md"},{"children":[{"file":"essential_reading/DataSources/Data_APIs.md"},{"file":"essential_reading/DataSources/Data_S3.md"}],"file":"essential_reading/DataSources/README.md"},{"file":"essential_reading/Parallel_Dask.ipynb"}],"title":"Getting Started"},{"children":[{"children":[{"file":"dataset_catalog/storage_locations.md"},{"file":"dataset_catalog/STAC.ipynb"},{"file":"dataset_catalog/intake.md"},{"file":"dataset_catalog/subcatalogs/README.md"}],"file":"dataset_catalog/README.md"},{"children":[{"file":"dataset_access/CONUS404_CHANGELOG.md"},{"file":"dataset_access/conus404_explore.ipynb"}],"file":"dataset_access/CONUS404_ACCESS.md"}],"title":"Dataset Access"},{"children":[{"file":"dataset_processing/tutorials/chunking/README.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/101/WhyChunk.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/ExamineDataChunking.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/BasicsShapeSize.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/WriteChunkedFiles.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/Rechunking.ipynb"}],"file":"dataset_processing/tutorials/chunking/101/index.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/201/RechunkingwithDask.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/CreateVirtualZarr.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/IncludeCRSinZarr.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/OptimalChunkSelection.ipynb"}],"file":"dataset_processing/tutorials/chunking/201/index.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/back/Glossary.md"},{"file":"dataset_processing/tutorials/chunking/back/AdditionalResources.md"}],"file":"dataset_processing/tutorials/chunking/back/index.md"}],"title":"Zarr Creation"},{"children":[{"file":"dataset_processing/tutorials/conus404_temporal_aggregation.ipynb"},{"children":[{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_DRB.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_GFv1_1.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_WBD12.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_comparison.ipynb"}],"file":"dataset_processing/spatial_aggregation.md"},{"file":"dataset_processing/tutorials/conus404_point_selection.ipynb"},{"file":"dataset_processing/tutorials/conus404_regrid.ipynb"}],"title":"Dataset Processing"},{"children":[{"children":[{"file":"evaluation/Metrics_DScore_Suite_v1.ipynb"},{"file":"evaluation/tutorials/stats_demos/Usage_DScore_Suite_v1.ipynb"},{"file":"evaluation/Metrics_StdSuite_v1.ipynb"},{"file":"evaluation/tutorials/stats_demos/Usage_StdSuite_v1.ipynb"}],"file":"evaluation/metrics.md"},{"children":[{"file":"evaluation/tutorials/streamflow/01_Data_Prep.ipynb"},{"file":"evaluation/tutorials/streamflow/02_Analysis_StdSuite.ipynb"},{"file":"evaluation/tutorials/streamflow/02_Analysis_DScore.ipynb"},{"file":"evaluation/tutorials/streamflow/03_Vizualization.ipynb"}],"file":"evaluation/tutorials/streamflow/00_Overview.md"}],"title":"Model Evaluation"},{"children":[{"file":"CONTRIBUTING.md"},{"file":"LICENSE.md"}],"title":"Back Matter"}],"exports":[],"bibliography":[],"index":"index","pages":[{"level":1,"title":"Environment Set-Up"},{"slug":"environment-set-up.readme","title":"Compute Environments","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.quickstart-general","title":"General QuickStart","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.quickstart-cloud-nebari","title":"Cloud: Nebari Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.openondemand","title":"HPC Server: Open OnDemand Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.jupyterforward","title":"HPC Server: Jupyter Forward Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.startscript","title":"HPC Server: Start Script Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.help-aws-credentials","title":"AWS Credentials","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.clusters","title":"Starting a Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.start-dask-cluster-nebari","title":"Nebari Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-denali","title":"Denali HPC Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-tallgrass","title":"Hovenweep/Tallgrass HPC Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-desktop","title":"Local Desktop Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Getting Started"},{"slug":"essential-reading.readme","title":"Essential Reading","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"essential-reading.readingstutorials","title":"Foundations","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.datasources.readme","title":"Data Sources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"essential-reading.datasources.data-apis","title":"Data/APIs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.datasources.data-s3","title":"Data/Cloud Storage","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.parallel-dask","title":"Parallelism with Dask","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Dataset Access"},{"slug":"dataset-catalog.readme","title":"Data Catalogs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-catalog.storage-locations","title":"Data Storage Locations","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.stac","title":"Water Mission Area STAC Catalog","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.intake","title":"HyTEST Data Catalog (Intake)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.subcatalogs.readme","title":"HyTEST Intake Sub-Catalogs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-access.conus404-access","title":"CONUS404 Products Data Access","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-access.conus404-changelog","title":"CONUS404 Zarr Changelog","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-access.conus404-explore","title":"Explore CONUS404 Dataset","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Zarr Creation"},{"slug":"dataset-processing.tutorials.chunking.readme","title":"Data Chunking Tutorial Overview","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.101.index","title":"Introduction to Chunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.101.whychunk","title":"Why (re)Chunk Data?","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.examinedatachunking","title":"How to Examine a Stored Dataset’s Chunk Shape","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.basicsshapesize","title":"Basics of Chunk Shape and Size","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.writechunkedfiles","title":"Writing Chunked Files","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.rechunking","title":"Rechunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.index","title":"Advanced Topics in Chunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.201.rechunkingwithdask","title":"Rechunking Larger Datasets with Dask","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.createvirtualzarr","title":"Generating a Virtual Zarr Store","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.includecrsinzarr","title":"Adding Coordinate Reference Systems (CRS) to Zarr Datasets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.optimalchunkselection","title":"Choosing an Optimal Chunk Size and Shape","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.back.index","title":"Chunking References","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.back.glossary","title":"Glossary","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.back.additionalresources","title":"Additional Resources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Dataset Processing"},{"slug":"dataset-processing.tutorials.conus404-temporal-aggregation","title":"CONUS404 Temporal Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.spatial-aggregation","title":"Spatial Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-drb","title":"gdptools CONUS404 Spatial Aggregation over DRB-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-gfv1-1","title":"gdptools CONUS404 Spatial Aggregation over CONUS-extent GFv1.1","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-wbd12","title":"gdptools CONUS404 Spatial Aggregation over CONUS-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation","title":"Pangeo CONUS404 Spatial Aggregation over DRB-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-comparison","title":"gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.conus404-point-selection","title":"CONUS404 Site Data Selection","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.conus404-regrid","title":"CONUS404 Regridding (Curvilinear =\u003e Rectilinear)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Model Evaluation"},{"slug":"evaluation.metrics","title":"Evaluation Metrics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"evaluation.metrics-dscore-suite-v1","title":"D-Score Suite (v1) Benchmark","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.stats-demos.usage-dscore-suite-v1","title":"D-Score Suite (v1) Benchmark -- Usage Examples","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.metrics-stdsuite-v1","title":"Standard Suite (v1) Metrics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.stats-demos.usage-stdsuite-v1","title":"Standard Suite (v1) Metrics -- Usage Examples","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.overview","title":"Streamflow Model Evaluation","description":"","date":"","thumbnail":"/hytest//build/Eval_Overview-29b9b051cf5b081af64c0ddd303c6d0a.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"evaluation.tutorials.streamflow.data-prep","title":"Streamflow Eval :: Data Preparation","description":"","date":"","thumbnail":"/hytest//build/Eval_PreProc-e7e95e0745be409b1f1508ad2e2ff8c5.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.analysis-stdsuite","title":"Streamflow Eval :: StdSuite Analysis","description":"","date":"","thumbnail":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.analysis-dscore","title":"Steamflow Eval :: DScore Analysis","description":"","date":"","thumbnail":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.vizualization","title":"Streamflow Eval :: Visualization","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Back Matter"},{"slug":"contributing","title":"Contributing","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"license","title":"License","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"page":{"version":3,"kind":"Notebook","sha256":"72949e8c8b339c2b11b1ed3c00f1a70c710419592e35929ccc6aef85c8c0e2d5","slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-comparison","location":"/dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_comparison.ipynb","dependencies":[],"frontmatter":{"title":"gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":2}},"source_url":"https://github.com/hytest-org/hytest/blob/main/dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_comparison.ipynb","edit_url":"https://github.com/hytest-org/hytest/edit/main/dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_comparison.ipynb","exports":[{"format":"ipynb","filename":"conus404_spatial_aggregation_comparison.ipynb","url":"/hytest//build/conus404_spatial_agg-535cce9f4f0fe582c96699203d5478ab.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this notebook, we will be comparing two spatial aggregation methods to aggregate from grids to polygons. One uses ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zkHegmX5Rl"},{"type":"link","url":"https://gdptools.readthedocs.io/en/latest/index.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"gdptools","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yevSfo6LLy"}],"urlSource":"https://gdptools.readthedocs.io/en/latest/index.html","key":"IG5aKBkTFT"},{"type":"text","value":". The other uses conservative regional methods with ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IcVvGLIvUY"},{"type":"link","url":"https://docs.xarray.dev/en/stable/index.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"xarray","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"k1zS38ELhF"}],"urlSource":"https://docs.xarray.dev/en/stable/index.html","key":"Gb91GfEJu1"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZR4BdjKu2T"},{"type":"link","url":"https://geopandas.org/en/stable/index.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"geopandas","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YVBKlQTSfl"}],"urlSource":"https://geopandas.org/en/stable/index.html","key":"TqhYhkvMG4"},{"type":"text","value":" natively (see this ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yC705RqkRm"},{"type":"link","url":"https://discourse.pangeo.io/t/conservative-region-aggregation-with-xarray-geopandas-and-sparse/2715","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Pangeo Discourse","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KDrKbUBGyn"}],"urlSource":"https://discourse.pangeo.io/t/conservative-region-aggregation-with-xarray-geopandas-and-sparse/2715","key":"cMP8QyeOMG"},{"type":"text","value":" for details).","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OuAWeFyCR6"}],"key":"Chv0P857cc"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The goal of this comparision is to see how the results of the two methods compare to help judge the efficacy of one versus the other.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"AxhgbfcOSQ"}],"key":"KAdUtpyhN4"}],"visibility":"show","key":"nGh9nmCXJy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%xmode minimal\nimport os\n# Needed when boto3 \u003e= 1.36.0 or the rechunking process will fail\n# This needs to be set before the boto3 library gets loaded\n# See: https://github.com/aws/aws-cli/issues/9214#issuecomment-2606619168\nos.environ['AWS_REQUEST_CHECKSUM_CALCULATION'] = 'when_required'\nos.environ['AWS_RESPONSE_CHECKSUM_VALIDATION'] = 'when_required'\nimport time\nimport xarray as xr\nimport geopandas as gp\nimport pandas as pd\nimport numpy as np\nimport sparse\n\nimport hvplot.pandas\nimport hvplot.xarray\nimport dask\nimport cf_xarray\n\nfrom pynhd import NLDI, WaterData\nfrom pygeohydro import watershed\nimport cartopy.crs as ccrs\nfrom shapely.geometry import Polygon\n\nimport pyproj\nfrom gdptools import WeightGen, AggGen, UserCatData\nimport pystac\nfrom packaging.version import Version\nimport zarr","key":"RL0b7qGctl"},{"type":"outputs","id":"NwroHzD5_Q4cvFlaBFvd8","children":[],"key":"dmLe5lrb4h"}],"key":"Jis579PluS"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Open dataset from Intake Catalog","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PrLj9YlokI"}],"identifier":"open-dataset-from-intake-catalog","label":"Open dataset from Intake Catalog","html_id":"open-dataset-from-intake-catalog","implicit":true,"key":"XfQyxHLair"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"First, let’s begin by loading the CONUS404 daily data.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dyJomhIUJQ"}],"key":"bAQCeiUrXu"}],"key":"WhIzh5LpWw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_children(catalog, collection_id=None):\n    \"\"\"\n    This function retrieves a specified collection from a STAC catalog/collection and prints key metadata \n    for exploring/accessing the datasets contained within it.\n    If there is no collection ID provided, the collections in the top level of the catalog will be printed.\n    If a collection ID is provided, it will retrieve the collection with that ID from the input catalog/collection.\n    If the collection ID points to a dataset, it will print the assets available for the dataset.\n    If the collection ID points to another collection, it will list the child collections in the IDed collection.\n\n    Args:\n        catalog (pystac.Catalog | pystac.Collection): The STAC catalog/collection object.\n        collection_id (str): The ID of the collection or dataset to retrieve from catalog.\n    \n    Returns:\n        collection (pystac.Catalog | pystac.Collection): The collection object corresponding to the provided ID\n                                                         or the top-level catalog if no ID is provided.\n    \"\"\"\n    dataset = False\n    if collection_id:\n        collection = catalog.get_child(collection_id)\n        if collection.assets:\n            dataset = True\n            print(f\"{collection_id} is a dataset. Please review the assets below and select one to open.\")\n\n        else:\n            print(f\"{collection_id} is a collection. Please review the child items and select one to open in the next cell.\")\n    else:\n        collection = catalog\n    if dataset==True:\n        # List the assets\n        for asset in collection.assets:\n            print(f\"Asset ID: {asset}\")\n            print(f\"    Title: {collection.assets[asset].title}\")\n            print(f\"    Description: {collection.assets[asset].description}\")\n    else:\n        collections = list(collection.get_collections())\n        print(f\"Number of collections: {len(collections)}\")\n        print(\"Collections IDs:\")\n        for child_collection in collections:\n            id = child_collection.id\n            cite_as = \"Not available\"\n            for link in child_collection.links:\n                if link.rel == \"cite-as\":\n                    cite_as = link.target\n            print(f\"- {id}, Source: {cite_as}\")\n    return collection","key":"rJo5Z6Rai3"},{"type":"outputs","id":"mGoPE2YGlGerPXc0ETMEK","children":[],"key":"ICH4BVmShT"}],"key":"enJNq49hdJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# url for the WMA STAC Catalog\ncatalog_url = \"https://api.water.usgs.gov/gdp/pygeoapi/stac/stac-collection/\"\n\n# use pystac to read the catalog\ncatalog = pystac.Catalog.from_file(catalog_url)\n\n# list the collections in the catalog\ncatalog = get_children(catalog)","key":"RTGKFqM2Kg"},{"type":"outputs","id":"MbeTCO-6a5aPG1WGQ5J3w","children":[],"key":"ECqZVC5FGQ"}],"key":"G0qJONPE1I"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(catalog, collection_id=\"conus404\")","key":"zqPxZxSOHU"},{"type":"outputs","id":"N5FeQuwzBRX6r-oNXYV9j","children":[],"key":"r1VyOqgGIG"}],"key":"QrI2CFvEQL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# select a collection from the catalog, replace the collection ID with the one you want to use:\ncollection = get_children(collection, collection_id=\"conus404_daily\")","key":"R2UBEAEG8K"},{"type":"outputs","id":"vogFwBtqKnHaiWm4Ru7AN","children":[],"key":"qqDWfRjgHj"}],"key":"XKdAwZNrub"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"As we can see there are two different locations for the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bPbqhfSYV3"},{"type":"inlineCode","value":"conus404_daily","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CVMh22EHMy"},{"type":"text","value":" data set. The locations are (1) ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x9dblz71vp"},{"type":"inlineCode","value":"-hovenweep","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"i6PhlPuwSC"},{"type":"text","value":" meaning it is stored on the USGS Hovenweep HPC and (2) ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZBND4kePyr"},{"type":"inlineCode","value":"-osn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BCBRVgQxIM"},{"type":"text","value":" meaning the data is on the USGS open storage network (OSN). As the OSN is free to access from any environment, we will use that for this example, but the location can easily be changed depending on your needs.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HVm2llAi9r"}],"key":"tchlHKeA7W"}],"key":"hnlBRfEev9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# replace with the asset ID you want to use:\nselected_asset_id = \"zarr-s3-osn\"\n\n# read the asset metadata\nasset = collection.assets[selected_asset_id]","key":"IP9eT2oTfg"},{"type":"outputs","id":"L53qbPVCZIEnz3HWO__pG","children":[],"key":"liAP6pY8Gx"}],"key":"FdYDASwcvC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# uncomment the lines below to read in your AWS credentials if you want to access data from a requester-pays bucket (-cloud)\n# os.environ['AWS_PROFILE'] = 'default'\n# %run ../../../environment_set_up/Help_AWS_Credentials.ipynb","key":"G25oUrO3cG"},{"type":"outputs","id":"gy4SHehNf1f-PGDxk9ZD6","children":[],"key":"JbJ9v0PQHX"}],"key":"yt0MtHKCfu"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Finally, read in the daily CONUS404 data set and select the accumulated grid scale precipitation. We select the precipitation rather then all variables to keep things simple for this example, but aggregation of other variables would follow the same methodology.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FIBnjureLH"}],"key":"UXLPsfkVDg"}],"key":"p6HLduo9sP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if Version(zarr.__version__) \u003c Version(\"3.0.0\"):\n    conus404 = xr.open_dataset(\n        asset.href,\n        storage_options=asset.extra_fields['xarray:storage_options'],\n        **asset.extra_fields['xarray:open_kwargs']\n    )\nelse:\n    conus404 = xr.open_dataset(\n    asset.href,\n    storage_options=asset.extra_fields['xarray:storage_options'],\n    **asset.extra_fields['xarray:open_kwargs'],\n    zarr_format=2\n    )\n\n# Include the crs as we will need it later\nconus404 = conus404[['PREC_ACC_NC', 'crs']]\nconus404","key":"TlAZV55EAn"},{"type":"outputs","id":"pjVmClPhaCSj1MOoV6-my","children":[],"key":"DuMVKpaJMm"}],"key":"Mb41KyMDrz"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Parallelize with Dask (optional)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GCUTFnPc0c"}],"identifier":"parallelize-with-dask-optional","label":"Parallelize with Dask (optional)","html_id":"parallelize-with-dask-optional","implicit":true,"key":"jZXc50UyTQ"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Some of the steps we will take are aware of parallel clustered compute environments using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FcHfrZlka1"},{"type":"link","url":"https://www.dask.org/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FLEO3EqP5z"}],"urlSource":"https://www.dask.org/","key":"RmJPPbhLCt"},{"type":"text","value":". We can start a cluster now so that future steps take advantage\nof this ability. This is an optional step, but speed ups data loading significantly, especially when accessing data from the cloud.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oEHqs9qfok"}],"key":"EgehL4Gs9S"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"We have documentation on how to start a Dask Cluster in different computing environments ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"WlMajjNEhI"},{"type":"link","url":"/environment-set-up/clusters","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"CJyqcgerkn"}],"urlSource":"../../../environment_set_up/clusters.md","dataUrl":"/environment-set-up.clusters.json","internal":true,"protocol":"file","key":"MfwMQ5vzqu"},{"type":"text","value":". Uncomment the cluster start up that works for your compute environment.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"XG1ZIJwVEL"}],"key":"ZTRdvqBsps"}],"key":"oIeXW5mKZl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%run ../../../environment_set_up/Start_Dask_Cluster_Nebari.ipynb\n## If this notebook is not being run on Nebari, replace the above \n## path name with a helper appropriate to your compute environment.  Examples:\n# %run ../../../environment_set_up/Start_Dask_Cluster_Denali.ipynb\n# %run ../../../environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb\n# %run ../../../environment_set_up/Start_Dask_Cluster_Desktop.ipynb","key":"dMvsT6I9MC"},{"type":"outputs","id":"K0CTCJenDsYG1OrEbtkw7","children":[],"key":"af9R3vccXP"}],"key":"tqGrXgl5Rq"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load the Feature Polygons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uiabNKhbzV"}],"identifier":"load-the-feature-polygons","label":"Load the Feature Polygons","html_id":"load-the-feature-polygons","implicit":true,"key":"aQxytOEcBY"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we have read in the CONUS404 data, we need to read in some polygons to aggregate the data. For this example, we will use the HUC12 basins within the Delaware River Basin. To get these HUC12 polygons, we can use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"md0eKfWBxv"},{"type":"link","url":"https://docs.hyriver.io/autoapi/pygeohydro/watershed/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"pygeohydro.watershed","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KrzgKCIjiM"}],"urlSource":"https://docs.hyriver.io/autoapi/pygeohydro/watershed/","key":"Nj5IY3jXIN"},{"type":"text","value":" to query the Hydro Network Linked Data Index (NLDI). All we need to get the basins is the general IDs of the HUC12 basins. For the Delaware Basin those are ones that start with 020401 or 020402.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aulk2OYzEq"}],"key":"cLRBwSJQvT"}],"key":"XQnFiHGdkW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nwbd = watershed.WBD(\"huc4\")\ndelaware_basin = wbd.byids(field=\"huc4\", fids=\"0204\")\nhuc12_basins = WaterData('wbd12').bygeom(delaware_basin.iloc[0].geometry)\nhuc12_basins = huc12_basins[huc12_basins['huc12'].str.startswith(('020401', '020402'))]","key":"PzvNZs8y4T"},{"type":"outputs","id":"2IWj4QDT0dVSeLpWl_4Gs","children":[],"key":"WbHctqDUJw"}],"key":"aKxqfEKHPm"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s plot the HUC12 basins to see how they look.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u4pgniIB3c"}],"key":"WfFpLJzSLT"}],"key":"ttUZ67V7Es"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"huc12_basins.hvplot(\n    c='huc12', title=\"Delaware River HUC12 basins\",\n    coastline='50m', geo=True,\n    aspect='equal', legend=False, frame_width=300\n)","key":"z6ZJMyW9kL"},{"type":"outputs","id":"sApvCeRfBbiR2-dGEqp2I","children":[],"key":"oWkujTis7i"}],"key":"mmN1e1Xw0z"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"An important thing to note is that all geodataframes should have a coordinate reference system (CRS). Let’s check to make sure our geodataframe has a CRS.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"h7pklkK8sy"}],"key":"hN5vgsBt1N"}],"key":"BcgUQVA2bL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"huc12_basins.crs","key":"WfuDQAtMU9"},{"type":"outputs","id":"DS1JaC9KEGrkJ3RcETUA0","children":[],"key":"YClt1ScEfV"}],"key":"gUppYUY8Ze"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Limit CONUS404 Spatial Range","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gw1ZFOyt0j"}],"identifier":"limit-conus404-spatial-range","label":"Limit CONUS404 Spatial Range","html_id":"limit-conus404-spatial-range","implicit":true,"key":"TDyzuW3zoz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"With the HUC12 basins read in, we only need the CONUS404 data that spans these polygons as they are the regions we will be aggregating. So, let’s limit the CONUS404 spatial range to that of the basins. This will save on memory and computation. Note doing this is mainly useful when the regions footprint is much smaller than the footprint of the gridded model.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HSMEbER0fF"}],"key":"V2r8afQC1U"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To limit the spatial range, we first need to convert the CRS of the basins to that of CONUS404. Then extract the bounding box of the basins.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"lMVeuzyFjH"}],"key":"Pk7HnqdLQl"}],"key":"sgygDftNig"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"huc12_basins_conus404_crs = huc12_basins.to_crs(conus404.crs.crs_wkt)\nbbox = huc12_basins_conus404_crs.total_bounds\nbbox","key":"s875Ry6G7P"},{"type":"outputs","id":"mKkbjGw4zHYXuqEA40E3S","children":[],"key":"AI9beb2X27"}],"key":"qOxeu0gkx6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Then select the CONUS404 data within the bounding box. However, when we do this, we will extend the bounds out by 5% of their range to ensure all of our basins are within the spatially limited data. We do this as the reprojections of the CRS can cause slight distortions that make polygons on the bounds not fall fully within the data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YJHHMMqvqP"}],"key":"jzIlTVwEA0"}],"key":"wAMR4gihTn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"bbox_x_range = bbox[2] - bbox[0]\nbbox_y_range = bbox[3] - bbox[1]\nx_range = slice(bbox[0] - bbox_x_range * 0.05,\n                bbox[2] + bbox_x_range * 0.05)\ny_range = slice(bbox[1] - bbox_y_range * 0.05,\n                bbox[3] + bbox_y_range * 0.05)\n\nconus404 = conus404.sel(x=x_range, y=y_range)\nconus404","key":"JWysKS0eTM"},{"type":"outputs","id":"SHtYuru5OCFiTwYbEzhb-","children":[],"key":"SS23ZRFsUV"}],"key":"FdXGDWisM6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To make sure this worked as intended, let’s plot the full basin over the extracted CONUS404 data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bPYbfNvPm4"}],"key":"ji7Jl3xQxb"}],"key":"niLss3Jkuz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Select a single timestamp for simple plotting\ntimestamp = '2000-5-02'\ncutout = conus404.sel(time=timestamp).drop_vars(['lat', 'lon'])\n# We need to write the CRS to the CONUS404 dataset and\n# reproject for clean plotting with hvplot\ncutout = cutout.rio.write_crs(conus404.crs.crs_wkt).rio.reproject('EPSG:4326')\n\ncutout_plt = cutout.hvplot(\n    coastline='50m', geo=True,\n    aspect='equal', cmap='viridis', frame_width=300\n)\nhuc12_plt = huc12_basins.hvplot(\n    geo=True, alpha=0.3, c='r'\n)\ncutout_plt * huc12_plt","key":"wEBa4Ibnsp"},{"type":"outputs","id":"yQivAvzhFgRRSkQ-Ni_NY","children":[],"key":"IljLSIaLit"}],"key":"PiTdAjD3sV"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Looks good!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LKGFb7lTbv"}],"key":"sGhf1VViIJ"}],"key":"tBy6wNPKhc"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Aggregate CONUS404 to Feature Polygons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ckIJdAcP8A"}],"identifier":"aggregate-conus404-to-feature-polygons","label":"Aggregate CONUS404 to Feature Polygons","html_id":"aggregate-conus404-to-feature-polygons","implicit":true,"key":"NzNyEdeMY5"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we have our gridded data and polygons, it is time to aggregate them using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CzQphgMdoG"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aVHTUf8MEU"},{"type":"text","value":" and what we consider the native method that uses ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mAwqUWkoht"},{"type":"inlineCode","value":"geopandas","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wctFa3RHo0"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kTxqHvk8uQ"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wVyEv4paxk"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZJAbcDbL2P"}],"key":"mV96YjwY0K"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"NOTE: ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"v2ScqyiyLy"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"P441OJgmkn"},{"type":"text","value":" handles a number of pre-processing steps for the user:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SNayP3Eoej"}],"key":"BkMRBbrYFq"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Subsets the gridded data to a buffered bounding box of the targets polygons.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bhTIbkhcg6"}],"key":"JEzyX64Fer"}],"key":"ZmxugGINt2"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Checks latitude bounds and if it’s in the interval 0-360, it’s rotated into -180 - 180.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"iFB9E4CgX9"}],"key":"gqcDm01Y6c"}],"key":"h6pnW7UO7Z"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Checks the order of the longitude bounds, i.e. top-to-bottom or bottom-to-top, and autmatically acconts for this is the sub-setting operation above.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"lDV4Yfaqbs"}],"key":"u54ngOj8S7"}],"key":"wM8l22bKF2"}],"key":"TBEeM3Afup"}],"key":"D91TFL9vS1"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"gdptools Aggregation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f9F2OKlYRl"}],"identifier":"gdptools-aggregation","label":"gdptools Aggregation","html_id":"gdptools-aggregation","implicit":true,"key":"y3kqyIlMgR"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Let’s start by using the gdptools aggregation method, where we use three data classes provided by ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pFtz6sE9rB"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FyNRLhioAK"},{"type":"text","value":", in the order discussed below.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"h1JqeR8iYf"}],"key":"tHqj6sTRgP"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"UserCatData","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QjL4RT1aJa"},{"type":"text","value":" stores the data required to perfom the aggregation.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"oZfgJAZOaM"}],"key":"Aomw6EZQFY"}],"key":"Di79UncZos"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"WeightGen","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"lAmOG5sCwW"},{"type":"text","value":" is a class used to generate the areal-weights used to calculate the areal-weighted interpolation. The weights generated between a source and target dataset can be reused as long as the source and target are consistent. For example, If a new time-period became available, or a different set of variables is needed, the same weights can be used.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"XrjTNNvrCP"}],"key":"IIQzpluQxd"}],"key":"g938xMsmA8"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"AggGen","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"mXU35Q51WR"},{"type":"text","value":" is a class that is used to calculate the aggregation.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jJigprAkPi"}],"key":"Ki5mIvCt9f"}],"key":"IbGwUXpxIS"}],"key":"zsx7AsCk9h"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"The first step to aggregating with ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"QVHqIu2nka"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"WSHS0RkgL9"},{"type":"text","value":" is to convert the input data to a ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"zy3icPSmQQ"},{"type":"inlineCode","value":"UserCatData","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"oGJlF1L28P"},{"type":"text","value":" class. Note additionally that the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"I063Uxx9a4"},{"type":"inlineCode","value":"var","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"eeV3b9769N"},{"type":"text","value":" parameter could be a list of variables, such that when the user_data object is used in ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"OhT9WyPy9g"},{"type":"inlineCode","value":"AggGen","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"BVzgpooeyc"},{"type":"text","value":", the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"c1b8jnIGdk"},{"type":"inlineCode","value":"calculuate_agg()","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"bmntU7Ib3J"},{"type":"text","value":" method will perform the aggregation over all the list of variables.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"RSAZWv8lHf"}],"key":"GLJwRo8pCL"}],"key":"MBVubX94vk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"user_data = UserCatData(\n    ds=conus404,\n    proj_ds=conus404.crs.crs_wkt,\n    x_coord='x',\n    y_coord='y',\n    t_coord='time',\n    var='PREC_ACC_NC',\n    f_feature=huc12_basins,\n    proj_feature=huc12_basins.crs,\n    id_feature='huc12',\n    period=[pd.Timestamp(conus404.time.values.min()),\n            pd.Timestamp(conus404.time.values.max())],\n)","key":"HkZf2xmxoL"},{"type":"outputs","id":"QuvEVo80A2DUQMDQeKula","children":[],"key":"uunjGRM9Sd"}],"key":"QSYX1tbrcj"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tT8laNERru"},{"type":"inlineCode","value":"UserCatData","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"n9nZFw3IDN"},{"type":"text","value":" can then be used to generate weights for each polygon. An important thing to note is that when generating the weights we need to use an equal area projection (i.e., equal area CRS).","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vzFKgkQmCM"}],"key":"JQNu80sNUd"}],"key":"oRWG60epnk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"crs_area = \"EPSG:6931\" # Good for northern hemisphere\n# crs_area = \"EPSG:5070\" # Good for CONUS\n\n# time the weight generation for later comparison\nt0 = time.time()\n\nweight_gen = WeightGen(\n    user_data=user_data,\n    # use serial here vs dask as the dask overhead would cause\n    # a slow down since our example is relatively small scale\n    method=\"serial\",\n    weight_gen_crs=crs_area,\n)\n\ndf_gdptools_weights = weight_gen.calculate_weights()\n\ngdptools_weights_time = time.time() - t0\n\ndf_gdptools_weights","key":"lkPPOhquGn"},{"type":"outputs","id":"n2EtcttxO-TBy3K6pBGpV","children":[],"key":"JNukLmbDSC"}],"key":"b0CENtKpHZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"With the weights, we can now perform the aggregation.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tcKosPO5bq"}],"key":"NAbF060Yev"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Note that the return values of ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aZSWKq1MCi"},{"type":"inlineCode","value":"calculate_agg()","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HGo6Fll12L"},{"type":"text","value":" are:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pLh63DFy6B"}],"key":"kVZYgajzlR"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"ngdf","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"B7wG3J3VFH"},{"type":"text","value":" the target ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"HV3sqKEISj"},{"type":"inlineCode","value":"GeoDataFrame","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"B1dBPGcYxC"},{"type":"text","value":", sorted by ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ReMTd5tbqx"},{"type":"inlineCode","value":"id_feature","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"d6sB2XxEwN"},{"type":"text","value":" and filtered to only those ids that have weights.\nIn other words if, there was not complete overlay of the source to target datasets, some target ids will not have values.\nIf the user wishes to plot the resulting interpolated data, the returned GeoDataFrame’s id order is the same as the ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"STQSI8cHDK"},{"type":"inlineCode","value":"gdptools_aggregation","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"zzKlOhh8a9"},{"type":"text","value":".","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"H6coOrGT0O"}],"key":"qsvtUxUbwM"}],"key":"gHV7yFb2Yh"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"gdptools_aggregation","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"nqxydAfnVR"},{"type":"text","value":", which is an ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"YD73LlPHHK"},{"type":"inlineCode","value":"xarray.Dataset","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"kZbd6nCnqL"},{"type":"text","value":" containing the interpolated output with dimensions of ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"N5jzPKG6y6"},{"type":"inlineCode","value":"time","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"BolPdKDcIM"},{"type":"text","value":" and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ZtBCgCzhjt"},{"type":"inlineCode","value":"id_feature","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"SYDYmU04W8"},{"type":"text","value":".\nIn the case below, the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ezkCPufwzF"},{"type":"inlineCode","value":"agg_writer","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"PDfpW5kb0m"},{"type":"text","value":" parameter is set to ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"H6C99Ew9gV"},{"type":"inlineCode","value":"'none'","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"okP0NV6Yav"},{"type":"text","value":", it can be set to ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Ylx2hpgw7a"},{"type":"inlineCode","value":"'netcdf'","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"dp1q4NxtA9"},{"type":"text","value":", ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"wJJHySAwsn"},{"type":"inlineCode","value":"'csv'","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"j4YpB02QzB"},{"type":"text","value":", or ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ggqmh4aJia"},{"type":"inlineCode","value":"'parquet'","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"GnYPIl881j"},{"type":"text","value":" for archiving the results to a file.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"drVyy9gbM0"}],"key":"XHORzOnqeE"}],"key":"nQAMVKzMMS"}],"key":"fD10riUyOb"}],"key":"x2WuvdEPEY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t0 = time.time()\n\nagg_gen = AggGen(\n    user_data=user_data,\n    # Use masked to ignore NaNs\n    # Note that a we use mean vs sum as sum seems to ignore\n    # weights even though they should be equivalent methods\n    # (i.e., weighted sum = weighted mean)\n    stat_method=\"masked_mean\",\n    agg_engine=\"dask\",\n    weights=df_gdptools_weights,\n    agg_writer='none',\n)\n_, gdptools_aggregation = agg_gen.calculate_agg()\n\ngdptools_agg_time = time.time() - t0\n\ngdptools_aggregation","key":"HiwhxLLtFw"},{"type":"outputs","id":"q648w2JrL9Ank3m36DeGJ","children":[],"key":"PuLHud0I4u"}],"key":"l40QxNeo8J"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s make a nice plot of the aggregated HUC12 basins to make sure the aggregation worked as expected.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"toYzI6QzpH"}],"key":"HFuENNZCfv"}],"key":"d7Ftz8mo92"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# xarray holds the huc12s in sorted order\ngdptools_huc12_basins = huc12_basins.copy().sort_values('huc12')\ngdptools_huc12_basins['aggregation'] = gdptools_aggregation.sel(time=timestamp)['PREC_ACC_NC']\n\ngdptools_plt = gdptools_huc12_basins.hvplot(\n    c='aggregation', title=\"Accumulated Precipitation over HUC12 basins\",\n    coastline='50m', geo=True, cmap='viridis',\n    aspect='equal', legend=False, frame_width=300\n)\n\ncutout_plt * gdptools_plt + cutout_plt","key":"wGQG3AFifg"},{"type":"outputs","id":"FgUoKrNS662K9wOLovBGQ","children":[],"key":"MXDjdR6H1E"}],"key":"lI9CLRTXCA"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Native Method","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xFTNBIeMyj"}],"identifier":"native-method","label":"Native Method","html_id":"native-method","implicit":true,"key":"o5WopG2LAW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"For the native method, we first need to extract the grid information from our CONUS404 data set. We then use it to create polygon boxes that we overlay with the basin polygons to generate weights. Finally like ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pfnC1GQJOa"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QmCiSZkiYX"},{"type":"text","value":", we use the weights to aggregate via a weighted sum.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"UlBCx6chei"}],"key":"ww6kY9zn3y"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To give a fair computational time comparison with ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"z0Gy9ZNMVt"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yjZkYFmkN6"},{"type":"text","value":", we will group all steps to generate the weights into one timed cell.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"o0zGf6duif"}],"key":"FhqGeKphBV"}],"key":"jUg6gs88IY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create Weights","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ccgdk0HrCk"}],"identifier":"create-weights","label":"Create Weights","html_id":"create-weights","implicit":true,"key":"lKZD2F2ahy"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To generate the weights, we (1) extract grid information (includes extracting the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"d5G3ypwDs6"},{"type":"inlineCode","value":"x","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JRVxS8ugQ4"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ij45oEeWTk"},{"type":"inlineCode","value":"y","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nY8pQgAndD"},{"type":"text","value":" grid and getting their bounds), (2) use these bounds to create polygons of the grid, (3) assign the polygons to a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ASDwJZLf7Q"},{"type":"inlineCode","value":"GeoDataFrame","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bYpFEJmL9O"},{"type":"text","value":" with the CONUS404 dataset’s CRS, (4) overlay the grid polygons and basin polygons, (5) use the overlay to get fractional area weights.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"w7EkWgk1hm"}],"key":"oueESaGEa8"}],"key":"GYjyKHgtQh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nt0 = time.time()\n# (1) extract grid info\ngrid = conus404[['x', 'y']].drop_vars(['lat', 'lon']).reset_coords()\ngrid = grid.cf.add_bounds(['x', 'y'])\n\n\n# (2) create polygons of the grid\n# use a simple helper function. This way we can use xarray to parallelize.\ndef bounds_to_poly(x_bounds, y_bounds):\n    return Polygon([\n        (x_bounds[0], y_bounds[0]),\n        (x_bounds[0], y_bounds[1]),\n        (x_bounds[1], y_bounds[1]),\n        (x_bounds[1], y_bounds[0])\n    ])\n\n# Stack the grid cells into a single stack (i.e., x-y pairs)\npoints = grid.stack(point=('y', 'x'))\n\n# Apply the function to create polygons from bounds\nboxes = xr.apply_ufunc(\n    bounds_to_poly,\n    points.x_bounds,\n    points.y_bounds,\n    input_core_dims=[(\"bounds\",),  (\"bounds\",)],\n    output_dtypes=[np.dtype('O')],\n    vectorize=True\n)\n\n\n# (3) assign polygons to geodataframe with CRS\ngrid_polygons = gp.GeoDataFrame(\n    data={\"geometry\": boxes.values, \"y\": boxes['y'], \"x\": boxes['x']},\n    index=boxes.indexes[\"point\"],\n    crs=conus404.crs.crs_wkt\n)\n\n\n# (4) overlay the grid polygons with basin polygons\n# transform both to an area preserving projection\nhuc12_basins_area = huc12_basins.to_crs(crs_area)\ngrid_polygons = grid_polygons.to_crs(crs_area)\n\n# overlay the polygons.\noverlay = grid_polygons.overlay(huc12_basins_area, keep_geom_type=True)\n\n\n# (5)calculate the area fraction for each region\ngrid_cell_fraction = overlay.geometry.area.groupby(overlay['huc12']).transform(lambda x: x / x.sum())\n\n# turn this into a series\nmulti_index = overlay.set_index(['y', 'x', 'huc12']).index\ndf_native_weights = pd.Series(grid_cell_fraction.values, index=multi_index)\n\nda_native_weights_stacked = xr.DataArray(df_native_weights)\n\n# unstack to a sparse array.\nnative_weights = da_native_weights_stacked.unstack(sparse=True, fill_value=0.)\n\nnative_weights_time = time.time() - t0\n\nnative_weights","key":"rRfgtLQmz6"},{"type":"outputs","id":"gbalUoYIbI3exh9VBfhTN","children":[],"key":"mP6kciqKk8"}],"key":"LO8JgHKuOt"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now that we have our weights, we can clearly see that this is a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"odD23KWDAA"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tHbOiBwSkM"}],"key":"CjnFOjex4u"},{"type":"text","value":" matrix, with a density of ~0.0025 (i.e., only 0.25% of values are non-zero). So, maintaining it as a sparse martix is the right move for memory conservation, especially as this process scales up.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IPPdRnPQCq"}],"key":"tNxxuVPd3w"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Also, this process is area conserving. We can verify this for each basin’s area with a simple area calculation.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nGM8mu6RPG"}],"key":"mLjlNbuqtQ"}],"key":"IQIjyDECo1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# calculate areas of HUC12s from overlay and original polygons\noverlay_area = overlay.geometry.area.groupby(overlay['huc12']).sum()\nhuc12_area = huc12_basins_area.geometry.area.groupby(huc12_basins_area['huc12']).sum()\n# find the max fractional difference\n(np.abs(overlay_area - huc12_area) / huc12_area).max()","key":"VUSQeIS6wD"},{"type":"outputs","id":"4u1NXtz0yo2g_Qq5oAMUM","children":[],"key":"VefnY1vdeE"}],"key":"bSERKeK8Re"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Nice! This means the differences can be attributed to machine precision.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HH3rTbkMYO"}],"key":"S5EDxdfoMz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We can also verify that the cell fractions all sum up to one.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yUy81C0lPm"}],"key":"M2Wzz2q3Mp"}],"key":"rMGUOFlGyS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid_cell_fraction.groupby(overlay['huc12']).sum().unique()","key":"xrPOIeZQmH"},{"type":"outputs","id":"34xMGC9rkdDDEHf_bzhN6","children":[],"key":"DVLsXCeVwH"}],"key":"zSpMxTiw5a"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Perform Aggregation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k88KTJ3kuo"}],"identifier":"perform-aggregation","label":"Perform Aggregation","html_id":"perform-aggregation","implicit":true,"key":"epzesVcBvA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To aggregate the data, we can use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aNs5piaOm8"},{"type":"link","url":"https://docs.xarray.dev/en/stable/generated/xarray.Dataset.weighted.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"xarray.Dataset.weighted","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vG4DdY04AX"}],"urlSource":"https://docs.xarray.dev/en/stable/generated/xarray.Dataset.weighted.html","key":"Z0v0wNSkU9"},{"type":"text","value":" to do our weighted calculations. This is simple as it will take a sparse array as weights and compute the aggregation.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yWFCaRwX4N"}],"key":"eLmBi6xESk"}],"key":"wslxlzT5QC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nt0 = time.time()\n\nnative_aggregation = conus404.drop_vars('crs').weighted(native_weights).sum(dim=['x', 'y']).compute()\n\nnative_agg_time = time.time() - t0\n\nnative_aggregation","key":"uAdvMW9s66"},{"type":"outputs","id":"PmE3hAJNNGnXgiDu0N-az","children":[],"key":"vw9zYIgkSX"}],"key":"waXrUBHGBO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Like the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SqUyTntXyC"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nSmUHKQgQT"},{"type":"text","value":" aggregation results, let’s make some plots to make sure this worked as expected.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KcOUXz9n9j"}],"key":"yl5KTMTLR9"}],"key":"TWLDoDHiPh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# xarray holds the huc12s in sorted order\nnative_huc12_basins = huc12_basins.copy().sort_values('huc12')\nnative_huc12_basins['aggregation'] = native_aggregation.sel(time=timestamp)['PREC_ACC_NC'].data.todense()\nnative_plt = native_huc12_basins.hvplot(\n    c='aggregation', title=\"Accumulated Precipitation over HUC12 basins\",\n    coastline='50m', geo=True, cmap='viridis',\n    aspect='equal', legend=False, frame_width=300\n)\n\ncutout_plt * native_plt + cutout_plt","key":"DiWN5XEFCQ"},{"type":"outputs","id":"tHX3kxI4qNziRsN-BK-KB","children":[],"key":"xTILvxk02R"}],"key":"ZO9n0MuBZ3"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compare the Results","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TdqYGYknqW"}],"identifier":"compare-the-results","label":"Compare the Results","html_id":"compare-the-results","implicit":true,"key":"ibA32JlPE1"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"With both aggregation methods complete, we are now ready to compare the results. We can do this both for the final output and the intermediate weights.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"iRaO12Pfbo"}],"key":"Ow5ep9eIT1"}],"key":"RcoPuWxQrL"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Weight Comparison","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JAMzfVqQqc"}],"identifier":"weight-comparison","label":"Weight Comparison","html_id":"weight-comparison","implicit":true,"key":"iqzm2qmhgA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To do the weight comparison, we first need to standardize the weight outputs. This is relatively simple as we just need to convert the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T5CpbjLmH1"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oUPrqHZz7z"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XAjQR5JYIw"},{"type":"inlineCode","value":"DataFrame","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eUcwysRVIM"},{"type":"text","value":" weights into an ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"I6PJn5ivMM"},{"type":"inlineCode","value":"xarray.DataArray","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"COnRqnigZ0"},{"type":"text","value":". We can do this just like we did for the conservative method, but assigning the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"c5jtet7FA9"},{"type":"inlineCode","value":"x","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HjHbIBBqkq"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zVNptobQaB"},{"type":"inlineCode","value":"y","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JmdkmjMULC"},{"type":"text","value":" values to the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HZt3vCIeEh"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Jgxps1hSrI"},{"type":"text","value":" data frame using the given indices.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GGnwBkVyNA"}],"key":"CZa7k1asd5"}],"key":"NFxySkNFpG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Due to the buffer region, gdptools weights i index values\n# are off by 3 and j are off by 1. This was found from a manual inspection\ndf_gdptools_weights['y'] = conus404['y'].isel(y=df_gdptools_weights['i']+3).data\ndf_gdptools_weights['x'] = conus404['x'].isel(x=df_gdptools_weights['j']+1).data\ngdptool_weights = xr.DataArray(\n    df_gdptools_weights.set_index(['y', 'x', 'huc12'])['wght']\n).unstack(sparse=True, fill_value=0)","key":"KZF6BzxmlE"},{"type":"outputs","id":"lPSyBf3e8z9xu1sbmo4oM","children":[],"key":"IyCT00ogjE"}],"key":"OEXhqY71K7"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, a simple max fractional difference is the simple check for how they compare.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"a4L2cIAH2H"}],"key":"iPu15fSNZ8"}],"key":"yz0Fo5AAuS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"(np.abs(gdptool_weights - native_weights) / native_weights).max()","key":"fgRaacOJsw"},{"type":"outputs","id":"YFEFkKR7FNS3QboIlTLtF","children":[],"key":"AwwQ5fDq68"}],"key":"APMchHGe97"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Look at that. They are identical (up to machine precision). So, the only other thing to compare would be the time required for the computation.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"o1KB11fHFP"}],"key":"fo6mD7ymC9"}],"key":"GSsrunf2n1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f'gdptools weights computation time: {gdptools_weights_time:0.3f} seconds')\nprint(f'native weights computation time: {native_weights_time:0.3f} seconds')\nprint(f'computation time difference: {(gdptools_weights_time - native_weights_time):0.3f} seconds')\nprint(f'computation time ratio: {(gdptools_weights_time / native_weights_time):0.3f}')","key":"n9ABWDJ9la"},{"type":"outputs","id":"iyg95uZPA7XlqnlMf0SPk","children":[],"key":"HjXSpTsyZc"}],"key":"CW5UIw5OcN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So, from this comparison, we can see that both methods give the same weights, but the method using ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"t70NTYcddO"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BxE3CDJsZr"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"trJcgZXnKb"},{"type":"inlineCode","value":"geopandas","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"op7eSpW0nm"},{"type":"text","value":" slightly faster (and likely not significantly). However, this does not test how well either of the two methods scale.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"alSOPCRyky"}],"key":"lEoIIDtehS"}],"key":"Anmypjl5gP"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Aggregation Comparison","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X3Dm8guav9"}],"identifier":"aggregation-comparison","label":"Aggregation Comparison","html_id":"aggregation-comparison","implicit":true,"key":"kRPK7KWY1D"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To do the aggregated data comparison, there is no need for any data formatting, as both ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QfTJr34lpF"},{"type":"inlineCode","value":"gdptools","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pEWIdfOF7P"},{"type":"text","value":" and the native method have matching ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"R67XAwFM0V"},{"type":"inlineCode","value":"xarray.Dataset","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DAwirh2aJT"},{"type":"text","value":" formats. So, let’s start with the simple max fractional difference to compare.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Lli7Pfi7AA"}],"key":"DEIQzpNph3"}],"key":"MIDEMMWVxX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"(np.abs(gdptools_aggregation - native_aggregation) / native_aggregation).max()","key":"zyjYchabwy"},{"type":"outputs","id":"rOsAY8E1_yCI3BTVpsAZE","children":[],"key":"dKkeVxOCyg"}],"key":"tjaXsYwcfA"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Well, as expected, they are nearly identical, since they had nearly identical weights.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SJotXroHaf"}],"key":"hRQCPjHV4B"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Let’s plot the fractional difference for a timestamp just to see how they compare.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yzS8BmgJgH"}],"key":"J2FaiaKUe2"}],"key":"VCbAc6l6Z2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# xarray holds the huc12s in sorted order\ndiff_huc12_basins = huc12_basins.copy().sort_values('huc12')\ndiff_huc12_basins['aggregation'] = (np.abs(gdptools_aggregation - native_aggregation) / native_aggregation).sel(time=timestamp)['PREC_ACC_NC']\n\ndiff_huc12_basins.hvplot(\n    c='aggregation', title=\"Difference in Precipitation over HUC12 basins\",\n    coastline='50m', geo=True, cmap='viridis',\n    aspect='equal', legend=False, frame_width=300\n)","key":"C7KHHmWf3y"},{"type":"outputs","id":"EZaUQ0OpDUhhenIMSeGJd","children":[],"key":"uKLfgODXbr"}],"key":"XYfRmbt9P0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Finally, let’s compare the computational times.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RNjq9ai2xv"}],"key":"B2io61A09N"}],"key":"bbOKyTrPAu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f'gdptools aggregation computation time: {gdptools_agg_time:0.3f} seconds')\nprint(f'native aggregation computation time: {native_agg_time:0.3f} seconds')\nprint(f'computation time difference: {(gdptools_agg_time - native_agg_time):0.3f} seconds')\nprint(f'computation time ratio: {(gdptools_agg_time / native_agg_time):0.3f}')","key":"Qwu69guIwQ"},{"type":"outputs","id":"gIgn-eDsqbVK38VBde8Tb","children":[],"key":"IkZosesAfW"}],"key":"b1hPDy718z"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"It looks like this step takes about the same time for both. So, let’s compare the total computation time (weights and aggregation).","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GVTfU4olCm"}],"key":"UnyqHPFPkd"}],"key":"vnVuN9qRUY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"gdptools_total_time = gdptools_weights_time+gdptools_agg_time\nnative_total_time = native_weights_time + native_agg_time\nprint(f'gdptools total computation time: {gdptools_total_time:0.3f} seconds')\nprint(f'native total computation time: {native_total_time:0.3f} seconds')\nprint(f'total computation time difference: {(gdptools_total_time - native_total_time):0.3f} seconds')\nprint(f'total computation time ratio: {(gdptools_total_time / native_total_time):0.3f}')","key":"rUk2X4TBZI"},{"type":"outputs","id":"rYN75fLSHsi1RlevMOtqc","children":[],"key":"Veq4vbL1Ie"}],"key":"nwXGVjLLM8"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Alright, since both the aggregation and weights times are about equal, the overall performance of both is equal as well. Therefore, it appears that either method is a solid choice. The only other thing to test would be how well each method scales to larger feature polygons and larger grids. However, we will leave that comparison for another notebook.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"htXAWuBLvd"}],"key":"ZNSvnZsR9V"}],"key":"JsgOl6M3If"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Shut down the Dask Client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FwKcmmYuYb"}],"identifier":"shut-down-the-dask-client","label":"Shut down the Dask Client","html_id":"shut-down-the-dask-client","implicit":true,"key":"GR2apJDxsv"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"If utilized, we should shut down the dask client.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QB02DQUBgy"}],"key":"uOacud31NR"}],"key":"eWeYd1xKgD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close()","key":"sZf7zmntFy"},{"type":"outputs","id":"k2yIy7ZLwyEca4hgHse4w","children":[],"key":"ZcqBcq7w50"}],"key":"hGiKKfjBXH"}],"key":"h4yv49kSaW"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Pangeo CONUS404 Spatial Aggregation over DRB-extent HUC12s","url":"/dataset-processing/tutorials/spatial-aggregation/conus404-spatial-aggregation","group":"Dataset Processing"},"next":{"title":"CONUS404 Site Data Selection","url":"/dataset-processing/tutorials/conus404-point-selection","group":"Dataset Processing"}}},"domain":"http://localhost:3005"},"project":{"title":"HyTEST Project","github":"https://github.com/hytest-org/hytest","copyright":"2023","toc":[{"file":"doc/About.md"},{"children":[{"children":[{"file":"environment_set_up/QuickStart-General.md"},{"file":"environment_set_up/QuickStart-Cloud-Nebari.md"},{"file":"environment_set_up/OpenOnDemand.md"},{"file":"environment_set_up/JupyterForward.md"},{"file":"environment_set_up/StartScript.md"}],"file":"environment_set_up/README.md"},{"file":"environment_set_up/Help_AWS_Credentials.ipynb"},{"children":[{"file":"environment_set_up/Start_Dask_Cluster_Nebari.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Denali.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Tallgrass.ipynb"},{"file":"environment_set_up/Start_Dask_Cluster_Desktop.ipynb"}],"file":"environment_set_up/clusters.md"}],"title":"Environment Set-Up"},{"children":[{"children":[{"file":"essential_reading/ReadingsTutorials.md"}],"file":"essential_reading/README.md"},{"children":[{"file":"essential_reading/DataSources/Data_APIs.md"},{"file":"essential_reading/DataSources/Data_S3.md"}],"file":"essential_reading/DataSources/README.md"},{"file":"essential_reading/Parallel_Dask.ipynb"}],"title":"Getting Started"},{"children":[{"children":[{"file":"dataset_catalog/storage_locations.md"},{"file":"dataset_catalog/STAC.ipynb"},{"file":"dataset_catalog/intake.md"},{"file":"dataset_catalog/subcatalogs/README.md"}],"file":"dataset_catalog/README.md"},{"children":[{"file":"dataset_access/CONUS404_CHANGELOG.md"},{"file":"dataset_access/conus404_explore.ipynb"}],"file":"dataset_access/CONUS404_ACCESS.md"}],"title":"Dataset Access"},{"children":[{"file":"dataset_processing/tutorials/chunking/README.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/101/WhyChunk.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/ExamineDataChunking.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/BasicsShapeSize.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/WriteChunkedFiles.ipynb"},{"file":"dataset_processing/tutorials/chunking/101/Rechunking.ipynb"}],"file":"dataset_processing/tutorials/chunking/101/index.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/201/RechunkingwithDask.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/CreateVirtualZarr.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/IncludeCRSinZarr.ipynb"},{"file":"dataset_processing/tutorials/chunking/201/OptimalChunkSelection.ipynb"}],"file":"dataset_processing/tutorials/chunking/201/index.md"},{"children":[{"file":"dataset_processing/tutorials/chunking/back/Glossary.md"},{"file":"dataset_processing/tutorials/chunking/back/AdditionalResources.md"}],"file":"dataset_processing/tutorials/chunking/back/index.md"}],"title":"Zarr Creation"},{"children":[{"file":"dataset_processing/tutorials/conus404_temporal_aggregation.ipynb"},{"children":[{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_DRB.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_GFv1_1.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_WBD12.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation.ipynb"},{"file":"dataset_processing/tutorials/spatial_aggregation/conus404_spatial_aggregation_comparison.ipynb"}],"file":"dataset_processing/spatial_aggregation.md"},{"file":"dataset_processing/tutorials/conus404_point_selection.ipynb"},{"file":"dataset_processing/tutorials/conus404_regrid.ipynb"}],"title":"Dataset Processing"},{"children":[{"children":[{"file":"evaluation/Metrics_DScore_Suite_v1.ipynb"},{"file":"evaluation/tutorials/stats_demos/Usage_DScore_Suite_v1.ipynb"},{"file":"evaluation/Metrics_StdSuite_v1.ipynb"},{"file":"evaluation/tutorials/stats_demos/Usage_StdSuite_v1.ipynb"}],"file":"evaluation/metrics.md"},{"children":[{"file":"evaluation/tutorials/streamflow/01_Data_Prep.ipynb"},{"file":"evaluation/tutorials/streamflow/02_Analysis_StdSuite.ipynb"},{"file":"evaluation/tutorials/streamflow/02_Analysis_DScore.ipynb"},{"file":"evaluation/tutorials/streamflow/03_Vizualization.ipynb"}],"file":"evaluation/tutorials/streamflow/00_Overview.md"}],"title":"Model Evaluation"},{"children":[{"file":"CONTRIBUTING.md"},{"file":"LICENSE.md"}],"title":"Back Matter"}],"exports":[],"bibliography":[],"index":"index","pages":[{"level":1,"title":"Environment Set-Up"},{"slug":"environment-set-up.readme","title":"Compute Environments","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.quickstart-general","title":"General QuickStart","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.quickstart-cloud-nebari","title":"Cloud: Nebari Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.openondemand","title":"HPC Server: Open OnDemand Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.jupyterforward","title":"HPC Server: Jupyter Forward Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.startscript","title":"HPC Server: Start Script Quick-Start","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.help-aws-credentials","title":"AWS Credentials","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.clusters","title":"Starting a Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"environment-set-up.start-dask-cluster-nebari","title":"Nebari Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-denali","title":"Denali HPC Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-tallgrass","title":"Hovenweep/Tallgrass HPC Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"environment-set-up.start-dask-cluster-desktop","title":"Local Desktop Dask Cluster","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Getting Started"},{"slug":"essential-reading.readme","title":"Essential Reading","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"essential-reading.readingstutorials","title":"Foundations","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.datasources.readme","title":"Data Sources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"essential-reading.datasources.data-apis","title":"Data/APIs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.datasources.data-s3","title":"Data/Cloud Storage","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"essential-reading.parallel-dask","title":"Parallelism with Dask","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Dataset Access"},{"slug":"dataset-catalog.readme","title":"Data Catalogs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-catalog.storage-locations","title":"Data Storage Locations","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.stac","title":"Water Mission Area STAC Catalog","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.intake","title":"HyTEST Data Catalog (Intake)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-catalog.subcatalogs.readme","title":"HyTEST Intake Sub-Catalogs","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-access.conus404-access","title":"CONUS404 Products Data Access","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-access.conus404-changelog","title":"CONUS404 Zarr Changelog","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-access.conus404-explore","title":"Explore CONUS404 Dataset","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Zarr Creation"},{"slug":"dataset-processing.tutorials.chunking.readme","title":"Data Chunking Tutorial Overview","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.101.index","title":"Introduction to Chunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.101.whychunk","title":"Why (re)Chunk Data?","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.examinedatachunking","title":"How to Examine a Stored Dataset’s Chunk Shape","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.basicsshapesize","title":"Basics of Chunk Shape and Size","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.writechunkedfiles","title":"Writing Chunked Files","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.101.rechunking","title":"Rechunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.index","title":"Advanced Topics in Chunking","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.201.rechunkingwithdask","title":"Rechunking Larger Datasets with Dask","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.createvirtualzarr","title":"Generating a Virtual Zarr Store","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.includecrsinzarr","title":"Adding Coordinate Reference Systems (CRS) to Zarr Datasets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.201.optimalchunkselection","title":"Choosing an Optimal Chunk Size and Shape","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.back.index","title":"Chunking References","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.chunking.back.glossary","title":"Glossary","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.chunking.back.additionalresources","title":"Additional Resources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Dataset Processing"},{"slug":"dataset-processing.tutorials.conus404-temporal-aggregation","title":"CONUS404 Temporal Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.spatial-aggregation","title":"Spatial Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-drb","title":"gdptools CONUS404 Spatial Aggregation over DRB-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-gfv1-1","title":"gdptools CONUS404 Spatial Aggregation over CONUS-extent GFv1.1","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-wbd12","title":"gdptools CONUS404 Spatial Aggregation over CONUS-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation","title":"Pangeo CONUS404 Spatial Aggregation over DRB-extent HUC12s","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.spatial-aggregation.conus404-spatial-aggregation-comparison","title":"gdptools-Pangeo Method Comparison for CONUS404 Spatial Aggregation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"dataset-processing.tutorials.conus404-point-selection","title":"CONUS404 Site Data Selection","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"dataset-processing.tutorials.conus404-regrid","title":"CONUS404 Regridding (Curvilinear =\u003e Rectilinear)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Model Evaluation"},{"slug":"evaluation.metrics","title":"Evaluation Metrics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"evaluation.metrics-dscore-suite-v1","title":"D-Score Suite (v1) Benchmark","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.stats-demos.usage-dscore-suite-v1","title":"D-Score Suite (v1) Benchmark -- Usage Examples","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.metrics-stdsuite-v1","title":"Standard Suite (v1) Metrics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.stats-demos.usage-stdsuite-v1","title":"Standard Suite (v1) Metrics -- Usage Examples","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.overview","title":"Streamflow Model Evaluation","description":"","date":"","thumbnail":"/hytest//build/Eval_Overview-29b9b051cf5b081af64c0ddd303c6d0a.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"evaluation.tutorials.streamflow.data-prep","title":"Streamflow Eval :: Data Preparation","description":"","date":"","thumbnail":"/hytest//build/Eval_PreProc-e7e95e0745be409b1f1508ad2e2ff8c5.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.analysis-stdsuite","title":"Streamflow Eval :: StdSuite Analysis","description":"","date":"","thumbnail":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.analysis-dscore","title":"Steamflow Eval :: DScore Analysis","description":"","date":"","thumbnail":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"slug":"evaluation.tutorials.streamflow.vizualization","title":"Streamflow Eval :: Visualization","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":3},{"level":1,"title":"Back Matter"},{"slug":"contributing","title":"Contributing","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"license","title":"License","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}}},"actionData":null,"errors":null},"future":{"unstable_dev":false,"unstable_postcss":false,"unstable_tailwind":false,"v2_errorBoundary":true,"v2_headers":true,"v2_meta":true,"v2_normalizeFormMethod":true,"v2_routeConvention":true}};</script><script type="module" async="">import "/hytest//build/manifest-5D5D9E8C.js";
import * as route0 from "/hytest//build/root-AA24SA6C.js";
import * as route1 from "/hytest//build/routes/$-5SFLQWPV.js";
window.__remixRouteModules = {"root":route0,"routes/$":route1};

import("/hytest//build/entry.client-PCJPW7TK.js");</script></body></html>