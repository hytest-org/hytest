{"version":3,"kind":"Article","sha256":"343fd2c5557cd77023473a8d932107dca73d660d8b32f68c1d2f2ba38daaa113","slug":"essential-reading.datasources.data-s3","location":"/essential_reading/DataSources/Data_S3.md","dependencies":[],"frontmatter":{"title":"Data/Cloud Storage","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":2}},"source_url":"https://github.com/hytest-org/hytest/blob/main/essential_reading/DataSources/Data_S3.md","edit_url":"https://github.com/hytest-org/hytest/edit/main/essential_reading/DataSources/Data_S3.md","exports":[{"format":"md","filename":"Data_S3.md","url":"/hytest//build/Data_S3-a7b0fafd06df96bb603dea52e65cf370.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"One of the main storage locations for HyTest data is in ‘","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mziG3XafLy"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The Cloud","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cSqRDm1Z7V"}],"key":"Hpz0LOybDn"},{"type":"text","value":"’. This is sometimes referred to as ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bsPmXmVcb9"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"‘Object Storage’","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LqB2qDrlic"}],"key":"ky5J7b5iSh"},{"type":"text","value":".\nThe data is kept in data centers operated by Amazon, Microsoft, or similar, which makes it easily available to network-connected devices.\nThe main advantage of doing this is that if your compute engine is also in that same data center (or nearby, as is the case with many JupyterHub services), the data doesn’t have to go very far to get to the compute power. This brings the computation to the data, rather than shipping large datasets across the internet to get to the compute engine.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"j5lDlUniQR"}],"key":"ftHW0gSyyT"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The HyTEST project is collaborating with the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"GcGg8r4qr3"},{"type":"link","url":"https://www.whoi.edu/","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Woods Hole Oceanographic Institution","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"dnhtnOgkOK"}],"urlSource":"https://www.whoi.edu/","key":"jBjQ8cW3MW"},{"type":"text","value":" to demonstrate the utility of using an ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"dvbYsnEIoQ"},{"type":"link","url":"https://www.openstoragenetwork.org/","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Open Storage Network (OSN)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"AzgfP5fUuQ"}],"urlSource":"https://www.openstoragenetwork.org/","key":"NOElDdNhYV"},{"type":"text","value":" pod for providing access to data within scientific workflows. This OSN pod will provide 1 PB of usable ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"pbw8GFXvbr"},{"type":"link","url":"https://docs.ceph.com/en/pacific/glossary/#term-Ceph-Object-Storage","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Ceph Object Storage","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"cEUpoxf2Yn"}],"urlSource":"https://docs.ceph.com/en/pacific/glossary/#term-Ceph-Object-Storage","key":"pSjgwY5ltd"},{"type":"text","value":" and will be housed at the Massachusetts Green High Performance Computing Center on a high-speed (100+ GbE) network. This piece of hardware provides the opportunity to host data without the storage or egress fees that come along with other forms of cloud object storage, such as ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EdHd4nPctZ"},{"type":"link","url":"https://aws.amazon.com/s3/","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Amazon S3 object storage","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fVbPm0Ao2A"}],"urlSource":"https://aws.amazon.com/s3/","key":"i98UtMe3XF"},{"type":"text","value":". Ceph object storage supports an ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fVBiqo7GkO"},{"type":"link","url":"https://docs.ceph.com/en/pacific/radosgw/s3/#","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"API that is compatible with the basic data access model of the Amazon S3 API","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"LNm1bi88KR"}],"urlSource":"https://docs.ceph.com/en/pacific/radosgw/s3/#","key":"AEasjVCK64"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"o7uMnFDK35"}],"key":"aLI2mHtXuV"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"What follows is a brief demo of how data can be read from or written to object storage through the S3 API and some pitfalls to watch out for. These methods should be generally applicable to both S3 object storage and the OSN pod object storage.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"PjJDWdpXYH"}],"key":"jH908yZN0E"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"The permissions scheme for S3 allows for anonymous/global read access, as well as secured access via specific credentials.\nWe’ll look at generic workflows using an anonymous-access store, then finish off with some private/credentialed operations.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"q9VlOw7s1v"}],"key":"WiszUALwr9"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"The easiest way to access data with the S3 API through a Python program is via the\n","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"OA00LoR8VV"},{"type":"link","url":"https://filesystem-spec.readthedocs.io/en/latest/","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"fsspec","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"o4LUoZZsh4"}],"urlSource":"https://filesystem-spec.readthedocs.io/en/latest/","key":"aEsFMxbD2c"},{"type":"text","value":" module.\nThis is a layer of abstraction that lets us interact with arbitrary storage mechanisms as if\nthey are conventional file systems. It makes this object storage ‘look’ like a conventional file system.","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"l2H6asQGoC"}],"key":"po0XjDkEzZ"},{"type":"heading","depth":2,"position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Anonymous Reads from S3","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"yaE4MhQwEu"}],"identifier":"anonymous-reads-from-s3","label":"Anonymous Reads from S3","html_id":"anonymous-reads-from-s3","implicit":true,"key":"KxsDFBEBtV"},{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"A lot of data is available for global read, which does not require credentials or a profile.\nIn this case, we set ","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"mlRYnL1nMo"},{"type":"inlineCode","value":"anon=True","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"umcvAsCG5R"},{"type":"text","value":" when plumbing the ","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"z5lm6f8oES"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"xtMtxrDx8w"},{"type":"text","value":" object. Here we demonstrate how to list the contents of an AWS S3 bucket with global read access:","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"omts3mkDpC"}],"key":"ijLQ0WNlqz"},{"type":"code","lang":"python","value":"fs = fsspec.filesystem(\n    's3',\n    anon=True   # Does not require credentials\n    )\n# 'fs' is an object which provides methods access to the virtual filesystem\n# 'ls' method == list ; list files in a virtual folder to test if we really have access\nfs.ls('s3://noaa-nwm-retrospective-2-1-zarr-pds/')","position":{"start":{"line":24,"column":1},"end":{"line":32,"column":1}},"key":"IxVoASwr2a"},{"type":"paragraph","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"Output:","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"NYZUKwyHqs"}],"key":"H9VDZhepvq"},{"type":"code","lang":"text","value":"['noaa-nwm-retrospective-2-1-zarr-pds/chrtout.zarr',\n 'noaa-nwm-retrospective-2-1-zarr-pds/gwout.zarr',\n 'noaa-nwm-retrospective-2-1-zarr-pds/lakeout.zarr',\n 'noaa-nwm-retrospective-2-1-zarr-pds/ldasout.zarr',\n 'noaa-nwm-retrospective-2-1-zarr-pds/precip.zarr',\n 'noaa-nwm-retrospective-2-1-zarr-pds/rtout.zarr']","position":{"start":{"line":36,"column":1},"end":{"line":43,"column":1}},"key":"SXFkjOqnST"},{"type":"paragraph","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"We can call other methods on the ","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"nrf0uTZbNq"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"jsAkqleIzx"},{"type":"text","value":" object “","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"D34wLD7JvJ"},{"type":"inlineCode","value":"fs","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"jzDa7dGI3L"},{"type":"text","value":"” to interact with filesystem objects.","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"gfNR5dPpIH"}],"key":"g7NqqpePYS"},{"type":"code","lang":"python","value":"fs.info('s3://noaa-nwm-retrospective-2-1-zarr-pds/index.html')","position":{"start":{"line":47,"column":1},"end":{"line":49,"column":1}},"key":"mc8q4LgSzc"},{"type":"paragraph","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"children":[{"type":"text","value":"Output:","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"key":"VPCMnlDAfs"}],"key":"aBPLTElYhx"},{"type":"code","lang":"text","value":"{'Key': 'noaa-nwm-retrospective-2-1-zarr-pds/index.html',\n'LastModified': datetime.datetime(2021, 10, 1, 20, 48, 48, tzinfo=tzutc()),\n'ETag': '\"3b4b4277037c1127ed4ba68e26461b2e\"',\n'Size': 32357,\n'StorageClass': 'STANDARD',\n'type': 'file',\n'size': 32357,\n'name': 'noaa-nwm-retrospective-2-1-zarr-pds/index.html'}","position":{"start":{"line":53,"column":1},"end":{"line":62,"column":1}},"key":"FRTbLUHYAJ"},{"type":"paragraph","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"children":[{"type":"text","value":"Low-level operations with ","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"key":"SDUoVDBEQE"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"key":"saD8pJ6Bb2"},{"type":"text","value":" are designed to behave similarly to the ‘native’ file operations in Python.","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"key":"aVClJ2GlJg"}],"key":"aUUbGjpsfy"},{"type":"code","lang":"python","value":"# Use open() to get something that behaves like a file handle for\n# low-level Python read/write operations:\nwith fs.open('s3://noaa-nwm-retrospective-2-1-zarr-pds/index.html') as f:\n    # print first 5 lines...\n    for i in range(0, 5):\n        line = f.readline()\n        print(line)","position":{"start":{"line":66,"column":1},"end":{"line":74,"column":1}},"key":"bwvmGT77L9"},{"type":"paragraph","position":{"start":{"line":76,"column":1},"end":{"line":76,"column":1}},"children":[{"type":"text","value":"Output:","position":{"start":{"line":76,"column":1},"end":{"line":76,"column":1}},"key":"OztrRNWdPO"}],"key":"VaDEKz51Jb"},{"type":"code","lang":"text","value":"b'<!DOCTYPE html>\\r\\n'\nb'\\r\\n'\nb'<!--\\r\\n'\nb'Copyright 2014-2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.\\r\\n'\nb'\\r\\n'","position":{"start":{"line":78,"column":1},"end":{"line":84,"column":1}},"key":"D9N0Ds8eU4"},{"type":"paragraph","position":{"start":{"line":86,"column":1},"end":{"line":89,"column":1}},"children":[{"type":"text","value":"However -- most of the time, we don’t need such low level access.\nA more general, and useful, mechanism is to ‘","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"iS8CKFj3d6"},{"type":"emphasis","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"children":[{"type":"text","value":"map","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"tGQ27gkmef"}],"key":"LGRNGs35Ak"},{"type":"text","value":"’ an S3 object to a ","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"D57sWFnS0P"},{"type":"emphasis","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"children":[{"type":"text","value":"virtual file","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"aP0124gekX"}],"key":"EgqBdPduXJ"},{"type":"text","value":" using ","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"Tqm9JSvQuf"},{"type":"inlineCode","value":"get_mapper()","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"j9k2ZySMVk"},{"type":"text","value":".\nThat ","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"verkMGG0Pm"},{"type":"emphasis","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"children":[{"type":"text","value":"map","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"uGY9erfGT3"}],"key":"AfRM3wITIy"},{"type":"text","value":" object can then be treated as if it is a local file -- the ","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"aydvaU8uaW"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"LnZgwRNqRh"},{"type":"text","value":" mapping mechanism handles\nall of the translation to interact with S3.","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"U59hiWbe2D"}],"key":"rOWc8NzULD"},{"type":"code","lang":"python","value":"m = fs.get_mapper('s3://noaa-nwm-retrospective-2-1-zarr-pds/chrtout.zarr')\n# 'm' looks like a file as far as Python is concerned.\n# It is now a stand-in for those functions that require a file as argument.\ng = zarr.convenience.open_consolidated(m) # read zarr metadata for named file.\nprint(g.tree())","position":{"start":{"line":91,"column":1},"end":{"line":97,"column":1}},"key":"SIx8NXBMRj"},{"type":"paragraph","position":{"start":{"line":99,"column":1},"end":{"line":99,"column":1}},"children":[{"type":"text","value":"Output:","position":{"start":{"line":99,"column":1},"end":{"line":99,"column":1}},"key":"GZOXA0azre"}],"key":"O0AMXoZK49"},{"type":"code","lang":"text","value":"/\n ├── crs () |S1\n ├── elevation (2776738,) float32\n ├── feature_id (2776738,) int32\n ├── gage_id (2776738,) |S15\n ├── latitude (2776738,) float32\n ├── longitude (2776738,) float32\n ├── order (2776738,) int32\n ├── streamflow (367439, 2776738) int32\n ├── time (367439,) int64\n └── velocity (367439, 2776738) int32","position":{"start":{"line":101,"column":1},"end":{"line":113,"column":1}},"key":"iqGpllE2VD"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"hufO394m7Z"}],"key":"SjR1URfAhg"},{"type":"paragraph","position":{"start":{"line":117,"column":1},"end":{"line":118,"column":1}},"children":[{"type":"text","value":"We are deliberately demonstrating using commands that read ","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"eM1a3LpI3p"},{"type":"strong","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"text","value":"only","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"eWX1VioQRH"}],"key":"ucxHkvoSu9"},{"type":"text","value":" the zarr metadata from the\nobject storage -- ","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"XXFfLNOhpv"},{"type":"strong","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"text","value":"not the full dataset","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"nUtue4953Q"}],"key":"vDp85oUAOE"},{"type":"text","value":".","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"CAitxg4BCU"}],"key":"hBcKUobpXs"},{"type":"paragraph","position":{"start":{"line":120,"column":1},"end":{"line":121,"column":1}},"children":[{"type":"text","value":"The above example is a very, ","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"l1veTZ7K2V"},{"type":"emphasis","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"children":[{"type":"text","value":"very","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"OLX6d7eX1d"}],"key":"b4fVm1a4ln"},{"type":"text","value":", ","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"GcvG6Y8S33"},{"type":"strong","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"children":[{"type":"text","value":"very","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"bFK6kLxemg"}],"key":"vRpL2xC3Z7"},{"type":"text","value":" large dataset, which you don’t want to load over the network to your desktop.\nExecute full data read operations only if this notebook is being hosted and run out of the same AWS center where the data lives.","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"B1ytRJrCuu"}],"key":"S5exEosBw1"}],"key":"ICHmmBVCZi"},{"type":"paragraph","position":{"start":{"line":126,"column":1},"end":{"line":128,"column":1}},"children":[{"type":"text","value":"The good news about some of the larger science-oriented libraries (xarray, dask, pandas, zarr, etc), is that\nthey can automatically handle the ","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"iLonBb06uK"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"iZlZ9t1sCd"},{"type":"text","value":" operations for you ","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"FToqJtDdhm"},{"type":"strong","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"children":[{"type":"text","value":"IF YOUR ACCESS IS ANONYMOUS","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"PI7D1SdEAo"}],"key":"qZQVzLMKr5"},{"type":"text","value":".\nThis is a convenience, but is a special case for read-only data where ","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"wp2RqWvpTy"},{"type":"inlineCode","value":"anon=True","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"QKlqci0Su2"},{"type":"text","value":" and ","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"eZdyj39Oer"},{"type":"inlineCode","value":"requester_pays=False","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"jxBZbvl9lY"},{"type":"text","value":".","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"gkyFluGb18"}],"key":"Yvt0lHYRNg"},{"type":"paragraph","position":{"start":{"line":130,"column":1},"end":{"line":132,"column":1}},"children":[{"type":"text","value":"Note that this is a feature of\n","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"GztB3YUQoT"},{"type":"link","url":"https://filesystem-spec.readthedocs.io/en/latest/#who-uses-fsspec","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"children":[{"type":"text","value":"specific libraries","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"pOC8DhEfRs"}],"urlSource":"https://filesystem-spec.readthedocs.io/en/latest/#who-uses-fsspec","key":"Am8Bm1q7Mn"},{"type":"text","value":",\nand doesn’t work everywhere.","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"IFWdaeBgCW"}],"key":"xydEecKnS0"},{"type":"paragraph","position":{"start":{"line":134,"column":1},"end":{"line":136,"column":1}},"children":[{"type":"text","value":"Because it isn’t universally available, and only applies to anonymous reads, examples in HyTEST will\nalways explicitly plumb ","position":{"start":{"line":134,"column":1},"end":{"line":134,"column":1}},"key":"wn9tI4mKEO"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":134,"column":1},"end":{"line":134,"column":1}},"key":"eoXLZ1ckjC"},{"type":"text","value":" ‘longhand’ using ","position":{"start":{"line":134,"column":1},"end":{"line":134,"column":1}},"key":"RQerjCZdgg"},{"type":"inlineCode","value":"get_mapper()","position":{"start":{"line":134,"column":1},"end":{"line":134,"column":1}},"key":"CpcpsxSFyq"},{"type":"text","value":". You may see example code elsewhere\nthat takes the shortcut if it is available.","position":{"start":{"line":134,"column":1},"end":{"line":134,"column":1}},"key":"Ng71OhQmC2"}],"key":"VA6lKfrcIc"},{"type":"heading","depth":2,"position":{"start":{"line":138,"column":1},"end":{"line":138,"column":1}},"children":[{"type":"text","value":"Anonymous Reads from Endpoints Outside of S3 (that use the S3 API)","position":{"start":{"line":138,"column":1},"end":{"line":138,"column":1}},"key":"S1Y6sSCT1s"}],"identifier":"anonymous-reads-from-endpoints-outside-of-s3-that-use-the-s3-api","label":"Anonymous Reads from Endpoints Outside of S3 (that use the S3 API)","html_id":"anonymous-reads-from-endpoints-outside-of-s3-that-use-the-s3-api","implicit":true,"key":"HxB4RRzXDk"},{"type":"paragraph","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"children":[{"type":"text","value":"For storage operations, the S3 API needs the web address of the access point, or ","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"key":"IA8GH9Yx0k"},{"type":"emphasis","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"children":[{"type":"text","value":"endpoint","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"key":"AS5imwAQqc"}],"key":"wuzhmAvNXJ"},{"type":"text","value":" where it should address filesystem operations. If your storage is completely within the Amazon ecosystem, you will likely not need to specify an endpoint. However, for 3rd-party storage (such as the OSN pod), you will need to explicitly declare the endpoint when the filesystem is first referenced using ","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"key":"P82nEqyfNm"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"key":"wMtE4JnX29"},{"type":"text","value":". We can list the files stored in the ","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"key":"jzeIJUXDq1"},{"type":"inlineCode","value":"usgs-scratch","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"key":"wSNfwdcZpG"},{"type":"text","value":" bucket of the OSN pod with the following:","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"key":"Bs06rt2IGE"}],"key":"Zsj1Mthh05"},{"type":"code","lang":"python","value":"fs_osn = fsspec.filesystem(\n    's3',\n    anon=True,   # Does not require credentials\n    client_kwargs={'endpoint_url': 'https://usgs.osn.mghpcc.org'}\n)\nfs_osn.ls('s3://hytest')","position":{"start":{"line":142,"column":1},"end":{"line":149,"column":1}},"key":"ETQFtv1iIq"},{"type":"heading","depth":2,"position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"children":[{"type":"text","value":"Credentialed Access","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"key":"YzkXGQ15TB"}],"identifier":"credentialed-access","label":"Credentialed Access","html_id":"credentialed-access","implicit":true,"key":"qvOSfcdBmJ"},{"type":"paragraph","position":{"start":{"line":153,"column":1},"end":{"line":154,"column":1}},"children":[{"type":"text","value":"For some data storage within the HyTEST workflows, access will not be anonymous.\nPermissions are set by the owners of that data, and the rules governing your ability to read from or write to certain locations may be defined with a set of credentials assigned to an AWS ‘profile’.","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"TJMGjtOuV4"}],"key":"eObouz913N"},{"type":"paragraph","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"children":[{"type":"text","value":"Profile credentials are usually stored outside of the Python program, typically in a file in your ","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"rZvOoQ1i9r"},{"type":"inlineCode","value":"HOME","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"XRUDnrfJbl"},{"type":"text","value":" folder on the compute/jupyter server. You need to have this credential file set up before you can work with data in buckets requiring credentialed access. This section will demonstrate how to configure your OSN pod credentials in the same way that we would configure an AWS account profile - with the ","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"IuL2NtPP1v"},{"type":"inlineCode","value":"aws","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"UmY3AvBGZ7"},{"type":"text","value":" ","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"pcEHIElSFQ"},{"type":"link","url":"https://awscli.amazonaws.com/v2/documentation/api/latest/reference/configure/index.html","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"children":[{"type":"text","value":"command line interface","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"hVVzSTJEMY"}],"urlSource":"https://awscli.amazonaws.com/v2/documentation/api/latest/reference/configure/index.html","key":"K8oVsGO4Io"},{"type":"text","value":".","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"ENinfA7Si1"}],"key":"JY5byzbQ2g"},{"type":"paragraph","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"children":[{"type":"text","value":"To create a new AWS profile, which we will name ","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"key":"WIuLO0r2G1"},{"type":"inlineCode","value":"osn-hytest","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"key":"ZpkovkUE2G"},{"type":"text","value":":","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"key":"a4kKcKSVM6"}],"key":"uInMFW1bPe"},{"type":"code","lang":"sh","value":"> aws configure --profile osn-hytest\nAWS Access Key ID :\nAWS Secret Access Key :\nDefault region name : us-east-1\nDefault output format: json","position":{"start":{"line":160,"column":1},"end":{"line":166,"column":1}},"key":"tTQx1Reg8l"},{"type":"paragraph","position":{"start":{"line":168,"column":1},"end":{"line":169,"column":1}},"children":[{"type":"text","value":"The first two prompts will ask for key/security information you were assigned for access to object storage. Credentials for the OSN pod should have been provided by the HyTEST team if you need credentialed access to the OSN pod.\nThe default region for the OSN pod should be “us-east-1” because this is the region in which the pod is physically located, and default output format should be “json”.","position":{"start":{"line":168,"column":1},"end":{"line":168,"column":1}},"key":"eldyiHp9uq"}],"key":"wWXiR4svrQ"},{"type":"paragraph","position":{"start":{"line":171,"column":1},"end":{"line":172,"column":1}},"children":[{"type":"text","value":"Note that this configuration is specific to the OSN ‘pod’ storage.\nYour profile name and region may be different if you are setting up your credentials for an AWS S3 object storage bucket.","position":{"start":{"line":171,"column":1},"end":{"line":171,"column":1}},"key":"ly5rtzhu7t"}],"key":"ZbHGEVhaz7"},{"type":"paragraph","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"children":[{"type":"text","value":"We can now set up a virtual filesystem to access the OSN pod with the credentials stored in the ","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"key":"Cqf1fDtptB"},{"type":"inlineCode","value":"osn-hytest","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"key":"WrAq8k7tEm"},{"type":"text","value":" profile you just created. This credentialed access will grant you additional permissions that you did not have with the anonymous access we used above.","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"key":"kUTxTz8oHV"}],"key":"d6SftLupUr"},{"type":"code","lang":"python","value":"fs_osn = fsspec.filesystem(\n    's3',\n    profile='osn-hytest',  ## This is the profile name you configured above.\n    client_kwargs={'endpoint_url': 'https://usgs.osn.mghpcc.org'}\n)","position":{"start":{"line":176,"column":1},"end":{"line":182,"column":1}},"key":"usvNPnndHT"},{"type":"heading","depth":2,"position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"children":[{"type":"text","value":"Read-only access with “requester pays”","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"pMvUgXR4F0"}],"identifier":"read-only-access-with-requester-pays","label":"Read-only access with “requester pays”","html_id":"read-only-access-with-requester-pays","implicit":true,"key":"QXSnzBFqll"},{"type":"paragraph","position":{"start":{"line":186,"column":1},"end":{"line":190,"column":1}},"children":[{"type":"text","value":"Some datasets, such as the first example above (anonymous reading), are offered with ‘egress fees’ paid by the data owner.\nThis means that all access is free to anybody.\nThe cost of the network bandwidth used to serve the data is covered by the data’s host.\nNot all “public” data is offered this way: it is still available to anybody who wants to read it, but\nthe access fees must be paid by the reader (i.e. the ‘requester’).","position":{"start":{"line":186,"column":1},"end":{"line":186,"column":1}},"key":"gHdUnXsFvx"}],"key":"GK4UDN8Re9"},{"type":"paragraph","position":{"start":{"line":192,"column":1},"end":{"line":193,"column":1}},"children":[{"type":"text","value":"When you access a requester-pays dataset, your profile identifies the account which will be\nbilled for access.  Open such datasets with an extra option to ","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"EWrOVzbkvM"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"cghspSbOYQ"},{"type":"text","value":":","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"gUJX9870Gs"}],"key":"cTUUeZ9LBy"},{"type":"code","lang":"python","value":"fs_requesterpays = fsspec.filesystem(\n    's3',\n    profile='profile_name',\n    anon=False,\n    requester_pays=True\n)","position":{"start":{"line":195,"column":1},"end":{"line":202,"column":1}},"key":"XZMJ3JLqSC"},{"type":"paragraph","position":{"start":{"line":204,"column":1},"end":{"line":206,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"MP9OJDxAss"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"WtObgJEcRT"},{"type":"text","value":" call identifies how you will be interacting with object storage (your identity and what\nyou are willing to pay for).  File-system operations using that ","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"Mp51VYeGT9"},{"type":"inlineCode","value":"fs","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"DiKUJeWPvV"},{"type":"text","value":" handle will be made using that\nconfiguration.","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"ilEsOWUZ4m"}],"key":"ROOAEX4yd7"},{"type":"heading","depth":2,"position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"children":[{"type":"text","value":"Writing Data to S3","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"yzoIaOsRQ2"}],"identifier":"writing-data-to-s3","label":"Writing Data to S3","html_id":"writing-data-to-s3","implicit":true,"key":"sbKgNaJrpt"},{"type":"paragraph","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"children":[{"type":"text","value":"From within your Python program, writes to object storage can be achieved a few different ways, which we will demonstrate below. Writing data will typically require credentials. If this is the case, you should use an ","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"GUkwHhzNU6"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"vXXGvHs8FR"},{"type":"text","value":" filesystem with a profile defined, similar to the ","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"UhH3xP4bWH"},{"type":"inlineCode","value":"fs_osn","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"nD2U0FOn6m"},{"type":"text","value":" object that we created in the Credentialed Access section above.","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"MBT8Sjkars"}],"key":"qv24tPynRb"},{"type":"heading","depth":3,"position":{"start":{"line":212,"column":1},"end":{"line":212,"column":1}},"children":[{"type":"text","value":"Uploading a Local File to S3","position":{"start":{"line":212,"column":1},"end":{"line":212,"column":1}},"key":"oDlxA4WZgY"}],"identifier":"uploading-a-local-file-to-s3","label":"Uploading a Local File to S3","html_id":"uploading-a-local-file-to-s3","implicit":true,"key":"EjkPpQKBiV"},{"type":"paragraph","position":{"start":{"line":214,"column":1},"end":{"line":214,"column":1}},"children":[{"type":"text","value":"If you have a file saved on your local file system, and you would like to upload it directly to object storage, you can use the ","position":{"start":{"line":214,"column":1},"end":{"line":214,"column":1}},"key":"JtP4HAs9wP"},{"type":"inlineCode","value":"upload","position":{"start":{"line":214,"column":1},"end":{"line":214,"column":1}},"key":"hP9Y91gnJh"},{"type":"text","value":" method.","position":{"start":{"line":214,"column":1},"end":{"line":214,"column":1}},"key":"JS4pXtnJLp"}],"key":"v8FWTA7cmC"},{"type":"code","lang":"python","value":"fs_osn.upload('outfile.nc', 'hytest-scratch/testing/outfile.nc')","position":{"start":{"line":216,"column":1},"end":{"line":218,"column":1}},"key":"ZR5hS5eNSE"},{"type":"heading","depth":3,"position":{"start":{"line":220,"column":1},"end":{"line":220,"column":1}},"children":[{"type":"text","value":"Writing a Pandas Dataframe to a CSV File on S3","position":{"start":{"line":220,"column":1},"end":{"line":220,"column":1}},"key":"UhDvKpzhFq"}],"identifier":"writing-a-pandas-dataframe-to-a-csv-file-on-s3","label":"Writing a Pandas Dataframe to a CSV File on S3","html_id":"writing-a-pandas-dataframe-to-a-csv-file-on-s3","implicit":true,"key":"tzlSQ5zjVv"},{"type":"paragraph","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"children":[{"type":"text","value":"If you would like to write a pandas dataframe object directly to a csv file on object storage, you can do something like:","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"smKadSJ4aq"}],"key":"WZOoOkd4Wa"},{"type":"code","lang":"python","value":"with fs_osn.open(\"hytest-scratch/testing/outfile.csv\", mode='wt') as f:\n    pandas_df.to_csv(f)","position":{"start":{"line":224,"column":1},"end":{"line":227,"column":1}},"key":"AI18Jcc57w"},{"type":"heading","depth":3,"position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"children":[{"type":"text","value":"Writing Zarr Data to S3","position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"key":"qcUZsFHBjV"}],"identifier":"writing-zarr-data-to-s3","label":"Writing Zarr Data to S3","html_id":"writing-zarr-data-to-s3","implicit":true,"key":"OElJF9gE5x"},{"type":"paragraph","position":{"start":{"line":231,"column":1},"end":{"line":232,"column":1}},"children":[{"type":"text","value":"For zarr data, the most convenient way to write data to object storage is to use a ","position":{"start":{"line":231,"column":1},"end":{"line":231,"column":1}},"key":"DmWK8f2m49"},{"type":"inlineCode","value":"mapper","position":{"start":{"line":231,"column":1},"end":{"line":231,"column":1}},"key":"W1KayzTsnd"},{"type":"text","value":" to connect a file-like python object to\nthe object storage location:","position":{"start":{"line":231,"column":1},"end":{"line":231,"column":1}},"key":"kcuwGXrWPa"}],"key":"GkPKETVM0F"},{"type":"code","lang":"python","value":"fname='s3://hytest-scratch/testing/outfile.zarr'\noutfile=fs_osn.get_mapper(fname)\nxarray_dataset.to_zarr(outfile, mode='w', consolidated=True)","position":{"start":{"line":234,"column":1},"end":{"line":238,"column":1}},"key":"rhodaQd10T"},{"type":"paragraph","position":{"start":{"line":240,"column":1},"end":{"line":241,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"key":"M1Pi1iWPoi"},{"type":"inlineCode","value":"outfile","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"key":"yuRhBsHr7V"},{"type":"text","value":" variable can be used most anywhere that a file-like object is needed for\nwriting.","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"key":"DqrT0LPXIu"}],"key":"GxgrFt6oux"},{"type":"heading","depth":3,"position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"children":[{"type":"text","value":"Additional Commands","position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"key":"Hg02tFfzUn"}],"identifier":"additional-commands","label":"Additional Commands","html_id":"additional-commands","implicit":true,"key":"e2dHYSylY4"},{"type":"paragraph","position":{"start":{"line":245,"column":1},"end":{"line":246,"column":1}},"children":[{"type":"text","value":"With adequate permissions, you may be able to do more destructive activities to objects in a bucket (overwriting, removing, etc).\nExamples:","position":{"start":{"line":245,"column":1},"end":{"line":245,"column":1}},"key":"xvhYLjLge9"}],"key":"rmIx8XMHPp"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":248,"column":1},"end":{"line":251,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":248,"column":1},"end":{"line":248,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"mkdir","position":{"start":{"line":248,"column":1},"end":{"line":248,"column":1}},"key":"E2OlUtUDXS"},{"type":"text","value":" -- makes a new directory / folder","position":{"start":{"line":248,"column":1},"end":{"line":248,"column":1}},"key":"zVIy35ygrc"}],"key":"aZVot8BAXd"}],"key":"GXXMpnBiRT"},{"type":"listItem","spread":true,"position":{"start":{"line":249,"column":1},"end":{"line":249,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"mv","position":{"start":{"line":249,"column":1},"end":{"line":249,"column":1}},"key":"GfhUwmMLuB"},{"type":"text","value":" -- moves/renames a file or folder","position":{"start":{"line":249,"column":1},"end":{"line":249,"column":1}},"key":"ZtpmsfEUsA"}],"key":"dHZiTFSvPX"}],"key":"QKyr0yDxTE"},{"type":"listItem","spread":true,"position":{"start":{"line":250,"column":1},"end":{"line":251,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"rm","position":{"start":{"line":250,"column":1},"end":{"line":250,"column":1}},"key":"LMGKYs4mEL"},{"type":"text","value":" -- removes a file or folder","position":{"start":{"line":250,"column":1},"end":{"line":250,"column":1}},"key":"uJhovGNZWL"}],"key":"rvSoAkv2yC"}],"key":"mjGP7dKfAn"}],"key":"oJXiF3t2MB"},{"type":"paragraph","position":{"start":{"line":252,"column":1},"end":{"line":252,"column":1}},"children":[{"type":"text","value":"See the ","position":{"start":{"line":252,"column":1},"end":{"line":252,"column":1}},"key":"arFKyVxwwc"},{"type":"link","url":"https://filesystem-spec.readthedocs.io/en/latest/api.html","position":{"start":{"line":252,"column":1},"end":{"line":252,"column":1}},"children":[{"type":"text","value":"API documentation","position":{"start":{"line":252,"column":1},"end":{"line":252,"column":1}},"key":"jw2KhdAcgI"}],"urlSource":"https://filesystem-spec.readthedocs.io/en/latest/api.html","key":"NAnoO74RcZ"},{"type":"text","value":" for the full details of available operations.","position":{"start":{"line":252,"column":1},"end":{"line":252,"column":1}},"key":"om9I16iazj"}],"key":"DmsfMFcfPJ"}],"key":"gho3w3D4yR"}],"key":"iU8ef5DK4q"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Data/APIs","url":"/essential-reading/datasources/data-apis","group":"Getting Started"},"next":{"title":"Parallelism with Dask","url":"/essential-reading/parallel-dask","group":"Getting Started"}}},"domain":"http://localhost:3005"}