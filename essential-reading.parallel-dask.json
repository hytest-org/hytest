{"version":3,"kind":"Notebook","sha256":"380256cc199185138e6ec2632d5dbf9f82adaf2994f5f969f57dead1724b41ca","slug":"essential-reading.parallel-dask","location":"/essential_reading/Parallel_Dask.ipynb","dependencies":[],"frontmatter":{"title":"Parallelism with Dask","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":1}},"source_url":"https://github.com/hytest-org/hytest/blob/main/essential_reading/Parallel_Dask.ipynb","edit_url":"https://github.com/hytest-org/hytest/edit/main/essential_reading/Parallel_Dask.ipynb","exports":[{"format":"ipynb","filename":"Parallel_Dask.ipynb","url":"/hytest//build/Parallel_Dask-fd841e28edcbfdd6ef7d0406b3eb086d.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"The dask folks have a very good introduction to dask data structures and parallelism in their\n","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"L5OcYeR7NJ"},{"type":"link","url":"https://tutorial.dask.org/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"dask tutorial","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"y7bdzVvPOR"}],"urlSource":"https://tutorial.dask.org/","key":"fXlg37wP9P"},{"type":"text","value":".  In that tutorial, you’ll get exposure to\nthe general dask architecture, as well as specific hands-on examples with two of the three\nkey dask data structures:  dask arrays, and dask dataframes.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HcSwiaOcfa"}],"key":"buk9cYOEX7"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"The above tutorial does not cover dask ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"tB0q6kiU0Z"},{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"inlineCode","value":"bag","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"kE1HJS3Av5"}],"key":"QvFM0paGzX"},{"type":"text","value":" in any detail -- this is a key data structure\nthat we use to distribute parallel tasks in clustered environments.  Here’s a quick demo of\na dask bag and how we use it. A bag is analagous to a standard Python ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"XZKgy6AlIM"},{"type":"inlineCode","value":"list","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"JLIQA0OAwC"},{"type":"text","value":"... let’s start there\nwith some nomenclature:","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"ZwYeUuWkz7"}],"key":"jOeHQNoljK"}],"key":"i38LMKjxBY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Lists and Maps","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iJEYUPaBpp"}],"identifier":"lists-and-maps","label":"Lists and Maps","html_id":"lists-and-maps","implicit":true,"key":"SEp3a4z8Ud"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"A common pattern in Python is a ‘list comprehension’ -- a way of transforming a list of values into a new list of values using a transformation pattern.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Nbg426bKCs"}],"key":"FL1A43IypJ"}],"key":"hwttPXwKKn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"myList = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\nnewList = [x**2 for x in myList]\n\nnewList","key":"D0GBH0hPz3"},{"type":"outputs","id":"-7lWDdIj-H0bvQwP7N9Fb","children":[],"key":"svHTt3OA0O"}],"key":"W4aA66k54F"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"This feature of python ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y9GYySd3Xq"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"maps","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bXQumCGnxL"}],"key":"YnaKNIVueZ"},{"type":"text","value":" an action onto each element in a list. The result is a new list\nholding the result of each action -- one action per element in the list.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KXB5AZ790t"}],"key":"AjXfA4BcKi"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"The syntax of the above list comprehension is purely for us\nhumans. The python implementation behind the scenes uses a special built-in python function\ncalled ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Hvj2mDKBqz"},{"type":"inlineCode","value":"map","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"orvyD6illq"},{"type":"text","value":":","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"a6dHQ2LBZt"}],"key":"j8mfj7CqnF"}],"key":"P4Zqibu4Gz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def myFunc(i):\n    return i**2\n\nlist(map(myFunc, myList))\n# maps each element of myList to a separate invokation of myFunc. ","key":"wLkSE9Vwqi"},{"type":"outputs","id":"1xeqX6vUCL78GXFsbSEZJ","children":[],"key":"qTOvXz2uDW"}],"key":"YT5glf4Iwp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Qd9aWwPMBW"},{"type":"inlineCode","value":"map()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DN7GpbV0XQ"},{"type":"text","value":" call handles the work of calling ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kbWFMgmDb5"},{"type":"inlineCode","value":"myFunc()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YFB3yRiGUn"},{"type":"text","value":" once each for the elements of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Wf5PBSAVP4"},{"type":"inlineCode","value":"myList","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jXvxDT2Ryu"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jLvsJ09Va7"},{"type":"break","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zClsG2oIVB"},{"type":"text","value":"You can see that doing it this way involves a lot of extra hoops and parenthesis to jump through.\nWhich is why it is almost never written that way.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PCr053pGb0"}],"key":"fwn0vBc783"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The list element is given to the function as a positional argument.  In essence, the above ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"YpJ1nrmw3Y"},{"type":"inlineCode","value":"map","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"FJBVKROPXI"},{"type":"text","value":" is the same as:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"JTEDUsCNEf"}],"key":"QAiZOOkm8u"}],"key":"mgQCsHfuI9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result=[]\nfor x in myList:\n    result.append(myFunc(x))\nresult","key":"YKb8Mk5coX"},{"type":"outputs","id":"lcFYqBh5Zp5OkpUzRSg74","children":[],"key":"r3HU9u670F"}],"key":"D1jScqISXQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Dask Bag","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G02NXrsf18"}],"identifier":"dask-bag","label":"Dask Bag","html_id":"dask-bag","implicit":true,"key":"u5NfbE7ZCl"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"A dask bag datastructure is much like a list, but it has the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T8p9JO4ouR"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"map","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PyvEK0fZWQ"}],"key":"WoJ5Z5Uc7h"},{"type":"text","value":" function built into it as\nan object method. The invocation is slightly different, but the concept is the same: it\npairs up elements of a list with a function call to execute against those elements.  A dask\nbag has the ability to spawn the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"U6JKAkfGUa"},{"type":"inlineCode","value":"myFunc()","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T13w1zRAEs"},{"type":"text","value":" calls in parallel, distributing those calls to\nworkers around the dask cluster.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cb68X3r9qb"}],"key":"Y6XHx7xiP7"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Let’s look at an example... first, let’s make ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"SVJdlAIcF1"},{"type":"inlineCode","value":"myFunc()","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"KwYHfEBamC"},{"type":"text","value":" simulate time-consuming work by having\nit pause for a while.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"mg9q0e3tXQ"}],"key":"jwDoy7HRm5"}],"key":"ZgKSmmmBNw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from time import sleep\ndef myFunc(i):\n    sleep(1) ## Simulates dense computation taking one second\n    return i**2","key":"rdokevbi1M"},{"type":"outputs","id":"3uo2y5Nm6-SKc0U85w2Tm","children":[],"key":"cINPmJqTUK"}],"key":"sUMACeGhCv"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This function is one that we want to distribute across a dask compute cluster.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GhloV5WLAN"}],"key":"dkA5T5WoRH"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"For this small demonstration, we’ll build a cluster on the local host; no need to\nmake a distributed cluster.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VZBMCXGdzZ"}],"key":"bmqf58et2R"}],"key":"FZfmrLVmiw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport dask.bag as db\n\nfrom dask.distributed import Client, LocalCluster\ncluster = LocalCluster(threads_per_worker=os.cpu_count())\nclient = Client(cluster)","key":"MZNsAcnzHy"},{"type":"outputs","id":"vreaguFxabUcAoS0fs_DO","children":[],"key":"aImtQ7wWKg"}],"key":"ld6zzV42T4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# fill the bag with our list of items\nmyBag = db.from_sequence(myList)\n# then 'map' the elements to the worker function we want to execute on each element in the bag\nresult = myBag.map(myFunc)","key":"pKxtGBfYAR"},{"type":"outputs","id":"VieU9Dz8ncQsUHUOZe2nd","children":[],"key":"wMFiWGThnl"}],"key":"DX0lJy4y2Y"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Note that this returned immediately (i.e very small execution time). That’s because the\ncomputation has not been done yet. Dask is a ‘lazy’ system in which computations are\ndelayed as long as possible.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sDLMXmJmu5"}],"key":"VI4okklRTF"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"As with other dask operations, ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"bMkLZ3LUvj"},{"type":"inlineCode","value":"result","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"u2twAp1kCH"},{"type":"text","value":" at this point just contains the ‘task graph’ -- what\ndask is going to do, and in what order.  We can see that task graph with the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"TfpGVciUBJ"},{"type":"inlineCode","value":"visualize","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"VAtjNZi3aK"},{"type":"text","value":"\nmethod:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KnzEWNMdVd"}],"key":"I5efcaInCq"}],"key":"pWCm2N5G2p"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result.visualize()","key":"eeEESOzQaF"},{"type":"outputs","id":"I8aS8tHnTlihw1JQvWFWA","children":[],"key":"l8WKDvhO0e"}],"key":"RoBqqfx7A1"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Note that each of those elements is independent from the others, so they can in theory execute in parallel.\n‘Thread’ zero will call myFunc with some arguments to produce result zero.  Same with threads 1 throuth 9.\nBecause these threads do not depend on one another, they can operate in parallel, on separate workers.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IcHZ7f6tMz"}],"key":"yrb3435XQb"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"In the original, pure-python operation, these calls to ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"p0n6dF1SoS"},{"type":"inlineCode","value":"myFunc","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"t336b4Jmox"},{"type":"text","value":" would be serialized: one at a time.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q59LH1EXNV"}],"key":"AYFu7b6evd"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Let’s compare run times:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"B8AaYkDcrC"}],"key":"gETh67upSm"}],"key":"YuSp76bPGP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time  \n# should take about 10 seconds: one second per call to myFunc\n## Pure python mapping:\nlist( map( myFunc, myList))","key":"EiW18oczYM"},{"type":"outputs","id":"2ftl0-AXa2up6RvuYfZJn","children":[],"key":"iJ8JEbcwEP"}],"key":"PlDyiyVUwl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n## using the dask bag task-graph\nresult.compute()","key":"DCrASjEJGj"},{"type":"outputs","id":"Lbv64C_qTuaMG7kvw8DEe","children":[],"key":"txue6VpMeP"}],"key":"OC5RG7M4ib"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note that the pure python execution took right around 10 seconds.  Each call to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KAE1lgXyCI"},{"type":"inlineCode","value":"myFunc","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hJgqIinjvq"},{"type":"text","value":", remember, is artificially set to take one second each.  Calling them serially should take 10 seconds (plus whatever internal overhead python needs).","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AB5i1g9Qtd"}],"key":"N2Ghc2Nldj"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The dask bag approach took substantially less time. If it were ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BSOZdrbSFk"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"perfectly","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dFDBG1KBAb"}],"key":"GIib9YsFVI"},{"type":"text","value":" parallel, the result would have been computed in one second (ten simultaneous executions of ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ab2HVI8xw6"},{"type":"inlineCode","value":"myFunc","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"etThfTYTYP"},{"type":"text","value":", each taking one second).  But that parallelism depends on how many cpus/cores you have.  If you only have one core, then parallelism isn’t going to help  you -- the dispatched workers still need to take turns on the CPU.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nBaLmRK7Ak"}],"key":"CB6sjr0DA1"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"If you had 10 cores (the number of elements in the bag), then you might get close to the perfect parallelism.  Dask does involve more overhead than pure python in order to achieve its parallelism; the administrative overhead for operating the cluster scheduler will prevent this from being perfectly parallel.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kUFQC5aWCD"}],"key":"ltphQiJJVu"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The above example uses a ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"nPoPShlcJ1"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"local","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"JXDef6L1WQ"}],"key":"A8s0ZNaKjb"},{"type":"text","value":" cluster, meaning that the work is scheduled among the CPUs on the local hardware.  Dask can also utilize ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"w8NSzQaVEX"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"distributed","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"AxtKbX5gZV"}],"key":"gZN0Z0Hwsb"},{"type":"text","value":" clusters, meaning that workers can be organized among several computers connected via network. This allows for many more CPUs to attach to a problem, but the overhead of network communication will impact the administrative costs of coordinating the workers.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"gNJuBU8m2Z"}],"key":"Vavc4vvbCS"}],"key":"DoPwU9Vu3M"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"## shut down cluster scheduler\nclient.close(); del client\ncluster.close(); del cluster","key":"YayvU76X9a"},{"type":"outputs","id":"SBrIJEtFErr6zObdu74DR","children":[],"key":"c80ooyNbgW"}],"key":"rFptBORepD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Dask Bags in HyTEST Workflows","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bWWfRcOqaI"}],"identifier":"dask-bags-in-hytest-workflows","label":"Dask Bags in HyTEST Workflows","html_id":"dask-bags-in-hytest-workflows","implicit":true,"key":"j3Tlc4MZye"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This pattern is used extensively in the benchmarking workflows.  A series of statistics are calculated for each streamgage in a list of 5000+ gages. With a dask bag (the contents of which is the list of gages), the stats package can be dispatched to workers operating independently and in parallel.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"fcnFptV8Ez"}],"key":"QVqRplMkcV"}],"key":"DX4veI638m"}],"key":"DOWNMooGbL"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Data/Cloud Storage","url":"/essential-reading/datasources/data-s3","group":"Getting Started"},"next":{"title":"Data Catalogs","url":"/dataset-catalog/readme","group":"Dataset Access"}}},"domain":"http://localhost:3005"}