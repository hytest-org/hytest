{"version":3,"kind":"Notebook","sha256":"8b293dec2c48a4dbc32bb045137bd80ce8bd4aed8db457af0fdd63009f0826cc","slug":"evaluation.tutorials.stats-demos.usage-dscore-suite-v1","location":"/evaluation/tutorials/stats_demos/Usage_DScore_Suite_v1.ipynb","dependencies":[],"frontmatter":{"title":"D-Score Suite (v1) Benchmark -- Usage Examples","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":2}},"source_url":"https://github.com/hytest-org/hytest/blob/main/evaluation/tutorials/stats_demos/Usage_DScore_Suite_v1.ipynb","edit_url":"https://github.com/hytest-org/hytest/edit/main/evaluation/tutorials/stats_demos/Usage_DScore_Suite_v1.ipynb","exports":[{"format":"ipynb","filename":"Usage_DScore_Suite_v1.ipynb","url":"/hytest//build/Usage_DScore_Suite_v-84f1000d7e3a54f0e0c715db816aa978.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"blockquote","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook adapted from originals by Timothy Hodson and Rich Signell. See that upstream work at:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"v1VMjvqAvh"}],"key":"n5XwLnLN1U"}],"key":"PwtEV92CH4"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://github.com/thodson-usgs/dscore","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"https://​github​.com​/thodson​-usgs​/dscore","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Q19RMPWMtc"}],"urlSource":"https://github.com/thodson-usgs/dscore","error":true,"key":"POlO3c9NgE"}],"key":"OSV4HJ4CDA"}],"key":"Vax4IRFAGa"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://github.com/USGS-python/hytest-evaluation-workflows/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"https://​github​.com​/USGS​-python​/hytest​-evaluation​-workflows/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dtqm9iXTWX"}],"urlSource":"https://github.com/USGS-python/hytest-evaluation-workflows/","error":true,"key":"DoxCENSNZo"}],"key":"KLHnp6WMc0"}],"key":"hOtRtvNVje"}],"key":"wZ7BhyVcdH"}],"key":"LvJDAj6CnU"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"This notebook will demonstrate how to call the specific functions defined in the d-score metrics suite notebook (Metrics_Dscore_Suite_v1.ipynb), using a small demonstration dataset.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EFT5ChhPW4"}],"key":"zkX7D4b6c4"}],"key":"g8YFgFFX7h"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nimport numpy as np","key":"cOR5RTy2dv"},{"type":"outputs","id":"xxYZurxFri4Ry31GGZyVa","children":[],"key":"XYHwPKybQi"}],"key":"MZCtoUGYHi"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Sample Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vJFeUo7XUt"}],"identifier":"sample-data","label":"Sample Data","html_id":"sample-data","implicit":true,"key":"Qdaj4D4hxE"}],"key":"KcBU1LRP7Q"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sampleData = pd.read_csv(r\"../streamflow/NWM_Benchmark_SampleData.csv\", index_col='date', parse_dates=True).dropna()\nprint(len(sampleData.index), \" Records\")","key":"lPCT6PLql6"},{"type":"outputs","id":"mEjBL8KdOSLBfl8JLbD_y","children":[],"key":"alZpvrDO5V"}],"key":"LCDdRoRtcP"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"A quick look at the table shows that this data contains time-series streamflow values for\nobserved (‘obs’), the NWM data model (‘nwm’), and the NHM model (‘nhm’).  This demonstration\ndataset limits to a single gage (“","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TjPabY4INU"},{"type":"inlineCode","value":"site_no","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MNoXn6bUZt"},{"type":"text","value":" = 01104200”)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kmr83mqURa"}],"key":"EDIVFbkSbK"}],"key":"p3ype2xh3k"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sampleData.head()","key":"Ueru5QutbO"},{"type":"outputs","id":"t4-qzX8ro7DsjxuXgEPF-","children":[],"key":"YxdJQG00xX"}],"key":"ct0wAnb8q9"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Import Benchmark Functions","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uNbX2h9ios"}],"identifier":"import-benchmark-functions","label":"Import Benchmark Functions","html_id":"import-benchmark-functions","implicit":true,"key":"wmNk1ATtDS"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The metric functions are defined and described in\n","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"UbN1ks8jF6"},{"type":"link","url":"/evaluation/metrics-dscore-suite-v1","urlSource":"/evaluation/Metrics_DScore_Suite_v1","dataUrl":"/evaluation.metrics-dscore-suite-v1.json","internal":true,"children":[{"type":"text","value":"D-Score Suite (v1) Benchmark","key":"o3MGS3jOMW"}],"protocol":"file","key":"zicqz0zksL"},{"type":"text","value":".\nThey are imported here by running that notebook from within the following cell:","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"OgA4GcN8zu"}],"key":"Pz9175zb62"}],"key":"jCIGSvukt5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%run ../../Metrics_DScore_Suite_v1.ipynb","key":"Q5MY1vZLrF"},{"type":"outputs","id":"ny64iz5kZlv7zq1CyUxep","children":[],"key":"hxlgqhrRFy"}],"key":"JWSiTowPpS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The functions are now available here, to run against our sample data:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gym5yNAtd2"}],"key":"KRw0NIoe7Z"}],"key":"Ht03PiodSM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Mean Square Error\nmse(sampleData['obs'], sampleData['nwm'])","key":"DXcK10cy4P"},{"type":"outputs","id":"VLMSp6An1zimlimH8pfsy","children":[],"key":"B9BTOcezPc"}],"key":"qfUGDf8tKG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"seasonal_mse(sampleData['obs'], sampleData['nwm'])","key":"li6h3TcOxf"},{"type":"outputs","id":"f6kwIfsgeVjk8N8iO9vv9","children":[],"key":"XrFR5dJlx0"}],"key":"iKfY7OpNIY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create Composite Benchmark","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UMQV0jWBCm"}],"identifier":"create-composite-benchmark","label":"Create Composite Benchmark","html_id":"create-composite-benchmark","implicit":true,"key":"HRt1djqsH1"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"It is useful to combine several of these metrics into a single benchmark routine, which returns a pandas Series of the assembled metrics.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"SGYmcMtGsk"}],"key":"S37zZcl5c3"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This ‘wrapper’ composite benchmark also handles any transforms of the data before calling the metric functions. In this case, we will log transform the data.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"e76GBrqhJe"}],"key":"kEmkhCTnQr"}],"key":"VHSk6YOhrd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def compute_benchmark(df):\n    \"\"\"\n    Runs several metrics against the data table in 'df'.  \n\n    NOTE: the 'obs' and 'nwm' columns must exist in df, and that nan's have already been removed.  \n    \"\"\"\n    obs = np.log(df['obs'].clip(lower=0.01)) # clip to remove zeros and negative values\n    sim = np.log(df['nwm'].clip(lower=0.01)) \n    \n    mse_ = pd.Series(\n        [ mse(obs, sim) ], \n        index=[\"mse\"], \n        dtype='float32'\n    )\n    return pd.concat([\n            mse_,\n            bias_distribution_sequence(obs, sim), \n            stl(obs, sim),\n            seasonal_mse(obs, sim),\n            quantile_mse(obs, sim)\n            ],\n        )","key":"ssd2Cr3KMT"},{"type":"outputs","id":"BdE6y9iyXNCstSycA8DAk","children":[],"key":"lq260wwSV0"}],"key":"s3fFkTiFTl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"compute_benchmark(sampleData)","key":"zLIMx3cn8D"},{"type":"outputs","id":"tSC6BoNlk9mk1JPzwZERE","children":[],"key":"Ch1QZ0WFHS"}],"key":"ASMfJTPN07"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Score-Cards","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OJ5EFRrY2g"}],"identifier":"score-cards","label":"Score-Cards","html_id":"score-cards","implicit":true,"key":"YDaRcN9g4g"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"The D-score functions include an ILAMB-style scorecard function to produce a graphic scorecard from these metrics.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Q7qrCfKLoQ"}],"key":"nIU2ygDUAM"},{"type":"blockquote","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Note that a scorecard such as this is typically applied to a composite of D-score metrics computed for many gages.\nThis demos the scorecard for a single gage ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wmykiYVeXY"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"as if","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"f8jkBdUb1h"}],"key":"EsKUcOqVf3"},{"type":"text","value":" it were the mean of all gages in an evaluation analysis.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aE7paZ1BoB"}],"key":"Xzam67RdZp"}],"key":"ALqfPEgqHT"}],"key":"togWN9BufS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Compute benchmark and 'score' each decomp as percent of total MSE\nbm = compute_benchmark(sampleData)\npercentage_card = pd.DataFrame(data={\n    'NWM' : ((bm / bm['mse']) * 100).round().astype(int)\n    })\npercentage_card.name=\"Percent\"  ## NOTE: `name` is a non-standard attribute for a dataframe. We use it to stash\n                                ## metadata for this dataframe which the ilamb_card_II() func will use to label things.\npercentage_card","key":"BF51gabj3D"},{"type":"outputs","id":"4zrI2YVWM8eBF9AHZO5tZ","children":[],"key":"NBaDAz8p21"}],"key":"U06UFH4wxH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"n_cards=1\nfig, ax = plt.subplots(1, n_cards, figsize=(0.5+(1.5*n_cards), 3.25), dpi=150)\nax = ilamb_card_II(percentage_card, ax)\nplt.show()","key":"lZVGRFLdm2"},{"type":"outputs","id":"gXeoJQJDqdawPKmp-rdg8","children":[],"key":"g9OaipCpNS"}],"key":"vHFdBvDWW8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"## if the score card has columns for multilple models.....  \n# fictitious example:\npercentage_card['XYZ'] = pd.Series([100, 20, 30, 20, 10, 50, 60, 70, 20, 10, 40, 65, 15,10,5], index=percentage_card.index)\nfig, ax = plt.subplots(1, n_cards, figsize=(0.5+(1.5*n_cards), 3.25), dpi=150)\nax = ilamb_card_II(percentage_card, ax)\nplt.show()","key":"dKc5N5vf7b"},{"type":"outputs","id":"nXcqH-TC4gGPZXEkbLLXq","children":[],"key":"jU78FOo7TY"}],"key":"crAjfM5ALP"}],"key":"n1svOP7OJL"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"D-Score Suite (v1) Benchmark","url":"/evaluation/metrics-dscore-suite-v1","group":"Model Evaluation"},"next":{"title":"Standard Suite (v1) Metrics","url":"/evaluation/metrics-stdsuite-v1","group":"Model Evaluation"}}},"domain":"http://localhost:3005"}