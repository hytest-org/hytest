{"version":3,"kind":"Notebook","sha256":"8249e62a1b9d99941277e1e8fefdca32529e124f40dec19f76c3451300b8ccd6","slug":"evaluation.tutorials.streamflow.analysis-stdsuite","location":"/evaluation/tutorials/streamflow/02_Analysis_StdSuite.ipynb","dependencies":[],"frontmatter":{"title":"Streamflow Eval :: StdSuite Analysis","content_includes_title":false,"github":"https://github.com/hytest-org/hytest","copyright":"2023","numbering":{"title":{"offset":2}},"source_url":"https://github.com/hytest-org/hytest/blob/main/evaluation/tutorials/streamflow/02_Analysis_StdSuite.ipynb","edit_url":"https://github.com/hytest-org/hytest/edit/main/evaluation/tutorials/streamflow/02_Analysis_StdSuite.ipynb","thumbnail":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","exports":[{"format":"ipynb","filename":"02_Analysis_StdSuite.ipynb","url":"/hytest//build/02_Analysis_StdSuite-b577c17e0f2b463f793e5ad22ca05760.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"image","url":"/hytest//build/Eval_Analysis-eb8e65bd4b4cb18860a5d6d1ad2f987f.svg","width":600,"key":"x2hC0Xf3EF","urlSource":"../../../doc/assets/Eval_Analysis.svg"},{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Essential Benchmark Components","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"RxjpP6zeyJ"}],"identifier":"essential-benchmark-components","label":"Essential Benchmark Components","html_id":"essential-benchmark-components","implicit":true,"key":"XPcZ019X8u"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"This benchmark notebook will present a workflow which follows a canonical model for Essential Benchmark Components:","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"YnGA8nB4ly"}],"key":"y4b2FFHRL4"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of predictions and matching observation (the data);","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"HJJAzcXP3u"}],"key":"o4s7PS6BUR"}],"key":"fCuyX4TzNb"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The domain (e.g. space or time) over which to benchmark;","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"f37QanctU3"}],"key":"LAcoXPXe65"}],"key":"KhiAmPjbcg"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of statistical metrics with which to benchmark.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"p2E9CxNUFN"}],"key":"sZu32WN185"}],"key":"odFjBicimM"}],"key":"z6SPD1xgb6"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Let’s get started.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"NGNJxi5hqx"}],"key":"ffU4Gm4iq1"}],"key":"D15OxTkXRG"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 0: Load libraries and configure Python computing environment","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DjYFcdRxme"}],"identifier":"step-0-load-libraries-and-configure-python-computing-environment","label":"Step 0: Load libraries and configure Python computing environment","html_id":"step-0-load-libraries-and-configure-python-computing-environment","implicit":true,"key":"Odl2wYhs7H"}],"key":"MO7nYW8FSS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nimport logging\nimport os\n# Needed when boto3 >= 1.36.0 or the rechunking process will fail\n# This needs to be set before the boto3 library gets loaded\n# See: https://github.com/aws/aws-cli/issues/9214#issuecomment-2606619168\nos.environ['AWS_REQUEST_CHECKSUM_CALCULATION'] = 'when_required'\nos.environ['AWS_RESPONSE_CHECKSUM_VALIDATION'] = 'when_required'","key":"muO2Ah0900"},{"type":"outputs","id":"71uEurmvmIfipuF_hQn0B","children":[],"key":"nHDnfVszXr"}],"key":"pIKq9FlNsZ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 1: Load Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FfJhU49d6N"}],"identifier":"step-1-load-data","label":"Step 1: Load Data","html_id":"step-1-load-data","implicit":true,"key":"BxKVwR4ZZO"},{"type":"image","url":"/hytest//build/Eval_Analysis_Data-42d85b915a6dd4eed989899a26499bbc.svg","width":360,"key":"q7K4yBp1uS","urlSource":"../../../doc/assets/Eval_Analysis_Data.svg"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Essential Benchmark Components:","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"xMQ2Owvz55"}],"key":"ompKoqEk1C"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"span","style":{"color":"green","fontSize":"large"},"children":[{"type":"text","value":"A set of predictions and matching observations","key":"ma0pDDxmw7"}],"key":"pyUkYslQOd"}],"key":"oY6WuikyS5"}],"key":"vLE80jFaa2"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The domain over which to benchmark","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"f7Tm9xLqbQ"}],"key":"PITr1SEFqT"}],"key":"fdD2YOdWf4"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of statistical metrics with which to benchmark.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Xbzg1GPBYf"}],"key":"gwSCVbqrB6"}],"key":"M9cT1Spk7P"}],"key":"coKmpHIg73"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Finding and loading data is made easier for this particular workflow (the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"SPtCmvsZ1C"},{"type":"emphasis","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"streamflow","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"drNwp7rD3F"}],"key":"q4yfIlohpe"},{"type":"text","value":" variable), in that most of it has been\npre-processed and stored in a cloud-friendly format.  That process is described in the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"GaQQVWOnQy"},{"type":"link","url":"/evaluation/tutorials/streamflow/data-prep","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"data preparation","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"teWqSVFNda"}],"urlSource":"01_Data_Prep.ipynb","dataUrl":"/evaluation.tutorials.streamflow.data-prep.json","internal":true,"protocol":"file","key":"iBKxwTa96n"},{"type":"text","value":"\nnotebook. We will proceed here using the already-prepared data for ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"GrxHoM7n6h"},{"type":"emphasis","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"streamflow","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"in8axeqoIg"}],"key":"lQnkmFLHC7"},{"type":"text","value":", which is included in the HyTEST ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"IeGArfHpq1"},{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"intake catalog","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"nMlf2zUXJf"}],"key":"dr4beiu1al"},{"type":"text","value":".","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"fUt9oeVntT"}],"key":"gXsyQoDBaN"},{"type":"aside","children":[{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Learn more about ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"F2z78RXjIR"},{"type":"inlineCode","value":"intake","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"jnWTIujDN9"},{"type":"text","value":" ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"K225QWwh3C"},{"type":"link","url":"/dataset-catalog/readme","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"DjvXocOJVm"}],"urlSource":"../../../dataset_catalog/README.md","dataUrl":"/dataset-catalog.readme.json","internal":true,"protocol":"file","key":"y8PkuDS9qG"}],"key":"NN6MbdQouN"}],"key":"UYjiL269Wm"}],"key":"uvUWOl4Wel"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import intake\ncat = intake.open_catalog(r'https://raw.githubusercontent.com/hytest-org/hytest/main/dataset_catalog/hytest_intake_catalog.yml')\nprint(\"Available datasets: \\n\", \"\\n\".join(cat.keys()))","key":"bq4M7TahFH"},{"type":"outputs","id":"FhXVdU8ICHPytDOUenqYN","children":[],"key":"j7OBD7tsMr"}],"key":"mRDsRjLNTy"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The above list represents the processed datasets available for benchmarking.  If a dataset\nyou want is not in that list,\nyou can load the data manually via direct connection to ‘on-prem’ or S3 object storage.\nIf you load data from a source other than this list, you can jump to Step 2: Restrict to a Domain","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WpHZ0b209o"}],"key":"f3TYZAkid5"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Note that the interesting datasets in the cataloged dataset above are duplicated: Some are ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"DJeiBRj5tt"},{"type":"inlineCode","value":"-onprem","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"x9VbBfkrso"},{"type":"text","value":"\nand some are ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"lLqqPbuH7L"},{"type":"inlineCode","value":"-cloud","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ywEZZYA7EO"},{"type":"text","value":". Same data, but the storage location and access protocol will be different. You\nwill definitely want to use the correct copy of the data for your computing environment.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"WN6qeFkKkp"}],"key":"tbAvD9o02Q"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"onprem","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ge0cRwZUXk"},{"type":"text","value":" : Direct access via the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"vpdol00vMs"},{"type":"inlineCode","value":"caldera","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"wMuf5uI7xd"},{"type":"text","value":" filesystem from ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"EXHrmV9HCU"},{"type":"emphasis","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"denali","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"rzG7TwdoJg"}],"key":"KsKJ1VoUcY"},{"type":"text","value":" or ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"dAJ58XMNen"},{"type":"emphasis","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"tallgrass","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"oThMyNwaCk"}],"key":"URW4HGOoQc"}],"key":"xKBKl5FHTg"}],"key":"CvTQ5S9ZsF"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"cloud","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"vhafk83Ryl"},{"type":"text","value":" : Network access via S3 bucket, suitable for consumption on cloud-hosted jupyter servers. You could also access using any network-attached computer, but the amount of data will likely saturate your connection.  Use in the cloud (e.g. ESIP QHub)","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"AS8UApAKMV"}],"key":"w2JXfbcB0o"}],"key":"h7WYFunWHe"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"osn","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"Dt5onZpZWo"},{"type":"text","value":" : Network access via OSN pod, which uses the S3 API, suitable for consumption on any jupyter server.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"T0jP3L94e7"}],"key":"l8ssbn3XB3"}],"key":"BGbE4fWo4V"}],"key":"Hj4b41RHKG"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"So... are you on-prem?","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"Gmfr8bHtW6"}],"key":"kMSJVvJ3Lg"}],"key":"YzEZGRmNCa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import platform\nonprem = (platform.node() in ['denali', 'tallgrass'])  # NOTE: these hostnames are not quite correct... this will always return not onprem.\nif onprem:\n    print(\"Yes : -onprem\")\n    obs_data_src='nwis-streamflow-usgs-gages-onprem'\n    mod_data_src='nwm21-streamflow-usgs-gages-onprem'\nelse:\n    print(\"Not onprem; use '-osn' data source\")\n    obs_data_src='nwis-streamflow-usgs-gages-osn'\n    mod_data_src='nwm21-streamflow-usgs-gages-osn'\nprint(\"Observed : \", obs_data_src)\nprint(\"Modeled  : \", mod_data_src)","key":"jJjkp9mgNY"},{"type":"outputs","id":"44Xcsu6nabVl_83ccFruJ","children":[],"key":"dOjCgA6DlJ"}],"key":"yMVhyvMfcI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"variable_of_interest = 'streamflow'\ntry:\n    obs = cat[obs_data_src].to_dask()\n    mod = cat[mod_data_src].to_dask()\nexcept KeyError:\n    print(\"Something wrong with dataset names.\")\n    raise\n\ntry:\n    obs_data = obs[variable_of_interest]\n    mod_data = mod[variable_of_interest].astype('float32')\nexcept KeyError:\n    print(f\"{variable_of_interest} was not found in these data.\")\n\nobs_data.name = 'observed'\nmod_data.name = 'predicted'    ","key":"c0XpWuJIZh"},{"type":"outputs","id":"FigVMSRrOdQvZcIiJkWGn","children":[],"key":"Lco8lftkNs"}],"key":"YWa16htAEg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 2: Restrict to a Domain","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PCytb94KC9"}],"identifier":"step-2-restrict-to-a-domain","label":"Step 2: Restrict to a Domain","html_id":"step-2-restrict-to-a-domain","implicit":true,"key":"qK60Van2pH"},{"type":"image","url":"/hytest//build/Eval_Analysis_Domain-d4724d8582a29d135d32b3f51b014b29.svg","width":360,"key":"V0s0MzJdyp","urlSource":"../../../doc/assets/Eval_Analysis_Domain.svg"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Essential Benchmark Components:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"tt1m3zcGZO"}],"key":"Wu9ZptgMP7"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of predictions and matching observations,","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"SUkAB8y3iC"}],"key":"LnH3yz7EgM"}],"key":"g5XSk1wh5M"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"span","style":{"color":"green","fontSize":"large"},"children":[{"type":"text","value":"The domain over which to benchmark","key":"QgIhcabOJD"}],"key":"hUWvWDkcxA"}],"key":"guarMyErHd"}],"key":"jX9iw9vwwv"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of statistical metrics with which to benchmark.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"z7Yf4XnMvQ"}],"key":"X6EJutrDYZ"}],"key":"Dw5xQR78N5"}],"key":"rPnPh6zFFr"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Each benchmark domain is defined over specific bounds (typically space and/or time).\nBenchmark domain definitions can be defined within the notebook, or sourced from\nelsewhere. For this example, we use the ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"wg3uKpdoUn"},{"type":"emphasis","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Cobalt","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"jDqqwUrT7h"}],"key":"zrVXehtE6D"},{"type":"text","value":" gages, avaliable for download on ScienceBase\n(","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"WfeQ8dmBsR"},{"type":"cite","url":"https://doi.org/10.5066/P972P42Z","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Foks et al., 2022","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"mHVaj0b6lu"}],"kind":"narrative","label":"https://doi.org/10.5066/p972p42z","identifier":"https://doi.org/10.5066/P972P42Z","enumerator":"1","key":"ERTGdF8XiE"},{"type":"text","value":").","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"uqKjavOJJY"}],"key":"Z4TCMKHtjp"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"This is essentially a list of\nstream guages in which we are interested, along with some  metadata about that gage (watershed,\nreach code, etc).  We will use this as a spatial selector to restrict the original data to only\nthose gages found within this benchmarking domain.","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"XOsNvwhamI"}],"key":"aupXKRITfo"}],"key":"v66JBKQlO0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cobalt = pd.read_csv(\n    'https://www.sciencebase.gov/catalog/file/get/6181ac65d34e9f2789e44897?f=__disk__22%2F1a%2Fd2%2F221ad2fe9d95de17731ad35d0fc6b417a4b53ee1',\n    dtype={'site_no':str, 'huc_cd':str, 'reachcode':str, 'comid':str, 'gagesII_class':str, 'aggecoregion': str}, \n    index_col='site_no'\n    )\n# Re-format the gage_id/site_no string value.  ex:   \"1000000\"  ==> \"USGS-1000000\"\ncobalt.rename(index=lambda x: f'USGS-{x}', inplace=True)\nprint(f\"{len(cobalt.index)} gages in this benchmark\")\ncobalt.head(2)","key":"MZz19ipOgO"},{"type":"outputs","id":"6DCe-baJukQtc7NxoLmnb","children":[],"key":"m1phwB3b2r"}],"key":"hhCWapZliW"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So now we have a domain dataset representing the stream gages (unique ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nHeBnx7Cmp"},{"type":"inlineCode","value":"site_no","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"atYGZqhxUK"},{"type":"text","value":" values) identifying the locations making up the spatial domain of this benchmark. While we have good meta-data for these gages (lat/lon location, HUC8 code, etc), we really will only use the list of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ceIETkgWa2"},{"type":"inlineCode","value":"site_no","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"P3udW5DO1E"},{"type":"text","value":" values to select locations out of the raw data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VSngAmr0nJ"}],"key":"GSvXxKFRns"}],"key":"z4MFhjXLsB"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 3: Define Metrics","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Agf7Aiy87m"}],"identifier":"step-3-define-metrics","label":"Step 3: Define Metrics","html_id":"step-3-define-metrics","implicit":true,"key":"kILMRrHdWx"},{"type":"image","url":"/hytest//build/Eval_Analysis_Metric-e5933fbff00ad2926174e5c8bfcfb517.svg","width":360,"key":"wbvjaqcp5x","urlSource":"../../../doc/assets/Eval_Analysis_Metrics.svg"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Essential Benchmark Components:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GwV7TnfJau"}],"key":"pOkGNNzWvx"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of predictions and matching observations,","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"sXQZBlxKkC"}],"key":"Rpqyq2FoAj"}],"key":"cN0SaiGVOg"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The domain over which to benchmark","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"g9fy921wmj"}],"key":"OzMr4kYMub"}],"key":"v5uEEkM625"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"span","style":{"color":"green","fontSize":"large"},"children":[{"type":"text","value":"A set of statistical metrics with which to benchmark.","key":"LezRDUcJPO"}],"key":"A2CrNQzcnz"}],"key":"VFCtzhB0Nx"}],"key":"fwRJc87N9v"}],"key":"xmIzz6nDaE"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"The code to calculate the various NWM metrics has been standardized in\n","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"aJ5RL3vxCg"},{"type":"link","url":"/evaluation/metrics-stdsuite-v1","urlSource":"/evaluation/Metrics_StdSuite_v1","dataUrl":"/evaluation.metrics-stdsuite-v1.json","internal":true,"children":[{"type":"text","value":"Standard Suite (v1) Metrics","key":"BdK5ZlWbAR"}],"protocol":"file","key":"XaXh7NHJUc"},{"type":"text","value":"\nwith usage examples in\n","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"lH3m5eCd4n"},{"type":"link","url":"/evaluation/tutorials/stats-demos/usage-stdsuite-v1","urlSource":"/evaluation/tutorials/stats_demos/Usage_StdSuite_v1","dataUrl":"/evaluation.tutorials.stats-demos.usage-stdsuite-v1.json","internal":true,"children":[{"type":"text","value":"Standard Suite (v1) Metrics -- Usage Examples","key":"RSuyjHMjqa"}],"protocol":"file","key":"wSiEQAxST3"},{"type":"text","value":".\nYou can use these metrics or write your own.  To import and use these standardized definitions, run this cell:","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"bxMOTvjSGk"}],"key":"suvLZO0y9B"}],"key":"G7T4G7rnEk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%run ../../Metrics_StdSuite_v1.ipynb","key":"pEuJbyWQrR"},{"type":"outputs","id":"HwUCg24fe9uZ2UUPcMQg5","children":[],"key":"GIJLMRQar8"}],"key":"I7M2M0Req6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Whether you use these functions or your own, we need to put all metric computation into a special all-encompasing\nbenchmarking function--a single call which can be assigned to each gage in our domain list. This sort of arrangement\nis well-suited to parallelism with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uBuJIPxW8i"},{"type":"inlineCode","value":"dask","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OuJrJUF5Ou"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ojz0Ni1l7r"}],"key":"uwV3xcZTTc"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"If this is done well, the process will benefit enormously from task parallelism -- each gage can be given its own\nCPU to run on.  After all are done, the various results will be collected and assembled into a composite dataset.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"xVlWcd1rQS"}],"key":"xc0l61bjdU"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"To achieve this, we need a single ‘atomic’ function that can execute independently. It will take the gage identifier\nas input and return a list of metrics.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"U8IfVayfNV"}],"key":"bdeZ4g584E"}],"key":"iaYkdLyNLK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"## Wrapper function -- this func will be called once per gage_id, each call on its own dask worker\ndef compute_benchmark(gage_id):\n    try:\n        ## obs_data and mod_data should be globals...\n        obs = obs_data.sel(gage_id=gage_id).load(scheduler='single-threaded').to_series()\n        mod = mod_data.sel(gage_id=gage_id).load(scheduler='single-threaded').to_series().resample('1D', offset='5h').mean() \n        \n        # make sure the indices match\n        obs.index = obs.index.to_period('D')\n        mod.index = mod.index.to_period('D')\n\n        # merge obs and predictions; drop NaNs.\n        gage_df = pd.merge(obs, mod, left_index=True, right_index=True).dropna(how='any')\n        \n        scores = pd.Series(\n            data={\n                'NSE': NSE(gage_df.observed, gage_df.predicted),\n                'KGE': KGE(gage_df.observed, gage_df.predicted),\n                'logNSE': logNSE(gage_df.observed, gage_df.predicted),\n                'pbias': pbias(gage_df.observed, gage_df.predicted),\n                'rSD': rSD(gage_df.observed, gage_df.predicted),\n                'pearson': pearson_r(gage_df.observed, gage_df.predicted),\n                'spearman': spearman_r(gage_df.observed, gage_df.predicted), \n                'pBiasFMS': pBiasFMS(gage_df.observed, gage_df.predicted),\n                'pBiasFLV': pBiasFLV(gage_df.observed, gage_df.predicted),\n                'pBiasFHV': pBiasFHV(gage_df.observed, gage_df.predicted)\n            },\n            name=gage_id,\n            dtype='float64'\n        )\n        return scores\n    except Exception as e:#<-- this is an extremely broad way to catch exceptions.  We only do it this way to ensure \n                          #    that a failure on one benchmark (for a single stream gage) will not halt the entire run. \n        logging.info(\"Benchmark failed for %s\", gage_id)\n        return None","key":"rIwqzCNZ7t"},{"type":"outputs","id":"DTQZwS8DoRhKkciodSrQW","children":[],"key":"ZVn2jQuo8s"}],"key":"G6mmhLKNfX"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s test to be sure this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tR29hXPLHn"},{"type":"inlineCode","value":"compute_benchmark()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yJRT99JIBG"},{"type":"text","value":" function will return data for a single gage","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hMAwvWTquH"}],"key":"wXsLXFXJOp"}],"key":"UsPfUb2rCF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"compute_benchmark('USGS-01030350')","key":"JnmBn95gaT"},{"type":"outputs","id":"t3kcnVnXJwR3wtrF8nEas","children":[],"key":"pEFl7uAHgh"}],"key":"C5R3G3o2db"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Execute the Analysis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ReOLNZJXxI"}],"identifier":"execute-the-analysis","label":"Execute the Analysis","html_id":"execute-the-analysis","implicit":true,"key":"r6h3tKKoxX"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"We will be doing a lot of work in parallel, using workers within a ‘cluster’.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"SeHIw0SwwC"},{"type":"break","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"bIyJ6p9xDg"},{"type":"text","value":"The details of cluster configuration are handled for us by ‘helper’ notebooks, below.\nYou can override their function by doing your own cluster configuration if you like.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"GSl2ZHuS5H"}],"key":"kVAAbKspcs"}],"key":"J5x4JUkrO6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# uncomment the lines below to read in your AWS credentials if you want to access data from a requester-pays bucket (-cloud)\n# os.environ['AWS_PROFILE'] = 'default'\n# %run ../../../environment_set_up/Help_AWS_Credentials.ipynb","key":"Gf7XQwMnwq"},{"type":"outputs","id":"idz0XF0nXeXIGl2SGrhax","children":[],"key":"eldWCPiTjp"}],"key":"udAnt3BPmz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%run ../../../environment_set_up/Start_Dask_Cluster_Nebari.ipynb\n### Executes external 'helper to spin up a cluster of workers. ","key":"XoR51erTcW"},{"type":"outputs","id":"KkObTdgC-BkBFpB2Lrzge","children":[],"key":"GqV0DNk3cY"}],"key":"m7kOu3bZyo"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"We verified above that the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IDOGENGTKh"},{"type":"inlineCode","value":"compute_benchmark","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GmC1636dfW"},{"type":"text","value":" works on the “hosted” server (where this\nnotebook is being executed. As a sanity check before we give the cluster of workers a lot\nto do, let’s verify that we can have a remote worker process a gage by submitting work\nto one in isolation:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MXUgB1axz3"}],"key":"QgnspF9tuS"}],"key":"FamzygIpKR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.submit(compute_benchmark, 'USGS-01030350').result()","key":"lqjGhsGe8j"},{"type":"outputs","id":"34Zmf4qOnpz_VRBGEcCxp","children":[],"key":"rjTkSp7XBS"}],"key":"ODKMp4x4HY"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we’ve got a benchmark function, and can prove that it works in remote workers\nwithin the cluster, we can dispatch a fleet of workers to process our data in parallel.\nWe will make use of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kx5TG8TFFF"},{"type":"inlineCode","value":"dask","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"t4zagbUuZT"},{"type":"text","value":" to do this using a dask ‘","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CDcmrTtvOe"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"bag","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tiPTJhU1gR"}],"key":"z3KaZu5TQd"},{"type":"text","value":"’.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CVvYigSSiO"}],"key":"AowtvFyqdP"},{"type":"aside","children":[{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Read more about task parallelism with Dask and how we are using dask bags ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fIeZWIFV6k"},{"type":"link","url":"/essential-reading/parallel-dask","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Xgfzm7Rk25"}],"urlSource":"../../../essential_reading/Parallel_Dask.ipynb","dataUrl":"/essential-reading.parallel-dask.json","internal":true,"protocol":"file","key":"nMWO1Q84tt"}],"key":"B2ProZCsBD"}],"key":"RerQkBRjeZ"}],"key":"fyVrvicdds"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Set up a dask bag with the contents beging a list of the cobalt gages\nimport dask.bag as db\nbag = db.from_sequence( cobalt.index.tolist() ).map(compute_benchmark)\n\nresults = bag.compute() #<< Dispatch the workers","key":"uXw13Z3yvx"},{"type":"outputs","id":"xeu8BT9wUNw_kVLtoZHbJ","children":[],"key":"ZPn2NwLYWI"}],"key":"ZFkLe8q3LS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"With that big task done, we don’t need ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NRjTdUlfDv"},{"type":"inlineCode","value":"dask","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MA0lKoq3G1"},{"type":"text","value":" parallelism any more. Let’s shut down the cluster:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sY8lGRfDFm"}],"key":"zff3Vxsp8R"}],"key":"xn7i8z3jht"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close(); del client\ncluster.close(); del cluster","key":"g6rGh530Ak"},{"type":"outputs","id":"ilq6iTS6lEIjrosbHVwnY","children":[],"key":"cbqYfFBZJc"}],"key":"p4QXMtV1M5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Assemble the results","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GbNP6boMim"}],"identifier":"assemble-the-results","label":"Assemble the results","html_id":"assemble-the-results","implicit":true,"key":"BnxMcNDMkR"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"qmVDWeyT33"},{"type":"inlineCode","value":"bag","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"MMROHbn7Is"},{"type":"text","value":" now contains a collection of return values (one per call to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"hq7fDJuEov"},{"type":"inlineCode","value":"compute_benchmark()","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"bKNH1nWBZs"},{"type":"text","value":").  We can massage that into a table/dataframe for easier processing:","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"XyvZbRuQyM"}],"key":"W5csl8Ou5y"}],"key":"INAxZL2h5f"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"r = [i for i in results if i is not None] # Drop entries where compute_benchmark failed\nresults_df = pd.concat(r, axis=1).T\nresults_df.index.name = 'site_no'\nresults_df","key":"TYcF51uwGM"},{"type":"outputs","id":"Sbl-G8C9BQJ6aQnng3MPD","children":[],"key":"SrXwyX96ah"}],"key":"aJwaCcLBj7"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This dataframe/table can be saved to disk as a CSV. It will be used for visualizations in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aNu2fkfrpp"},{"type":"link","url":"/evaluation/tutorials/streamflow/vizualization","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"other notebooks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"irdMn4DnZZ"}],"urlSource":"03_Vizualization.ipynb","dataUrl":"/evaluation.tutorials.streamflow.vizualization.json","internal":true,"protocol":"file","key":"RaCJ8IAIuj"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NMC6pNwtHk"}],"key":"RTjeIDGGME"}],"key":"mQzZqheleQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"results_df.to_csv('NWM_v2.1_streamflow_example.csv') ##<--- change this to a personalized filename","key":"hEn1h7K2YZ"},{"type":"outputs","id":"MyzPaZyQGs44prQoWKJ8A","children":[],"key":"PgQfHrFu4j"}],"key":"QkiDaHtMyE"}],"key":"ZjyfnPKIzj"},"references":{"cite":{"order":["https://doi.org/10.5066/p972p42z"],"data":{"https://doi.org/10.5066/p972p42z":{"label":"https://doi.org/10.5066/p972p42z","enumerator":"1","doi":"10.5066/P972P42Z","html":"Foks, S. S., Towler, E., Hodson, T. O., Bock, A. R., Dickinson, J. E., Dugger, A. L., Dunne, K. A., Essaid, H. I., Miles, K. J., Over, T. M., Penn, C. A., Russell, A. M., Saxe, S. W., & Simeone, C. E. (2022). <i>Streamflow benchmark locations for hydrologic model evaluation within the conterminous United States (cobalt gages)</i>. U.S. Geological Survey. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.5066/P972P42Z\">10.5066/P972P42Z</a>","url":"https://doi.org/10.5066/P972P42Z"}}}},"footer":{"navigation":{"prev":{"title":"Streamflow Eval :: Data Preparation","url":"/evaluation/tutorials/streamflow/data-prep","group":"Model Evaluation"},"next":{"title":"Steamflow Eval :: DScore Analysis","url":"/evaluation/tutorials/streamflow/analysis-dscore","group":"Model Evaluation"}}},"domain":"http://localhost:3005"}